\documentclass[12pt]{article}
\usepackage{tgtermes}
%\usepackage[english]{babel}
%\usepackage[utf8]{inputenc}
\linespread{1.3}
\usepackage[a4paper,top=3cm,bottom=2.54cm,left=2.cm,right=2.54cm,marginparwidth=1.75cm]{geometry}
\usepackage{amsmath}
\usepackage{graphicx}
\usepackage[colorinlistoftodos]{todonotes}
\usepackage[normalem]{ulem}
\usepackage{hyperref}
\hypersetup{
	colorlinks=true,
	linkcolor=blue,
	filecolor=cyan,      
	urlcolor=blue,
}
%\usepackage[backend=bibtex]{biblatex}
%\addbibresource{kSZworkbib.bib}

\usepackage{url}
%opening
\title{Cross correlation kSZ and 21 cm signal}
\author{Zahra Kader}
\begin{document}
\maketitle
\begin{abstract}
\end{abstract}

\section{Introduction}

\section{Cosmology background}

\section{Definitions and notations}

In this paper we implement a 'snapshot' geometry which ignores the universe's expansion and instead considers the universe at an instantaneous time, $t_*$. Let us consider a single cube, centered at redshift, $z_*$, that is situated a comoving distance, $\chi_*$, away from us. We consider narrow redshift bins of $\Delta z \ll z_*$. The sides of the box correspond to the difference between the comoving distances set by the redshift bin, i.e. $L=\chi_{max} -\chi_{min}$, where $\chi_{max}=\chi(z_*+\Delta z)$ and $\chi_{min}=\chi(z_*-\Delta z)$. This setup is shown in Figure \ref{fig:diagram1stsep2019}, with $r$ representing the radial (line of sight) axis. The universe is approximated as a discrete set of these identical cubes, such that the total signal over a large redshift is computed by simply summing over the signals from each box. The redshift range which will be considered for HIRAX is $0.8-2.5$. We compute the cross-correlation of the kSZ and 21 cm fields by restricting the resulting signal to the limits set by the cube.\\
The kSZ signal is obtained by integrating over the line of sight, resulting in a 2D projected momentum field. The 2D sky, in our cube approximation, is considered to be a sum of the xy faces of the discrete set of identical cube described earlier. The angular separation between the edges of the square are defined as the length of the side, $L$, divided by the comoving distance, $\chi_*$. Thus, the transverse comoving distance is written as $\chi_{\perp}=\vec{\theta} \chi_*$ with the 2D angular vector, $\vec{\theta}=(\theta_1,\theta_2)$. Defined as well is the 3D line of sight unit vector, $\hat{\theta}=(\theta_1,\theta_2,1)$. \\
The kSZ momentum field is composed of the electron density and velocity fields. It is defined in $\theta$ space as 

\begin{equation}
p_{kSZ}(\vec{\theta})=-\frac{1}{c}\int_{\chi_{min}}^{\chi_{max}} d\chi g(\chi)\hat{\theta}.\vec{q}_e(\chi_* \vec{\theta},\chi)
\end{equation}

%WE DONT WRITE \VEC{P}_{KSZ} I THINK BECAUSE KSZ MOMENTUM IS ISOTROPIC SO NO DIRECTION SPECIFICATION REQUIRED, SO ITS A SCALAR

with $\vec{q}_e(\vec{x})=\vec{v}_e(\vec{x}) \delta_e (\vec{x})$. 

Using Fourier transforms, we can express $\vec{k}$ as

\begin{equation}
f(\vec{x})=\int \frac{d^3 \vec{k}}{(2 \pi)^3} e^{i\vec{k}.\vec{x}}f(\vec{k})
\end{equation}


The velocity in $k$ space is defined according to the continuity equation

\begin{equation}
\vec{v}(\vec{k})=\frac{ifaH\delta(\vec{k},z)}{k^2}\vec{k}\\
\end{equation}

We decompose $\vec{k}$ into components $k_{\parallel}$ and $\vec{k}_{\perp}$, which are parallel and perpendicular to the line of sight, respectively. In the flat sky approximation, we can assume $k_{\perp}=\frac{\vec{l}}{\chi_*}$, where $l$ is the fourier conjugate of $\theta$. The $k_\parallel$ modes to which we are sensitive in the box are set by the redshift range of a single cube.\\

We consider now the 21 cm momentum field for which we have a similar expression.
 
 \begin{equation}
 p_{21}(\vec{\theta})=-\frac{1}{c}\hat{\theta}.\vec{q}_{21}(\chi_* \vec{\theta},\chi)
 \end{equation}

with $\vec{q}_{21}(\vec{x})=\vec{v}_{21}(\vec{x}) \delta_{21} (\vec{x})$. Taking the Fourier transform gives

 \begin{equation}
p_{21}(\vec{l},z)=\frac{-1}{c}\int \frac{dk_{\parallel}}{2\pi}\frac{e^{ik_{\parallel} \chi(z)}}{\chi(z)^2} \hat{\theta}.\vec{q}_{21}(k_\perp,k_\parallel,z)
\end{equation}\\

with $\vec{q}_{21}(k_\perp,k_\parallel,z)=\int \frac{d^3k'}{(2\pi)^3}\delta_{21}(\vec{k}-\vec{k}',z)\vec{v}_{21}(\vec{k}',z)$. A vector diagram of the momentum, density and velocity fields is shown in Figure \ref{fig:kvecdiagramnonlimber3d}.
We compute a window function for the 21 cm signal over which the signal is integrated. The redshift limits for the window function are set by the width of the cube. This eiminates any signal contribution from outside the limits of the cube. When computing the bispectrum, we take the small sky approximation. This is valid as there is very low contribution to the signal at low $l$ and the bispectrum signal peaks at large $l \approx 2000$. Thus, we consider only the 21 cm and kSZ fields in the same line of sight, i.e. the fields have an angular separation in the transverse direction, with equal line of sight contributions. 

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.6\linewidth]{../Pictures/diagram_1stSep2019}
	\caption{Illustration of the cube centred at redshift $z_*$, of width $\delta_z$, in which the kSZ and 21 cm momentum signals are contained. The box has a length $L$ which is determined by the difference between the maximum and minimum comoving distances, $\chi$. Also shown are the 2D projected momenta fields. The line of sight direction is taken to be $r$.}
	\label{fig:diagram1stsep2019}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.6\linewidth]{../Pictures/kvec_diagram_nonlimber_3d}
	\caption{A 3D representation of the $\vec{k}$, $\vec{k}'$ and $\vec{k}-\vec{k}'$ vectors for the momentum, velocity and density fields, respectively. Each field has equal contributions in the $k_\parallel$ direction. The vector $\vec{k}$ is an angle $\gamma$ elevated above the $k_\perp$ plane, with an angle, $\phi$ between the $\vec{k}$ and $\vec{k}'$ vectors.}
	\label{fig:kvecdiagramnonlimber3d}
\end{figure}

\newpage

\section{Measuring the HI signal}
Structures such as galaxies contain large amounts of neutral hydrogen, the gas which is commonly known as star forming gas. Because of this, measuring 21 cm signals gives an indication of the LSS in the universe. We say that neutral hydrogen is a biased tracer of matter densities. The HI signal is measured using radio telescopes and due to redshift space distortions, the signal measured on Earth has been redshifted. Therefore, we have
\begin{equation}\label{delta HI to delta m}
\delta_{HI}(\vec{k})=\delta_m(\vec{k})[b_{HI}+f\mu_k^2]
\end{equation}
where $b_{HI}$ is the HI bias and $\delta_{HI}$ is the density contrast of the HI signal intensity. Now, the signal intensity measured from radio telescopes is related to temperature via Rayleigh-Jean's apprximation, $I_\nu=2k_BT\frac{\nu^2}{c^2}$, for long wavelengths such as 21 cm. Since this approximation shows that the signal intensity is proportional to temperature, we have 
\begin{equation}\label{delta 21 ito k}
\begin{aligned}
\delta T_{21}(\vec{k};z_i)&=\overline{T}(z_i)\delta_{HI}(\vec{k};z_i)
\\&=\overline{T}(z_i)\delta_m(\vec{k};z_i)[b_{HI}+f\mu_k^2]
\\&=\overline{T}(z_i)D(z_i)\delta_m(\vec{k};z=0)[b_{HI}+f\mu_k^2]
\end{aligned}
\end{equation}
where the third equality comes from removing redshift dependance from $\delta_m$ and the mean temperature given by 
\begin{equation}\label{mean 21 cm temp}
\bar{T} \approx 566h \left(\frac{H_0}{H(z)}\right)\left(\frac{\Omega_{HI}}{0.003}\right)(1+z)^2 \mu K
\end{equation}
Expressing this in observational-space Fourier variables gives %\cite{bibid}
\begin{equation}\label{delta 21 ito y and l final eqn}
\delta T_{21}(\vec{l},y;z_i)=\frac{\delta T_{21}(\vec{k}_\bot,k_\parallel;z_i)}{(\chi )^2r_{\nu(z_i)}}
\end{equation}
where the expression for $y$ is given as
\begin{equation}\label{y eqn}
y=k_\parallel r_\nu
\end{equation}
with $r_\nu=\frac{c(1+z_i)^2}{H(z_i)}$. Using the relation $1+z=\frac{1420 MHz}{\nu}$ for observing frequency, $\nu$, we see that $y$ is the inverse of $\nu$. Note that in the equation, $z_i$ is used to denote a particular redshift bin. 

\subsection{21 cm density field}
The angular power spectrum for 21 cm temperature fluctuations is given by 
\begin{equation}\label{Cl 21 relation to autocorrelation}
\begin{aligned}
&\langle  \delta T_{21}(\vec{l},y;z_i) \delta T_{21}^*(\vec{l'},y';z_i)\rangle  =(2 \pi)^3\delta^2(\vec{l}-\vec{l'})\delta(y-y')C_l^{21}(y;z_i)
\\&
\Rightarrow C_l^{21}(y;z_i)=\int \frac{d^2\vec{l'}}{(2\pi)^2} \int \frac{dy'}{2\pi}\langle  \delta T_{21}(\vec{l},y;z_i) \delta T_{21}^*(\vec{l'},y';z_i)\rangle  
\end{aligned}
\end{equation}
Substituting equation \ref{delta 21 ito y and l final eqn} into equation \ref{Cl 21 relation to autocorrelation} gives
\begin{equation}
\Rightarrow C_l^{21}(y;z_i)=\int \frac{d^2\vec{l'}}{(2\pi)^2}\int \frac{dy'}{2\pi}\frac{(\overline{T}(z_i)D(z_i)[b_{HI}+f\mu_k^2])^2}{(\chi )^2 (\chi' )^2 r_{\nu}(z_i) r'_{\nu}(z_i)}\langle  \delta_m(\vec{k};z=0)\delta_m^*(\vec{k};z=0)\rangle  
\end{equation}
Expressing $\langle  \delta_m(\vec{k};z=0)\delta_m^*(\vec{k};z=0)\rangle  $ in terms of the matter power spectrum, we have
\begin{equation}
C_l^{21}(y;z_i)=\int \frac{d^2\vec{l'}}{(2\pi)^2}\int \frac{dy'}{2\pi}\frac{(\overline{T}(z_i)D(z_i)[b_{HI}+f\mu_k^2])^2}{(\chi )^2 (\chi' )^2 r_{\nu}(z_i) r'_{\nu}(z_i)}(2\pi)^3
\delta^2(\vec{k_{\bot}}-\vec{k'_\bot})\delta(k_{\parallel}-k'_\parallel)P_m(\vec{k})
\end{equation}
Substituting equations and applying the Dirac delta functions gives
\begin{equation}
C_l^{21}(y;z_i)=\frac{(\overline{T}(z_i)D(z_i)[b_{HI}+f\mu_k^2])^2}{(\chi )^2 r_{\nu}(z_i)}P_m(\vec{k})
\end{equation}

This is plotted in Figure \ref{fig:ellsqcl21cmdensitydiffy}. 

Integrating over all $y$ modes gives

\begin{equation}
C_l^{21}(y;z_i)=\int_{10^{-10}}^{10^{3}} \frac{dy}{2\pi}\frac{(\overline{T}(z_i)D(z_i)[b_{HI}+f\mu_k^2])^2}{(\chi )^2 r_{\nu}(z_i)}P_m(\vec{k})
\end{equation}

The order of magnitude is given as

\begin{equation}
C_l^{21}(z_i)=0.05 \mu K^2 \int_{10^{-10}}^{10^{3}} \frac{dy}{10^{3}} \frac{\overline{T}(z_i)^2 }{200^2 \mu K^2 }\frac{D(z_i)^2}{0.5^2}\frac{[b_{HI}+f\mu_k^2])^2}{(1+0.5\times 0.5^2)^2}\frac{5000^2 Mpc^{2}}{\chi ^2 }\frac{10^4 Mpc}{r_{\nu}(z_i)}\frac{P_m(\vec{k}) }{10^3 Mpc^{3}}
\end{equation}
where we approximate $k=\sqrt{0.1^2+10^6/5000^2}$.

The plot showing the 21 cm density signal integrated over y modes is shown in figure \ref{fig:cl21cmdensityintegratedy13000z1}. A quick amplitude check is to confirm that the amplitude of the integrated signal, $10^5$ is equal to that of the individual y modes, $\sim 10^{1}$, multiplied by the y range $10^3$.


\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/ell_sq_Cl_21cm_density_diff_y}
	\caption{Angular power spectrum for the 21 cm neutral hydrogen signal for different y modes at $z_i=1$.}
	\label{fig:ellsqcl21cmdensitydiffy}
\end{figure}


\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/Cl_21cm_density_integrated_y_1_3000_z_1}
	\caption{Angular power spectrum of the 21 cm signal after integrating over y from $y=1$ to $y=3000$ at $z=1$.}
	\label{fig:cl21cmdensityintegratedy13000z1}
\end{figure}




\newpage
\subsection{Doppler HI signal}

We consider the 21 cm momentum field,
\begin{equation}
p_{21}(\vec{\theta},\chi)=\frac{-1}{c}\hat{\theta}.q_{21}(\vec{x}(\vec{\theta},\chi))
\end{equation}

%\begin{equation}
%p_{21}(\vec{l},y;\chi_i)=\frac{q_\perp^{21}(\vec{k}_\perp \chi,k_\parallel r_\nu)}{\chi^2 r_\nu}
%\end{equation}
where $\vec{q}_{21}(\vec{x})=(1+\delta_{21}(\vec{x}))\vec{v}_{21}(\vec{x})$, the product of the 21 cm velocity and density fields. 
\noindent We can use Fourier conventions to find $q(\vec{k})$
\begin{equation}\label{q_21 of k}
q(\chi\vec{\theta},\chi)=\int \frac{d^3 \vec{k}}{(2 \pi)^3} e^{i\vec{k}.\vec{x}}q(\vec{k},\chi )=\int \frac{d^2 \vec{k_\bot}}{(2\pi)^2} e^{i\vec{k_\bot}.\chi_\bot} \int \frac{dk_\parallel}{2\pi} e^{ik_{\parallel}\chi } q(\vec{k_\bot},k_\parallel,\chi )
\end{equation}
\noindent where the second equality was obtained by separating $\vec{k}$ into its components, $k_\parallel$ and $\vec{k_\bot}$. In equation \ref{q_21 of k}, $\theta$ is replaced with the vector 
\begin{subequations}
	\begin{equation}\label{chi perp equals theta times chi parallel}
	\vec{\chi_{\bot}}=\vec{\theta}\chi 
	\end{equation}
	\text{Since $\vec{l}$ is the fourier conjugate of $\vec{\theta}$ and $\vec{k_{\bot}}$ is the fourier conjugate of $\vec{\chi_{\bot}}$, the expression for $\vec{\chi_{\bot}}$ becomes}
	\begin{equation}\label{k perp equals l divided by chi parallel}
	\vec{k_{\bot}}=\frac{\vec{l}}{\chi }
	\end{equation}
\end{subequations}
By combining equations \ref{chi perp equals theta times chi parallel} and \ref{k perp equals l divided by chi parallel}, equation \ref{q_21 of k} can be expressed as 
\begin{equation}\label{IFT of delta m ito l}
\vec{q}(\chi\vec{\theta},\chi )=\int \frac{d^2 \vec{l}}{(2\pi)^2} e^{i\vec{l}.\vec{\theta}} \int \frac{dk_\parallel}{2\pi} e^{ik_{\parallel}\chi }\frac{\vec{q}(\vec{k_\bot},k_\parallel,\chi )}{\chi ^2}
\end{equation}
Substituting equation \ref{IFT of delta m ito l} we have
\begin{equation}\label{kappa of theta with l}
p(\vec{\theta},\chi)=-\frac{1}{c}\int \frac{d^2 \vec{l}}{(2\pi)^2} \frac{e^{i \vec{l}.\vec{\theta}}}{\chi ^2} \int \frac{dk_\parallel}{2\pi} e^{ik_{\parallel}\chi }\hat{\theta}.\vec{q}(\vec{k_\bot},k_\parallel,\chi )
\end{equation}
\noindent Now, using the fact that $\vec{l}$ is the fourier conjugate of $\vec{\theta}$, $p(\vec{\theta})$ can be written as 
\begin{equation}\label{FT of kappa of theta}
p(\vec{\theta})=\int \frac{d^2 \vec{l}}{(2\pi)^2} e^{i\vec{l}.\vec{\theta}}p(\vec{l})
\end{equation}   
By comparing equations \ref{kappa of theta with l} and \ref{FT of kappa of theta}, the equation for $p(\vec{l})$ is given by
\begin{equation}\label{final p(l) equation}
p(\vec{l})=-\frac{1}{c} \int \frac{dk_\parallel}{2\pi} \frac{e^{ik_{\parallel}\chi }}{\chi^2} \hat{\theta}.\vec{q}(\vec{k_\bot},k_\parallel,\chi )
\end{equation}


For $\delta \ll 1$, we have


\begin{equation}
p_{21}^{Doppler}(\vec{l},z_1)=\frac{-1}{c}\int \frac{dk_{\parallel}}{2\pi}\frac{e^{ik_{\parallel} \chi(z_1)}}{\chi(z_1)^2} \hat{\theta}.\vec{v}_{21}(\vec{k},z_1)
\end{equation}

 In linear theory, the expression relating velocity to density is given as
 \begin{equation}\label{v(k)}
 \begin{aligned}
 \vec{v}(\vec{k})=&\frac{ifH(z)\delta(\vec{k},z)}{(1+z)k^2}\vec{k}\\
 =&\frac{ifH(z)D(z)\delta(\vec{k})}{(1+z)k^2}\vec{k}
 \end{aligned}
 \end{equation}
 where the linear growth factor is given as $f\equiv\frac{a}{D}\frac{dD}{da}$ and can be approximated by the relation 
 \begin{equation}
 f(z)=\Omega_m(z)^\gamma
 \end{equation}
 with $\gamma=0.53$.\\ 
For the second 21 cm Doppler signal we have

\begin{equation}
p_{21}^{Doppler}(\vec{l}',z_2)=\frac{-1}{c}\int \frac{dk'_{\parallel}}{2\pi}\frac{e^{ik'_{\parallel} \chi(z_2)}}{\chi(z_2)^2} \hat{\theta}'.\vec{v}_{21}(\vec{k}',z_2)
\end{equation}

The autocorrelation is then 

\begin{equation}
\begin{aligned}
C_l^{Doppler}(z_1,z_2)=&\frac{1}{c^2}\int \frac{d^2l'}{(2\pi)^2}\left< p_{21}^{Doppler}(\vec{l},z_1) p_{21}^{Doppler}(\vec{l}',z_2) \right>\\
=&\frac{1}{c^2}\int \frac{d^2k'_{\perp}}{(2\pi)^2} \int \frac{dk_{\parallel}}{2\pi}\frac{e^{ik_{\parallel} \chi(z_1)}}{\chi(z_1)^2} \frac{D(z_1)f(z_1)H(z_1)}{(1+z_1)} \frac{\mu_k}{k}\\
& \int \frac{dk'_{\parallel}}{2\pi}e^{ik'_{\parallel} \chi(z_2)} \frac{D(z_2)f(z_2)H(z_2)}{(1+z_2)} \frac{\mu_k'}{k'}\left< \delta_{21}(\vec{k}) \delta_{21}(\vec{k}') \right>\\
=&\frac{1}{c^2}\int \frac{d^2k'_{\perp}}{(2\pi)^2} \int \frac{dk_{\parallel}}{2\pi}\frac{e^{ik_{\parallel} \chi(z_1)}}{\chi(z_1)^2} \frac{D(z_1)f(z_1)H(z_1)}{(1+z_1)} \frac{\mu_k}{k}\\
& \int \frac{dk'_{\parallel}}{2\pi}e^{ik'_{\parallel} \chi(z_2)} \frac{D(z_2)f(z_2)H(z_2)}{(1+z_2)} \frac{\mu_k'}{k'}(2\pi)^3 P_{\delta_{21} \delta_{21}}(\vec{k})(\delta^3(\vec{k}-\vec{k}'))
\end{aligned}
\end{equation}

Simplifying gives the angular power spectrum
\begin{equation}
\begin{aligned}
C_l^{Doppler}(z_1,z_2)=&\frac{\bar{T}(z_1)\bar{T}(z_2)}{c^2}\int \frac{dy}{2\pi}(b_{HI}+f\mu_k^2)^2\frac{e^{ik_\parallel(\chi(z_1)-\chi(z_2))}}{\chi(z_1)^2 r(z_1)}\\ &\frac{D(z_1)D(z_2)f(z_1)f(z_2)H(z_1)H(z_2)}{(1+z_1)(1+z_2)}\frac{\mu_k^2}{k^2}P_m(k)
\end{aligned}
\end{equation}

The order of magnitude calculation is expressed below.
\begin{equation}
\begin{aligned}
C_l^{21}(z_1=z_2)=&10^{-8} \mu K^2 \int_{10^{-6}}^{10^{3}} \frac{dy}{10^{3}} \frac{\overline{T}^2 }{200^2 \mu K^2 }\frac{(10^{-14})^2Mpc^2 s^{-2}}{c^2}\frac{D^2}{0.5^2}\frac{f^2}{0.5^2}\frac{H^2 }{H_0^2 s^{-2}}\frac{4}{(1+z)^2}\\
&\frac{[b_{HI}+f\mu_k^2])^2}{(1+0.5)^2}\frac{5000^2 Mpc^{2}}{\chi^2}\frac{10^4 Mpc}{r_{\nu}}\frac{\mu_k^2}{0.5^2}\frac{(10^{-1})^2 Mpc^{-2}}{k^2}\frac{P_m(\vec{k}) }{10^3 Mpc^{3}}
\end{aligned}
\end{equation}

The angular power spectrum as a function of y is given as
\begin{equation}
\begin{aligned}
C_l^{Doppler}(y,z_1,z_2)=&\frac{\bar{T}(z_1)\bar{T}(z_2)}{c^2}(b_{HI}+f\mu_k^2)^2\frac{e^{ik_\parallel(\chi(z_1)-\chi(z_2))}}{\chi(z_1)^2 r(z_1)}\\ &\frac{D(z_1)D(z_2)f(z_1)f(z_2)H(z_1)H(z_2)}{(1+z_1)(1+z_2)}\frac{\mu_k^2}{k^2}P_m(k)
\end{aligned}
\end{equation}



\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/Cl_21_doppler_diff_y_z_1}
	\caption{Angular power spectrum for the 21 cm neutral hydrogen velocity signal for different y modes at $z_i=1$.}
	\label{fig:cl21dopplerdiffyz1}
\end{figure}

\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/Cl_doppler_21cm_integral_over_y_1_3000_z_1}
	\caption{Angular power spectrum for the 21 cm neutral hydrogen signal velocity field after integrating over all y modes in the range $y=1$ to $y=3000$.}
	\label{fig:cldoppler21cmintegralovery13000z1}
\end{figure}




\newpage
\subsection{21 cm Momentum field}

Consider again the 21 cm momentum field,
\begin{equation}
p(\vec{\theta})=\frac{-1}{c}\hat{\theta}.q(\vec{x}(\vec{\theta},\chi))
\end{equation}

%\begin{equation}
%p_{21}(\vec{l},y;\chi_i)=\frac{q_\perp^{21}(\vec{k}_\perp \chi,k_\parallel r_\nu)}{\chi^2 r_\nu}
%\end{equation}


This can be rewritten as 

\begin{equation}
p_{21}(\vec{l},z_1)=\frac{-1}{c}\int \frac{dk_{\parallel}}{2\pi}\frac{e^{ik_{\parallel} \chi(z_1)}}{\chi(z_1)^2} \hat{\theta}.\vec{q}_{21}(k_\perp,k_\parallel,z_1)
\end{equation}
where 
\begin{equation}
\vec{q}_{21}(k_\perp,k_\parallel,z_1)=\int \frac{d^3k'}{(2\pi)^3}\delta_{21}(\vec{k}-\vec{k}',z_1)\vec{v}_{21}(\vec{k}',z_1)
\end{equation}




Also, we have once again

\begin{equation}
\delta_{21}(\vec{k},z_1)=\overline{T}(z_1)D(z_1)\delta_m(\vec{k};z=0)[b_{HI}+f\mu_k^2]
\end{equation}


The autocorrelation is computed as follows

\begin{equation}
\begin{aligned}
C_{l}(z_1,z_2)=&\frac{d^2l_2}{(2\pi)^2} \left<p_{21}(l) p_{21}(l_2)\right>\\
=&\frac{1}{4c^2}\frac{D_1^2 D_2^2}{\chi_1^2 \chi_2^2}\int\frac{d^2l_2}{(2\pi)^2}\int \frac{dk_{\parallel}}{2\pi} e^{ik_{\parallel}\chi_1} \int \frac{d^3k'}{(2\pi)^3} \int \frac{dk_{2\parallel}}{2\pi}e^{-ik_{2\parallel}\chi_2} \int \frac{d^3k''}{(2\pi)^3} \\
&\left<(\delta_{21}(\vec{k}-\vec{k}') \hat{\theta}.\vec{v}_{21}(\vec{k}')+\delta_{21}(\vec{k}') \hat{\theta}.\vec{v}_{21}(\vec{k}-\vec{k}'))(\delta_{21}^*(\vec{k}_2-\vec{k}'') \hat{\theta}.\vec{v}_{21}^*(\vec{k}'')+\delta_{21}^*(\vec{k}'') \hat{\theta}.\vec{v}_{21}^*(\vec{k}_2-\vec{k}''))\right>\\
&=\frac{1}{4c^2}\frac{D_1^2 D_2^2 f_1 f_2 H_1 H_2}{\chi_1^2 (1+z_1)(1+z_2)}\int\frac{d^2k_{2\perp}}{(2\pi)^2}\int \frac{dk_{\parallel}}{2\pi}e^{ik_{\parallel}\chi_1} \int \frac{d^3k'}{(2\pi)^3} \int \frac{dk_{2\parallel}}{2\pi}e^{-ik_{2\parallel}\chi_2} \int \frac{d^3k''}{(2\pi)^3}\\
& \left(\frac{\hat{\theta}.\vec{k}'}{k'^2}+\frac{\hat{\theta}.(\vec{k}-\vec{k}')}{|\vec{k}-\vec{k}'|^2}\right)\left(\frac{\hat{\theta}.\vec{k}''}{k''^2}+\frac{\hat{\theta}.(\vec{k}_2-\vec{k}'')}{|\vec{k}_2-\vec{k}''|^2}\right)\left<\delta_{21}(\vec{k}-\vec{k}') \delta_{21}(\vec{k}')\delta_{21}^*(\vec{k}_2-\vec{k}'') \delta_{21}^*(\vec{k}'')\right>\\
&=\frac{1}{4c^2}\frac{D_1^2 D_2^2 f_1 f_2 H_1 H_2}{\chi_1^2 (1+z_1)(1+z_2)}\int\frac{d^2k_{2\perp}}{(2\pi)^2}\int \frac{dk_{\parallel}}{2\pi}e^{ik_{\parallel}\chi_1} \int \frac{d^3k'}{(2\pi)^3} \int \frac{dk_{2\parallel}}{2\pi}e^{-ik_{2\parallel}\chi_2} \int \frac{d^3k''}{(2\pi)^3}\\
& \left(\frac{\hat{\theta}.\vec{k}'}{k'^2}+\frac{\hat{\theta}.(\vec{k}-\vec{k}')}{|\vec{k}-\vec{k}'|^2}\right)\left(\frac{\hat{\theta}.\vec{k}''}{k''^2}+\frac{\hat{\theta}.(\vec{k}_2-\vec{k}'')}{|\vec{k}_2-\vec{k}''|^2}\right)\left<\delta_{21}(\vec{k}-\vec{k}') \delta_{21}(\vec{k}')\delta_{21}^*(\vec{k}_2-\vec{k}'') \delta_{21}^*(\vec{k}'')\right>
\end{aligned}
\end{equation}

Now, using Wick's theorem we have\\
 $\left<\delta_{21}(\vec{k}-\vec{k}') \delta_{21}(\vec{k}')\delta_{21}^*(\vec{k}_2-\vec{k}'') \delta_{21}^*(\vec{k}'')\right>=(2\pi)^6  P_{\delta_{21} \delta_{21}}(k') P_{\delta_{21} \delta_{21}}(|\vec{k}-\vec{k}'|)(\delta^3(\vec{k}'-\vec{k}_2+\vec{k}'')\delta^3(\vec{k}-\vec{k}'-\vec{k}'')+\delta^3(\vec{k}'-\vec{k}'')\delta^3(\vec{k}-\vec{k}'-\vec{k}_2+\vec{k}''))$\\

Applying the delta functions, we have

\begin{equation}
\begin{aligned}
C_{l}(z_1,z_2)=&\frac{1}{4c^2}\frac{1}{(2\pi)^4}\frac{D_1^2 D_2^2 f_1 f_2 H_1 H_2}{\chi_1^2 (1+z_1)(1+z_2)}\int dk_{\parallel}e^{ik_{\parallel}(\chi_1-\chi_2)} \\
&\int {d^3k'}  \left(\frac{\hat{\theta}.\vec{k}'}{k'^2}+\frac{\hat{\theta}.(\vec{k}-\vec{k}')}{|\vec{k}-\vec{k}'|^2}\right)^2P_{\delta_{21} \delta_{21}}(k') P_{\delta_{21} \delta_{21}}(|\vec{k}-\vec{k}'|)\\
&=\frac{1}{4c^2}\frac{1}{(2\pi)^4}\frac{D_1^2 D_2^2 f_1 f_2 H_1 H_2}{\chi_1^2 (1+z_1)(1+z_2)}\int dk_{\parallel}e^{ik_{\parallel}(\chi_1-\chi_2)} \\
&\int {d^3k'} \left(\frac{[\hat{\theta}.K]^2}{K^2} +\frac{[\hat{\theta}.\hat{k}']^2}{k'^2}+\frac{2[\hat{\theta}.\hat{K}][\hat{\theta}.\hat{k}']}{K k'}\right)P_{\delta_{21} \delta_{21}}(k') P_{\delta_{21} \delta_{21}}(|\vec{k}-\vec{k}'|)\\
&=\frac{1}{4c^2}\frac{1}{(2\pi)^4}\frac{D_1^2 D_2^2 f_1 f_2 H_1 H_2}{\chi_1^2 (1+z_1)(1+z_2)}\int dk_{\parallel}e^{ik_{\parallel}(\chi_1-\chi_2)} \\
&\int {d^3k'}\left(\frac{[\hat{\theta}.\hat{k}']^2}{k'^2}+\frac{[\hat{\theta}.\hat{K}][\hat{\theta}.\hat{k}']}{K k'}+[k'\leftrightarrow K]\right)P_{\delta_{21} \delta_{21}}(k') P_{\delta_{21} \delta_{21}}(|\vec{k}-\vec{k}'|)\\
&=\frac{1}{2c^2}\frac{1}{(2\pi)^4}\frac{D_1^2 D_2^2 f_1 f_2 H_1 H_2}{\chi_1^2 (1+z_1)(1+z_2)}\int dk_{\parallel}e^{ik_{\parallel}(\chi_1-\chi_2)} \\
&\int {d^3k'}\left(\frac{[\hat{\theta}.\hat{k}']^2}{k'^2}+\frac{[\hat{\theta}.\hat{K}][\hat{\theta}.\hat{k}']}{K k'}\right)P_{\delta_{21} \delta_{21}}(k') P_{\delta_{21} \delta_{21}}(|\vec{k}-\vec{k}'|)\\
\end{aligned}
\end{equation}


Now, expressing the angular power spectrum in terms of $P_{vv}$ and $P_{\delta v}$ gives
\begin{equation}\label{Cl autocorr 21cm momentum general expression}
\begin{aligned}
C_l^{p_{21}p_{21}}(z_1,z_2)=&\frac{1}{2}\frac{1}{(2\pi)^4c^2}\int dk_{\parallel}\frac{e^{ik_{\parallel} (\chi_1-\chi_2)}}{\chi_1^2}D(z_1)^2 D(z_2)^2\\ 
&\int {d^3k'} ([\hat{\theta}.\hat{k}']^2 P_{v_{21} v_{21}}(k') P_{\delta_{21} \delta_{21}}(K) + [\hat{\theta}.\hat{K}][\hat{\theta}.\hat{k}'] P_{\delta_{21} v_{21}}(k') P_{\delta_{21} v_{21}}(K))\\
=&\frac{1}{2}\frac{\bar{T}(z_1)^2\bar{T}(z_2)^2}{(2\pi)^4c^2} \int {dk_{\parallel}}\frac{e^{ik_{\parallel} (\chi_1-\chi_2)}}{\chi_1^2}[b_{HI}+f_1\mu_k^2]^2 [b_{HI}+f_2\mu_k^2]^2 D(z_1)^2 D(z_2)^2F(k)
\end{aligned}
\end{equation}

where $F(k)$ is 

\begin{equation}
F(k)=\int {d^3k'}([\hat{\theta}.\hat{k}']^2 P_{v_{m} v_{m}}(k') P_{\delta_{m} \delta_{m}}(K) + [\hat{\theta}.\hat{K}][\hat{\theta}.\hat{k}'] P_{\delta_{m} v_{m}}(k') P_{\delta_{m} v_{m}}(\sqrt{k^2+k'^2-2kk'\zeta}))
\end{equation}\\

If we use a condensed form of the $\vec{q}$ expression, 
\begin{equation}
\vec{q}_{21}(k_\perp,k_\parallel,z_1)=\int \frac{d^3k'}{(2\pi)^3}(\delta_{21}(\vec{k}-\vec{k}',z_1)\vec{v}_{21}(\vec{k}',z_1)
\end{equation}

this gives a final expression of 

\begin{equation}\label{Cl 21 squeezed lim integrated over y}
\begin{aligned}
C_l^{p_{21}p_{21}}(z_1,z_2)&=\frac{\bar{T}(z_1)^2\bar{T}(z_2)^2}{(2\pi)^4c^2} \int {dk_{\parallel}}\frac{e^{ik_{\parallel} (\chi_1-\chi_2)}}{\chi_1^2}[b_{HI}+f_1\mu_k^2]^2 [b_{HI}+f_2\mu_k^2]^2 D(z_1)^2 D(z_2)^2\\ 
&\int {d^3k'}[\hat{\theta}.\hat{k}']^2 P_{v_{m} v_{m}}(k') P_{\delta_{m} \delta_{m}}(K)
\end{aligned}
\end{equation}

This assumption is useful in the squeezed limit, in which we assume that the velocity field is a long wavelength field while the density and momentum fields are short wavelength. This is a valid assumption in the continuity equation since $v(\vec{k}) \propto \delta(\vec{k})/\vec{k}^2$ so that the velocity field is, thus, larger than the density field for smaller k modes. We choose $v=v(\vec{k}')$ so that $|\vec{k}'|$ is limited to small values of $|\vec{k}'| \le 0.1 Mpc^{-1}$. If $|\vec{k}'|$ is small and $|\vec{k}|$ is large, that gives a large $|\vec{k}-\vec{k}'|$. The large k modes have higher limits of $|\vec{k}|, |\vec{k}-\vec{k}'| \le 10 Mpc^{-1}$.



The two terms $[\hat{\theta}.\hat{k}']^2 P_{v_{m} v_{m}}(k') P_{\delta_{m} \delta_{m}}(K)$ and $[\hat{\theta}.\hat{K}][\hat{\theta}.\hat{k}'] P_{\delta_{m} v_{m}}(k') P_{\delta_{m} v_{m}}(K)$ in equation \ref{Cl autocorr 21cm momentum general expression} do not contribute equally since $[\hat{\theta}.\hat{k}'] \not = [\hat{\theta}.\hat{K}]$, hence the angular power spectrum expressed in equation \ref{Cl 21 squeezed lim integrated over y} is different from that of equation \ref{Cl autocorr 21cm momentum general expression}.\\



Let us consider a diagram showing the vectors for the momentum, density and velocity fields. 

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{"../python_scripts/kSZ_21cm_signal/k vec non limber v2"}
	\caption{Diagram showing the different vectors for the 21 cm density, velocity and momentum fields.}
	\label{fig:k-vec-non-limber-v2_1}
\end{figure}


where $\mu_k=\frac{k_\parallel}{k}$. Both the $\vec{k}$ and $\vec{k}'$ vectors can rotate in any angle in the xy plane. In the diagram, $\gamma$ is the angle of elevation of $\vec{k}$ from the xy plane. The vector $\vec{k}'$ is an angle $\phi$ from $\vec{k}$ in the z direction. 
Using this diagram we can obtain the expressions for $\hat{\theta}.\hat{k}'$ and $\hat{\theta}.\hat{K}$.



This diagram gives 


\begin{subequations}
	\begin{equation}\label{k' in los 21cm}
	\hat{\theta}.\hat{k}'=sin(\gamma+\phi)=\mu_k\zeta+\frac{l}{\chi}\frac{1}{k}\sqrt{1-\zeta^2}
	\end{equation}
	\begin{equation}\label{K in los 21cm}
	\hat{\theta}.\hat{K}=-sin(\alpha-\gamma)=-\left[\frac{k'}{k-k'}\frac{l}{\chi}\frac{1}{k}\sqrt{1-\zeta^2}-\frac{(k-k'\zeta)}{k-k'}\mu_k\right]
	\end{equation}
\end{subequations}

We can also write the $d^3\vec{k}'$ integral in spherical coordinates, with polar angle, $\Phi$ and azimuthal angle, $\Theta$. We have $\int d^3\vec{k}'=\int_0^{2\pi} \int_0^\pi \int k'^2 sin\Theta dk' d\Theta d\Phi$. We substitute $cos\Theta=U$ so that $\int d^3\vec{k}'=-2\pi\int_1^{-1} \int k'^2 dk' dU$ so that $\int d^3\vec{k}'=2\pi\int_{-1}^{1} \int k'^2 dk' dU$. We are required to write $K= \sqrt{k^2+k'^2-2kk'\zeta}$ in terms of $U$. Using $\zeta=cos\phi=cos(90-(\gamma+\Theta))=sin(\gamma+\Theta)=sin\gamma cos\Theta cos\gamma sin\Theta=\frac{k_\parallel}{k}U+\frac{k_\perp}{k}\sqrt{1-U^2}$, we have $K=\sqrt{k^2+k'^2-2kk'(\frac{k_\parallel}{k}U+\frac{k_\perp}{k}\sqrt{1-U^2})}$.

We can then rewrite $F(k)$

\begin{equation}
\begin{aligned}
F(k)=&2\pi\int_{-1}^{1} \int k'^2 ([\hat{\theta}.\hat{k}']^2 P_{v_{m} v_{m}}(k') P_{\delta_{m} \delta_{m}}(K) + [\hat{\theta}.\hat{K}][\hat{\theta}.\hat{k}'] P_{\delta_{m} v_{m}}(k') \\
&P_{\delta_{m} v_{m}}\left(\sqrt{k^2+k'^2-2kk'(\frac{k_\parallel}{k}U+\frac{k_\perp}{k}\sqrt{1-U^2})}\right) dk' dU
\end{aligned}
\end{equation}

and use equations \ref{k' in los 21cm} and \ref{K in los 21cm} with the substitution $\zeta=\frac{k_\parallel}{k}U+\frac{k_\perp}{k}\sqrt{1-U^2}$.

Writing this expression for a single redshift bin centred at $z_1=z_2=z$, gives the equation for the autocorrelation that I am coding

\begin{equation}
\begin{aligned}
C_l^{p_{21}p_{21}}(z)&=\frac{\bar{T}(z)^4}{16\pi^3c^2}  (\frac{H(z)}{\chi(z)^2r(z)(1+z)})^2 D(z)^4  f(z)^2  \int dy [b_{HI}+f\mu_k^2]^4 \\
&   \int_{-1}^{1} dU \int dk' k'^2
P_{\delta_m \delta_m}(k')P_{\delta_m \delta_m}(\sqrt{k^2+k'^2-2kk'\left(\frac{k_\parallel}{k}U+\frac{k_\perp}{k}\sqrt{1-U^2}\right)}) 
I(k,k',U,k_\parallel)
\end{aligned}
\end{equation}

where $I(k,k',U,k_\parallel)=\hat{\theta}.\hat{k}'\left[\frac{\hat{\theta}.\hat{k}'}{k'^2}+\frac{\hat{\theta}.\hat{K}}{Kk'}\right]$.


The 21 cm momentum power spectrum as a function of y is likewise expressed as

\begin{equation}
\begin{aligned}
C_l^{p_{21}p_{21}}(y,z)&=\frac{\bar{T}(z)^4}{8\pi^2c^2}  (\frac{H(z)}{\chi(z)^2r(z)(1+z)})^2 D(z)^ f(z)^2 [b_{HI}+f\mu_k^2]^4 \\
& \int_{-1}^{1} dU \int dk' k'^2
P_{\delta_m \delta_m}(k')P_{\delta_m \delta_m}(\sqrt{k^2+k'^2-2kk'\left(\frac{k_\parallel}{k}U+\frac{k_\perp}{k}\sqrt{1-U^2}\right)}) 
I(k,k',U,k_\parallel)
\end{aligned}
\end{equation}




\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{"../python_scripts/kSZ_21cm_signal/Cl 21_p21_kmax_1_z1_z2_pt95"}
	\caption{21 cm momentum signal}
	\label{fig:cl-21p21kmax1z1z2pt95}
\end{figure}



\subsection{Noise}



The HIRAX noise is given by the equation 

\begin{equation}
N_l^{HI}(z_i)=\frac{T_{sys}^2}{\nu_{21}n_{pol}t_{tot}}\frac{\lambda^4 S_{area}}{A_e^2 FOV}\frac{1}{N_b n(\vec{u})}
\end{equation}



The variance, $\sigma_l^{HI}$ is given by
\begin{equation}
\sigma_l^{HI}=\frac{C_l^{HI}+N_l^{HI}}{\sqrt{N_{modes}}}
\end{equation}


The signal-to-noise is then given as

\begin{equation}
\left(\frac{S}{N}\right)^2=2f_{sky}\Delta \tilde{\nu}S_{area}\int \frac{dl}{2\pi} \int \frac{dy}{2\pi} \frac{l(C_l^{HI}(y,z=1))^2}{(C_l^{HI}(y,z=1)+N_l^{HI}(y,z=1))^2}
\end{equation}

I have plotted the 21 cm density signal for different y modes, together with the HIRAX noise, where I have divided the noise by the number of modes on the sky. This is shown in Figure \ref{fig:hiraxnoise21cmdiffyz1}. Thereafter, I plotted the S/N for the 21 cm density signal for different $k_\parallel$ and $k_\perp$ bins of width $0.01 Mpc^{-1}$. I repeated the plots for the 21 cm velocity. The noise for the 21 cm velocity is computed as  




\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/hiraxnoise_21cm_diff_y_z_1}
	\caption{HIRAX noise plotted with the HI density angular power spectrum for different y modes at $z=1$.}
	\label{fig:hiraxnoise21cmdiffyz1}
\end{figure}

%\begin{figure}[h!]
%	\centering
%	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/hirax_21cm_snr_different_y}
%	\caption{HI Signal-to-noise plotted for different y modes at redshift, $z=1$. }
%	\label{fig:hirax21cmsnrdifferenty}
%\end{figure}


\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/SNR_21cm_density}
	\caption{S/N for the 21 cm density signal plotted for $k_\parallel$ and $k_\perp$ bins of width $0.01 Mpc^{-1}$ at $z=1$.}
	\label{fig:snr21cmdensity}
\end{figure}



%Writing this equation with units and order of magnitudes gives

%\begin{equation}
%\begin{aligned}
%C_l^{p_{21}}(z_1=z_2)=&10^{-8} \mu K^2\frac{10^2}{8\pi^3}\frac{\bar{T}^2}{200^2 mK^2}\frac{(10^{-14})^2 Mpc^2 s^{-2}}{c^2}  \frac{H^2}{H_0^2}\frac{D^4}{0.5^4} \frac{f^2}{0.5^2}\frac{5000^2 Mpc^2}{\chi^2} \frac{10^4 Mpc}{r_\nu} \\
%&  \frac{4}{ (1+z)^2}  \int_{10^{-10}}^{10^3} \frac{dy}{10^3} \frac{[b_{HI}+f\mu_k^2]^2}{(1+0.5\times 0.5^2)^2}\int_{-1}^1 \frac{d\zeta}{2} \int_{10^{-10}}^{1} \frac{dk'}{10}
%\frac{P_{\delta_m \delta_m}(k')}{10^2 Mpc^3}\\
%&\frac{P_{\delta_m \delta_m}(\sqrt{k^2+k'^2-2kk'\zeta})}{10^2 Mpc^3} \frac{\mu_k \zeta}{0.5 \times 2}+\frac{l}{10^3}\frac{5000 Mpc}{\chi}\frac{10^{-1}Mpc^{-1}}{k}\frac{\sqrt{1-\zeta^2}}{\sqrt{1-0.5^2}}
%\end{aligned}
%\end{equation}

%\begin{figure}
%	\centering
%	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/Cl_21momentum_microK_to_power_4_diff_y_z_1}
%	\caption{21 cm momentum signal plotted for different y at $z=1$.}
%	\label{fig:cl21momentummicroktopower4diffyz1}
%\end{figure}



\newpage
\section{kSZ effect}
So far we have considered the effect of CMB photons scattered off electrons in the intracluster medium. Now, an additional effect arises from the motion of the cluster relative to the CMB. This is the KSZ effect which is simply an expression of the resulting Doppler shift. In the non-relativistic limit, the CMB spectral distortion is given as
\begin{equation}\label{temp distortion due to ksz}
\frac{\delta T_{KSZ}}{T_{rad}}=\tau \frac{\nu_r}{c}cos\theta
\end{equation}
where $\theta$ is the angle between the observer and the direction of motion of the cluster, and $\nu_r$ is the radial component of the peculiar velocity of the cluster. We can write this in terms of intensity using Planck's radiation formula to obtain 
\begin{equation}
\frac{\delta I_{KSZ}}{I}=-x^4 \frac{e^x}{(e^x-1)^2}\tau \frac{\nu_r}{c}cos\theta
\end{equation}
Using equation \ref{temp distortion due to ksz} and substituting the expression for optical depth, $\tau$, we have 
\begin{equation}\label{p(theta) temp distortion ksz}
p(\vec{\theta})\equiv \frac{\delta T_{KSZ}}{T_{rad}}=\int_{0}^{\eta_0}n_e\sigma_Te^{-\tau}\left[\hat{\theta}.\frac{\vec{v}(\vec{\theta},\chi)}{c}\right]a(\chi)d\chi
\end{equation}
where $\vec{v}$ is the bulk velocity at distance $\vec{x}=\chi\vec{\theta}$ and the extra factor of $a(\chi)$ comes from the relation $dt=ad\chi$. 
The visibility function is the probability of photons scattering off ionised electrons and is given by
\begin{equation}
g(\eta)=-\dot{\tau}e^{-\tau} \Rightarrow g(\chi)= \overline{n_e}(\chi) \sigma_Ta(\chi)
\end{equation} 
where we have made the approximation that $e^{-\tau} \simeq 1$. The mean electron number density, $\overline{n}_e(z)=(1-(4-N_{He})Y/4)\Omega_{b0}\rho_{c0} x(z)(1+z)^3/m_p$ where $\Omega_{b0}$ is the baryon density today, $m_p$ is the proton mass and $x(z) \approx 1$ is the ionization fraction, which we assume for instantaneous reionization and for the ionization fraction today. 
Substituting this into equation \ref{p(theta) temp distortion ksz} gives
\begin{equation}\label{p as a function of theta}
p(\vec{\theta})=-\frac{1}{c}\int_{0}^{\eta_0} d\chi g(\chi)\hat{\theta}.\vec{q}(\vec{x}(\vec{\theta},\chi))
\end{equation}
where $\vec{q}(\vec{x})=(1+\delta_e(\vec{x}))\vec{v}_e(\vec{x})$, the product of the electron and density fields in real space. 
\noindent We can use Fourier conventions to find $q(\vec{k})$

Substituting equation \ref{IFT of delta m ito l} we have
\begin{equation}\label{p_kSZ of theta with l}
p(\vec{\theta})=-\frac{1}{c}\int d\chi \frac{g(\chi )}{\chi ^2}\int \frac{d^2 \vec{l}}{(2\pi)^2} e^{i \vec{l}.\vec{\theta}} \int \frac{dk_\parallel}{2\pi} e^{ik_{\parallel}\chi }\hat{\theta}.\vec{q}(\vec{k_\bot},k_\parallel,\chi )
\end{equation}
 
By comparing equations \ref{p_kSZ of theta with l} and \ref{FT of kappa of theta}, the equation for $p(\vec{l})$ is given by
\begin{equation}\label{final p(l) kSZ equation}
p(\vec{l})=-\frac{1}{c}\int d\chi  \widetilde{g}(\chi ) \int \frac{dk_\parallel}{2\pi} e^{ik_{\parallel}\chi } \hat{\theta}.\vec{q}(\vec{k_\bot},k_\parallel,\chi )
\end{equation}
where $\widetilde{g}(\chi)=\frac{g(\chi )}{\chi ^2}$.

\subsection{Doppler kSZ effect}
The expression for $\vec{q}(\vec{k})$ can be found using the fact that in the linear regime, $\delta_e <<  1$ so that $q(\vec{x})=v_e(\vec{x})\Rightarrow \vec{q}(\vec{k})=\vec{v}_e(\vec{k})$.

%We have also used the fact that k modes parallel to the line of sight do not contribute significantly to anisotropies. This is due to the cancellations of crests and troughs along the line of sight. In the small angle approximation the perpendicular k modes have a maximum contribution. %refer to fig 9.3 in dodelson. possibly put this in paper. 
%This is called the Limber approximation. As a result of the suppression of Fourier modes parallel to the line of sight, we have $k_\parallel \approx 0$ .
We can define 
\begin{equation}
u(z)=\frac{f(z)H(z)D(z)}{1+z}g(z)
\end{equation}
so that $\widetilde{u}(\chi)=\frac{u(\chi)}{\chi^2}$. Now, expressing $f(z)$ in terms of comoving distance, $\chi$ and substituting this into equation \ref{final p(l) equation} gives
\begin{equation}\label{final p(l) eqn in terms of f}
p(\vec{l})=-\frac{i}{c}\int d\chi \widetilde{u}(\chi) \int \frac{dk_\parallel}{2\pi} e^{ik_{\parallel}\chi } \frac{\mu_k}{k} \delta{e}(\vec{k})
\end{equation}
%where $\mu_k$ was defined earlier. 
where $\mu_k$ is the angle between the line of sight and $\vec{k}$. This can be rewritten as 
\begin{equation}\label{final p(l) eqn in terms of f with partial deriv}
\begin{aligned}
p(\vec{l})=&-\frac{i}{c}\int d\chi \widetilde{u}(\chi) \frac{\partial e^{ik_{\parallel}\chi }}{\partial \chi} \int \frac{dk_\parallel}{2\pi} \frac{1}{ik_{\parallel}}\frac{\mu_k}{k} \delta{e}(\vec{k})\\
&=-\frac{i}{c}\int d\chi e^{ik_{\parallel}\chi}f_{\chi} \int \frac{dk_\parallel}{2\pi} \frac{1}{ik_{\parallel}}\frac{\mu_k}{k} \delta{e}(\vec{k})
\end{aligned}
\end{equation}
where $f_1=\frac{\partial \widetilde{u}(\chi)}{\partial \chi}$. The second equality was obtained using integration by parts.
The angular power spectrum, $C_l^{pp}$, can be computed using equation \ref{final p(l) equation} as follows
\begin{equation}\label{angular power spec Cl}
\langle p(\vec{l})p(\vec{l^{'*}})\rangle =(2\pi)^2 \delta^2(\vec{l}-\vec{l'})C_l^{pp} \Rightarrow C_l^{pp}=\int \frac{d^2\vec{l'}}{(2\pi)^2}\langle p(\vec{l})p(\vec{l^{'*}})\rangle 
\end{equation}
where the second part of the equation is obtained using the definition of the $\delta$ function, $f(x')=\int f(x)\delta(x-x')$. We can approximate the angular power spectrum to be equal to the 2D power spectrum. 
%To find the angular power spectrum, $C_l^{pp}$, we need to find the relation between the 2D power spectrum and the angular power spectrum. The angular correlation function is obtained from the Fourier transform of the 2D power spectrum.
%\begin{equation}
%\begin{aligned}
%C(\theta)&=\int \frac{d^2l}{(2\pi)^2}e^{i\vec{l}.\vec{\theta}}P_2(l)\\
%&=\frac{1}{2\pi}\int ldlJ_0(l\theta)P_p(l)
%\end{aligned}
%\end{equation}
%where the definition of the zero order Bessel function, $J_0$, is used in the second equality. The correlation function can be written in terms of the multipole moments, $C_l$. 
%\begin{equation}
%C(\theta)=
%\end{equation}
Substituting equation \ref{final p(l) equation} into equation \ref{angular power spec Cl} gives 
\begin{equation}\label{Cl with delta}
\begin{aligned}
C_l^{pp}& =\left(\frac{T_{rad}}{c}\right)^2\int \frac{d^2\vec{l'}}{(2\pi)^2}\int \frac{dk_\parallel}{(2\pi)}e^{ik_\parallel \chi } \int  d\chi e^{ik_{\parallel}\chi}f_1(\chi) \int \frac{dk'_\parallel}{(2\pi)}e^{-ik'_\parallel \chi' }\\&
\int d\chi' f(\chi')\widetilde{g}(\chi' )\frac{\mu_k}{k}  \frac{\zeta_k}{k'}\langle  \delta{e}(\vec{k})\delta{e}^*(\vec{k}') \rangle\\
\end{aligned}
\end{equation}
Expressing $\langle  \delta{e}(\vec{k})\delta{e}^*(\vec{k}') \rangle$ in terms of the power spectrum gives
\begin{equation}\label{Cl with Pm(k)}
\begin{aligned}
C_l^{pp}&=\left(\frac{T_{rad}}{c}\right)^2\int \frac{d^2\vec{l'}}{(2\pi)^2}\int \frac{dk_\parallel}{(2\pi)}\int d\chi e^{ik_{\parallel}\chi}f_1(\chi) \int \frac{dk'_\parallel}{(2\pi)}e^{-ik'_\parallel \chi' }\frac{1}{ik_{\parallel}}\frac{k_\parallel}{\left|k^2_\parallel+\vec{k}^2_\perp\right|} \frac{k'_\parallel}{\left|k'^2_\parallel+\vec{k'}^2_\perp\right|}\\
&\int d\chi' \widetilde{u}(\chi') (2\pi)^2 \delta^2(\vec{k_{\bot}}-\vec{k'_\bot})(2\pi)\delta(\vec{k_\parallel}-\vec{k'_\parallel})P(\vec{l}/\chi,k_\parallel)
\\& =\left(\frac{T_{rad}}{c}\right)^2\int \frac{d^2\vec{k'}_\perp}{(2\pi)^2}\int  \frac{dk_\parallel}{(2\pi)}e^{-ik_\parallel \chi'} \frac{1}{ik_{\parallel}}\frac{k^2_\parallel}{\left|k^2_\parallel+\vec{k}^2_\perp\right|} \frac{1}{\left|k^2_\parallel+\vec{k'}^2_\perp\right|}\int d\chi e^{ik_{\parallel}\chi}f_1(\chi)\\
&\int d\chi' \widetilde{u}(\chi') \chi'^2 (2\pi)^2 \delta^2(\vec{k_{\bot}}-\vec{k'_\bot})(2\pi)P(\vec{l}/\chi,k_\parallel)
\\&=\left(\frac{T_{rad}}{c}\right)^2 \int d\chi e^{ik_{\parallel}\chi}f_1(\chi) \int dk_\parallel e^{-ik_\parallel \chi'} \frac{1}{ik_{\parallel}} \left(\frac{\mu_k}{k}\right)^2 \int d\chi'u(\chi') P(\vec{l}/\chi,k_\parallel)\\
%&=\left(\frac{T_{rad}}{c}\right)^2 (2\pi)^2 \int e^{ik_{\parallel}\chi}f_1(\chi) \int d\chi' e^{-ik_{\parallel}\chi}f_{\chi'}\int dk_\parallel \frac{1}{k^2_{\parallel}} k^2_\parallel\left(\frac{1}{k^2_\parallel+l^2/\chi^2}\right)^2 P(l/\chi,k_\parallel)
&=\frac{T_{rad^2}}{2\pi}x^2 \left(\frac{\sigma_T \rho_{g0}}{\mu_e mp}\right)^2\int_{z_{min}}^{z_{max}} dz_1 \frac{1+z_1}{\chi(z_1)^2}f(z_1) D(z_1) e^{-\tau(z_1)} \\
&\int_{z_{min}}^{z_{max}} dz_2 f(z_2) D(z_2) e^{-\tau(z_2)}(1+z_2)\int dk_\parallel e^{-ik_{\parallel}(\chi(z_1)-\chi(z_2))} \left(\frac{\mu_k}{k}\right)^2 P(k)
\end{aligned}
\end{equation}
where in line 2 we use $\mu_k=cos\theta=\frac{k_\parallel}{k}$ in order to apply the $k_\perp$ and $k_\parallel$ Dirac delta functions. In the last equality, we write the $d\chi'$ integral analogous to equation \ref{final p(l) eqn in terms of f with partial deriv} with $f_2(\chi)=\frac{\partial u(\chi)}{\partial \chi}$. Note that taking the Limber approximation in this expression will give an angular power spectrum of zero. 
%Now, if the visbility function is assumed to be gaussian, it will have the form
%\begin{equation}
%g(\chi)=\frac{1-\exp(-\tau_r)}{\sqrt{2 \pi (\Delta \chi)^2}}\exp\left[-\frac{1}{2}\frac{(\chi-\chi_r)^2}{(\Delta \chi)^2}\right]
%\end{equation}
%where $\tau_r$ is the fraction of CMB photons re-scattered, i.e. the optical depth at reionization and $\chi_r$ is the comoving distance at the EoR. The plot of the gaussian $g(\chi)$ is shown.

Rewriting this with units and orders of magnitude gives

\begin{equation}
\begin{aligned}
C_l^{Doppler}=&10^{-8}\mu K^2\frac{10}{2\pi}\frac{T_{rad^2}}{10^{13} \mu K^2}\frac{x^2}{1} \frac{\sigma_T^2}{(10^{-74})^2 Mpc^2} \frac{\rho_{g0}^2}{(10^{42})^2 g^2 Mpc^{-6}}\frac{(10^{-24})^2 g^2}{\mu_e^2 mp^2}\int \frac{dz_1}{10} \frac{1+z_1}{10}\\
& \frac{(10^4)^2 Mpc^2}{\chi(z_1)^2}\frac{f(z_1)}{0.5} \frac{D(z_1)}{0.5}\frac{e^{-\tau(z_1)}}{e^{-\tau_r}} \int \frac{dz_2}{10} \frac{f(z_2)}{0.5} \frac{D(z_2)}{0.5} \frac{e^{-\tau(z_2)}}{e^{-\tau_r}} \frac{1+z_2}{10}\\
&\int \frac{dk_\parallel}{10^{-1}} \frac{e^{-ik_{\parallel}(\chi(z_1)-\chi(z_2))}}{1} \frac{\mu_k^2}{10^{-2}}\frac{1 Mpc^{-2}}{k^2} \frac{P(k)}{2\times 10^4 Mpc^3}
\end{aligned}
\end{equation}



We can simplify this expression by computing the autocorrelation power spectrum at reionization. Assuming instantaneous reionization at $z_r=10$ simplifies equation \ref{Cl with Pm(k)} to
\begin{equation}\label{Cl lksz simplified}
C_l^{pp}=\frac{1}{2 \pi}\left(\frac{T_{rad}}{c}\right)^2 \frac{u^2(z_r)}{\chi^2_r} \int dk_\parallel \left(\frac{1}{k^2_\parallel+l^2/\chi^2_r}\right)^2 P(l/\chi_r,k_\parallel)
\end{equation}
%\begin{equation}\label{p(kappa) temp distortion in fourier space}
%p(\vec{l})=-\int_{0}^{\eta_0} d\chi g(\chi)\int d^2\theta \int \frac{d^3k}{(2\pi)^3} \hat{\theta}.\vec{q}(\vec{k})e^{-i\vec{l}.\vec{\theta}+i\vec{k}.\vec{x}}
%\end{equation}
%refer to eqns 9.4 and 9.7 in dodelson if this eqn is unclear to you
\noindent Now, we can evaluate this expression in the limits of low and high $\vec{l}$. \\
\begin{itemize}
\item At low $l$, we can Taylor expand about $l=0$ to give $\left(\frac{1}{k^2_\parallel+l^2/\chi^2}\right) \approx \frac{1}{k^2_\parallel}+\frac{l^2}{k^4_\parallel \chi^2}$.
%refer to derivation in dodelson, from 9.3 to 9.10. Maybe put this in the paper, maybe appendix.
Therefore in the low $l$ approximation we have
\begin{equation}\label{low ell limit}
\begin{aligned}
C_l^{pp}&
\approx\left(\frac{T_{rad}}{c}\right)^2  \int d\chi e^{ik_{\parallel}\chi}f_1(\chi) \int d\chi' e^{-ik_{\parallel}\chi'}f_{\chi'}\int dk_\parallel \left(\frac{1}{k^2_\parallel}+\frac{2l^2}{k^4_\parallel \chi^2} + \frac{l^4}{k^6_\parallel \chi^4}\right) P(l/\chi,k_\parallel)\\&
\approx\left(\frac{T_{rad}}{c}\right)^2  \int d\chi e^{ik_{\parallel}\chi}f_1(\chi) \int d\chi' e^{-ik_{\parallel}\chi'}f_{\chi'}\int dk_\parallel \frac{1}{k^2_\parallel} P(k_\parallel)\\
&\approx\left(\frac{T_{rad}}{c}\right)^2  \frac{u^2(z_r)}{\chi^2_r} \int dk_\parallel \frac{P(k_\parallel)}{k^2_\parallel}
\end{aligned}
\end{equation}
where in the last line we use the gaussian visibility function to simplify the expression. %To get order of magnitude estimates, we can explicitly write out the values in the expression. \newline
\item At high $l$, the large $k_\parallel$ modes will cancel under integration.
\begin{equation}
I_1=\lim_{k_\parallel \to \infty, l \to \infty} e^{ik_\parallel (\chi -\chi')}k^2_\parallel\left(\frac{1}{k^2_\parallel+l^2/\chi^2}\right)^2
\end{equation}
Substituting so that $x=k_\parallel$ and $y=l/\chi$ gives 
\begin{equation}
I_1=\lim_{x \to \infty, y \to \infty} e^{iax} \frac{x^2}{(x^2+y^2)^2}
\end{equation}
where $a=\chi-\chi'$. Now, $0\leq e^{iax} \frac{x^2}{(x^2+y^2)^2} \leq e^{iax} \frac{x^2}{x^4}\leq\frac{1}{x^2} \rightarrow 0$ since the exponential\\ $0\leq e^{iax}\leq 1$.
Thus the signal vanishes at high $l$ for small wavelength perturbations.
We can also determine what will happen for small $k_\parallel$ modes at high $l$, i.e. compute the limit of the integrand given by
\begin{equation}
\begin{aligned}
I_2&=\lim_{x \to 0, y \to \infty} e^{iax} \frac{x^2}{(x^2+y^2)^2}\\ &\Rightarrow \lim_{x \to 0, \alpha \to 0} e^{iax} \frac{x^2\alpha ^4}{(x^2\alpha ^2+1)^2}
\end{aligned}
\end{equation}
 where $y=1/\alpha$. Now, $x^2\alpha ^2+1\geq 1$ for small $x,\alpha $. Therefore, $\frac{1}{(x^2\alpha ^2+1)^2} \leq 1 \Rightarrow \frac{x^2\alpha ^4e^{iax}}{(x^2\alpha ^2+1)^2} \leq x^2\alpha ^4e^{iax}\rightarrow 0$, since $e^{iax}\rightarrow 1$ for small $x$.
 Thus, the signal disappears for both long and short wavelength modes along the line of sight at small angles.
\end{itemize}
The angular power spectrum was plotted using equation \ref{Cl lksz simplified}, shown in blue, and is compared with the low \textit{l} limit given by equation \ref{low ell limit}, which is plotted in red. It can be seen that the results agree at low \textit{l}.

\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{"../python_scripts/kSZ_21cm_signal/doppler kSZ"}
	\caption{Angular power spectrum for the doppler kSZ plotted in blue and the results plotted for the low $l$ limit in red.}
	\label{fig:doppler-ksz}
\end{figure}

\newpage

\subsection{Linear kSZ effect (Ostriker-Vishniac effect)}
Referring back to equation \ref{p as a function of theta}, we have $\delta_e > 1$ in the non-linear regime, giving $\vec{q}(\vec{x})\approx\delta_e(\vec{x})\vec{v}_e(\vec{x})$. This is commonly referred to as the Ostriker-Vishniac term. In Fourier space this gives

\begin{equation}\label{q(k)}
\vec{q}_e(\vec{k},z_1)= \int \frac{d^3\vec{k}'}{(2\pi^3)}\delta_e(\vec{k}-\vec{k'},z_1)\vec{v_e}(\vec{k}',z_1)
\end{equation}
%where the different arguments account for the different possible modes of the velocity and density perturbations 
Using the expression for $p(\vec{l})$ from equation we have

\begin{equation}
\begin{aligned}
p(\vec{l})=&-\frac{1}{2c}\int d\chi_1 \widetilde {g}(\chi_1) \int \frac{dk_{\parallel}}{2\pi}e^{ik_{\parallel} \chi_1}\hat{\theta}.\int \frac{d^3k'}{(2\pi)^3}[\delta_e(\vec{k}',z_1)\vec{v}_e(\vec{k}-\vec{k}',z_1)+\delta_e(\vec{k}-\vec{k}',z_1)\vec{v}_e(\vec{k}',z_1)]\\
=&-\frac{if\dot{a}}{2c}\int d\chi_1 \widetilde {g}(\chi_1) \int \frac{dk_{\parallel}}{2\pi}e^{ik_{\parallel} \chi_1}\hat{\theta}.\int \frac{d^3k'}{(2\pi)^3}\delta_e(\vec{k}',z_1)\delta_e(\vec{k}-\vec{k}',z_1)\left(\frac{\vec{k}-\vec{k}'}{|\vec{k}-\vec{k}'|^2} +\frac{\vec{k}'}{k'^2}\right)
\end{aligned}
\end{equation}




%Need to change eqn 24. This v eqn is actually from the peculiar velocity eqn in dodelson.
%Eqn 28, maybe rewrite k in terms of k perp and k parallel and then apply dirac delta functions and then re express ito k thereafter, just to explain why k'=k, which we just sort of assume in equality 2 of eqn 28.
%messed up which variables had primes in eqn 31





Computing the four point correlation with 

\begin{equation}\label{p kSZ of l2}
p(\vec{l}_2)=-\frac{if\dot{a}}{2c}\int d\chi_1 \widetilde {g}(\chi_1) \int \frac{dk_{\parallel}}{2\pi}e^{ik_{\parallel} \chi_1}\hat{\theta}.\int \frac{d^3k'}{(2\pi)^3}\delta_e(\vec{k}'',z_2)\delta_e(\vec{k_2}-\vec{k}'',z_2)\left(\frac{\vec{k_2}-\vec{k}''}{|\vec{k_2}-\vec{k}''|^2} +\frac{\vec{k}''}{k''^2}\right)
\end{equation}
gives 

\begin{equation}\label{Cl lin kSZ ito delta and v}
\begin{aligned}
C_l=&\int \frac{d^2 l_2}{(2\pi)^2}\left<p(\vec{l})p(\vec{l}_2)\right>\\
&=\left(\frac{T_{rad}}{2c}\right)^2\int \frac{d^2l_2}{(2\pi)^2}\int d\chi_1 \widetilde {g}(\chi_1) \int d\chi_2 \widetilde {g}(\chi_2) \int \frac{dk_{\parallel}}{2\pi}e^{ik_{\parallel} \chi_1}\int \frac{dk_{2\parallel}}{2\pi}e^{-ik_{2\parallel} \chi_2}D(z_1)^2 D(z_2)^2\\ 
&f(z_1)\dot{a}(z_1)f(z_2)\dot{a}(z_2)\hat{\theta}.\int \frac{d^2k'_\perp}{(2\pi)^2}\frac{dk'_\parallel}{2\pi}\hat{\theta}.\int\frac{d^2k''_\perp}{(2\pi)^2}\frac{dk''_\parallel}{2\pi}
\left(\frac{\vec{k}-\vec{k}'}{|\vec{k}-\vec{k}'|^2} +\frac{\vec{k}'}{k'^2}\right) 
\left(\frac{\vec{k_2}-\vec{k}''}{|\vec{k_2}-\vec{k}''|^2} +\frac{\vec{k}''}{k''^2}\right)\\
&\left<\delta_e(\vec{k}')\delta_e(\vec{k}-\vec{k}')\delta_e(\vec{k_2}-\vec{k}'')\delta_e(\vec{k}'')\right>
\end{aligned}
\end{equation}

%Let's consider the integrand, omitting redshift dependance for now. 

%\begin{equation}
%\begin{aligned}
%&\left<\hat{\theta}.(\delta_e(\vec{k}',z_1)v_e(\vec{k}-\vec{k}',z_1)+\delta_e(\vec{k}-\vec{k}',z_1)v_e(\vec{k}',z_1))  \hat{\theta}.(\delta_e(\vec{k}'',z_2)v_e(\vec{k_2}-\vec{k}'',z_2)
%+\delta_e(\vec{k_2}-\vec{k}'',z_2)v_e(\vec{k}''),z_2)\right>\\
%&=\hat{\theta}.\delta_e(\vec{k}',z_1)v_e(\vec{k} \hat{\theta}.(\delta_e(\vec{k}'',z_2)+\hat{\theta}.\delta_e(\vec{k}',z_1)v_e(\vec{k}\hat{\theta}.\delta_e(\vec{k_2}-\vec{k}'',z_2)v_e(\vec{k}''),z_2)\\
%&+\hat{\theta}.\delta_e(\vec{k}-\vec{k}',z_1)v_e(\vec{k}',z_1)\hat{\theta}.\delta_e(\vec{k_2}-\vec{k}'',z_2)v_e(\vec{k}''),z_2)+\theta_1.\delta_e(\vec{k}-\vec{k}',z_1)v_e(\vec{k}',z_1)\hat{\theta}.\delta_e(\vec{k_2}-\vec{k}'',z_2)v_e(\vec{k}''),z_2)
%\end{aligned}
%\end{equation}

%Now, Wicks theorem for the 3-dimensional density field correlation is as follows:
%\begin{equation}\label{Wicks thm for density field}
%\begin{aligned}
%<\delta(\vec{k}-\vec{k}')\delta(\vec{k}')\delta^*(\vec{k_2}-\vec{k}'')\delta^*(\vec{k}'')>&=(2\pi)^6 P(|\vec{k}-\vec{k}'|)P(k')[\delta^3(\vec{k_2}-\vec{k}''+\vec{k}')\delta^3(\vec {k_1}'-\vec{k}'+\vec{k}'')\\&
%+\delta^3(\vec {k_1}-\vec{k}'+\vec{k_2}-\vec{k}'')\delta^3(\vec{k}'+\vec{k}'')]
%\end{aligned}
%\end{equation}



Now, we apply Wick's theorem for gaussian fields.
%The negative sign in the Cl expression below comes from replacing k_2 with -k_1 and k'' with -k' which only introduces a negative sign in the \left[\frac{\vec{k_2}-\vec{k}''}{|\vec{k_2}-\vec{k}''|^2}+\frac{\vec{k}''}{|\vec{k}''|^2}\right] term. This gives an overall negative to the equation which cancels with another negative due to the spherical coord transform, check eqn \ref{F spherical coord transform}
\begin{equation}
\begin{aligned}
C_l=&\left(\frac{T_{rad}}{2c}\right)^2\int \frac{d^2k_{2\perp}}{(2\pi)^2}\int d\chi_1 \widetilde {g}(\chi_1) \int d\chi_2 \widetilde {g}(\chi_2) \chi_2^2\int \frac{dk_{\parallel}}{2\pi}e^{ik_{\parallel} \chi_1}\int \frac{dk_{2\parallel}}{2\pi}e^{-ik_{2\parallel} \chi_2}D(z_1)^2 D(z_2)^2\\ 
&f(z_1)\dot{a}(z_1)f(z_2)\dot{a}(z_2)\hat{\theta}.\int \frac{d^2k'_\perp}{(2\pi)^2}\frac{dk'_\parallel}{2\pi}\hat{\theta}.\int\frac{d^2k''_\perp}{(2\pi)^2}\frac{dk''_\parallel}{2\pi}\left(\frac{\vec{k}-\vec{k}'}{|\vec{k}-\vec{k}'|^2} +\frac{\vec{k}'}{k'^2}\right) 
\left(\frac{\vec{k_2}-\vec{k}''}{|\vec{k_2}-\vec{k}''|^2} +\frac{\vec{k}''}{k''^2}\right)\\
&(2\pi)^6  P_{\delta_e \delta_e}(k') P_{\delta_e \delta_e}(|\vec{k}-\vec{k}'|)(\delta^3(\vec{k}'-\vec{k}_2+\vec{k}'')\delta^3(\vec{k}-\vec{k}'-\vec{k}'')+\delta^3(\vec{k}'-\vec{k}'')\delta^3(\vec{k}-\vec{k}'-\vec{k}_2+\vec{k}''))\\
&=\left(\frac{T_{rad}}{2c}\right)^2\int d\chi_1 \widetilde {g}(\chi_1) \int d\chi_2 g(\chi_2) \int \frac{dk_{\parallel}}{2\pi}e^{ik_{\parallel} (\chi_1-\chi_2)}D(z_1)^2 D(z_2)^2\\ 
&f(z_1)\dot{a}(z_1)f(z_2)\dot{a}(z_2)\int \frac{d^3k'}{(2\pi)^3}\left(\frac{\hat{\theta}.(\hat{k}-\hat{k}')}{|\vec{k}-\vec{k}'|} +\frac{\hat{\theta}.\hat{k}'}{k'}\right)^2 P_{\delta_e \delta_e}(k') P_{\delta_e \delta_e}(|\vec{k}-\vec{k}'|)\\
\end{aligned}
\end{equation}

Expanding this equation gives

\begin{equation}
\begin{aligned}
C_l=&\left(\frac{T_{rad}}{2c}\right)^2\int d\chi_1 \widetilde {g}(\chi_1) \int d\chi_2 g(\chi_2) \int \frac{dk_{\parallel}}{2\pi}e^{ik_{\parallel} (\chi_1-\chi_2)}D(z_1)^2 D(z_2)^2\\ 
&f(z_1)\dot{a}(z_1)f(z_2)\dot{a}(z_2)\int \frac{d^3k'}{(2\pi)^3}\left(\frac{[\hat{\theta}.K]^2}{K^2} +\frac{[\hat{\theta}.\hat{k}']^2}{k'^2}+\frac{2[\hat{\theta}.\hat{K}][\hat{\theta}.\hat{k}']}{K k'}\right)\\
& P_{\delta_e \delta_e}(k') P_{\delta_e \delta_e}(K)\\
&=\left(\frac{T_{rad}}{2c}\right)^2\int d\chi_1 \widetilde {g}(\chi_1) \int d\chi_2 g(\chi_2) \int \frac{dk_{\parallel}}{2\pi}e^{ik_{\parallel} (\chi_1-\chi_2)}D(z_1)^2 D(z_2)^2\\ 
&f(z_1)\dot{a}(z_1)f(z_2)\dot{a}(z_2)\int \frac{d^3k'}{(2\pi)^3}\left(\frac{[\hat{\theta}.\hat{k}']^2}{k'^2}+\frac{[\hat{\theta}.\hat{K}][\hat{\theta}.\hat{k}']}{K k'}+[k'\leftrightarrow K]\right) P_{\delta_e \delta_e}(k') P_{\delta_e \delta_e}(K)\\
&=\frac{1}{2}\left(\frac{T_{rad}}{c}\right)^2\int d\chi_1 \widetilde {g}(\chi_1) \int d\chi_2 g(\chi_2) \int \frac{dk_{\parallel}}{2\pi}e^{ik_{\parallel} (\chi_1-\chi_2)}D(z_1)^2 D(z_2)^2\\ 
&f(z_1)\dot{a}(z_1)f(z_2)\dot{a}(z_2)\int \frac{d^3k'}{(2\pi)^3}\left(\frac{[\hat{\theta}.\hat{k}']^2}{k'^2}+\frac{[\hat{\theta}.\hat{K}][\hat{\theta}.\hat{k}']}{K k'}\right) P_{\delta_e \delta_e}(k') P_{\delta_e \delta_e}(K)\\
\end{aligned}
\end{equation}

where $\vec{K}=\vec{k}-\vec{k}'$. And finally, we can rewrite this in the preferred form

\begin{equation}\label{Cl autocorr kSZ general expression}
\begin{aligned}
C_l=&\frac{1}{2}\left(\frac{T_{rad}}{c}\right)^2\int d\chi_1 \widetilde {g}(\chi_1) \int d\chi_2 g(\chi_2) \int \frac{dk_{\parallel}}{2\pi}e^{ik_{\parallel} (\chi_1-\chi_2)}D(z_1)^2 D(z_2)^2\\ 
&f(z_1)\dot{a}(z_1)f(z_2)\dot{a}(z_2)\int \frac{d^3k'}{(2\pi)^3} ([\hat{\theta}.\hat{k}']^2 P_{v_e v_e}(k') P_{\delta_e \delta_e}(K) + [\hat{\theta}.\hat{K}][\hat{\theta}.\hat{k}'] P_{\delta_e v_e}(k') P_{\delta_e v_e}(K))
\end{aligned}
\end{equation}


Now, let's consider a diagram showing these vectors and their corresponding angles in the Limber approximation

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{"../python_scripts/kSZ_21cm_signal/k vector diagram"}
	\caption{Diagram showing the different vectors with the line of sight directed upwards.}
	\label{fig:k-vector-diagram}
\end{figure}

First, we use the fact that $k_\parallel=0$ in the Limber approximation to write $P(K)=P(\sqrt{k_\perp^2+k'^2-2k_\perp k'\zeta} )$, where $\zeta=\hat{k}.\hat{k}'$, which allows us to apply the delta function and collapse $z_1$ and $z_2$. 

\begin{equation}
\begin{aligned}
C_l=&\frac{1}{2}\left(\frac{T_{rad}}{c}\right)^2\int d\chi \frac{g(\chi)^2}{\chi^2} D(z)^4 f(z)^2\dot{a}(z)^2\\ 
&\int \frac{d^3k'}{(2\pi)^3} ([\hat{\theta}.\hat{k}']^2 P_{v_e v_e}(k') P_{\delta_e \delta_e}(K) + [\hat{\theta}.\hat{K}][\hat{\theta}.\hat{k}'] P_{\delta_e v_e}(k') P_{\delta_e v_e}(K))
\end{aligned}
\end{equation}

Since $\zeta=\hat{k}.\hat{k}'=cos\phi$, we have $\hat{\theta}.\hat{k}'=cos(90-\phi)=sin\phi=\sqrt{1-\zeta^2}$. For $\hat{\theta}.\hat{K}$, we have $\hat{\theta}.\hat{K}=cos(90-\alpha)=sin\alpha$. Also, $sin\alpha/k'=-sin\phi/K$. Therefore, $\hat{\theta}.\hat{K}=-\frac{\sqrt{1-\zeta^2}k'}{|K|}$.
Using these relations gives the expression

\begin{equation}
F(k)=\int \frac{d^3k'}{(2\pi)^3}(1-\zeta^2)\left[P_{\delta_e \delta_e}({K})P_{v_ev_e}({k}')-\frac{k'}{|K|}P_{\delta_e v_e}({K})P_{\delta_e v_e}({k}')\right]
\end{equation}

We use the relations

\begin{subequations}
	\begin{equation}
	P_{vv}=\left(\frac{f\dot{a}}{k}\right)^2P_{\delta \delta}
	\end{equation}
	\begin{equation}
	P_{\delta v}=\frac{f\dot{a}}{k}P_{\delta \delta}
	\end{equation}
\end{subequations}
which we obtain from equation \ref{v(k)}.
Substituting these expressions gives the final equation 

\begin{equation}
F(k)=\dot{a}^2 D(z)^4 \int \frac{d^3k'}{(2\pi)^3}f^2P_{\delta_e \delta_e}({k}')P_{\delta_e \delta_e}(K)I(k,k',\zeta)
\end{equation}
where 
\begin{equation}
\begin{aligned}
I(k,k',\zeta)&=\hat{\theta}.\hat{k}'\left[\frac{\hat{\theta}.\hat{k}'}{k'^2}+\frac{\hat{\theta}.\hat{K}}{K k'}\right]\\
&=\frac{k(k-2k'\zeta)(1-\zeta^2)}{k'^2(k'^2+k^2-2kk'\zeta)}\\
\end{aligned}
\end{equation}

We decompose the $d^3\vec{k}'$ integral into spherical coordinates with polar angle, $\Phi$ and azimuthal angle, $\Theta$, so that we have $\int d^3\vec{k}'=\int_0^{2\pi} \int_0^{\pi} \int k'^2 sin\Theta dk' d\Theta d\Phi$. Substituting $U=cos\Theta$ gives $dU=-sin\Theta d\Theta$, so that $\int d^3\vec{k}'=-2\pi \int_1^{-1} \int k'^2 dk' dU = 2\pi \int_{-1}^1 \int k'^2 dk' dU$. Also, since $\Theta=90-\phi$, this gives the relation $cos\phi=sin\Theta \Rightarrow \zeta=\sqrt{1-U^2}$. Thus, we have the expression

\begin{equation}
F(k)=\dot{a}^2 D(z)^4 2\pi \int \frac{dk'}{(2\pi)^3} \int_{-1}^1 dU f^2P_{\delta_e \delta_e}({k}')P_{\delta_e \delta_e}(\sqrt{k^2+k'^2-2k k'\sqrt{1-U^2}})I(k,k',\zeta)
\end{equation}
where 
\begin{equation}\label{I for limber}
I(k,k',U)=\frac{k(k-2k'\sqrt{1-U^2}) U^2}{k'^2(k'^2+k^2-2kk'\sqrt{1-U^2})}
\end{equation}

In the Limber approximation, we have the expression for the angular power spectrum

\begin{equation}
C_l=\frac{1}{2}\frac{T_{rad}^2}{c^2}\int d\chi \frac{g(\chi)^2}{\chi^2}F(l/\chi)
\end{equation}

This can be written in the more familiar form

\begin{equation}\label{lin kSZ OV eqn}
C_l=\frac{8 \pi^2}{(2l+1)^3}\left(\frac{\sigma_T \rho_{g0}}{\mu_e m_p}\right)^2\int_0^{z_{re}}\frac{dz}{c}(1+z)^4 x^2 \Delta_B^2(l/\chi)e^{-2\tau(z)}\frac{\chi(z)}{H(z)}
\end{equation}

where the dimensionless power spectrum is 

\begin{equation}
\Delta_B^2(k)=\frac{k^3}{2\pi^2}F(k)
\end{equation}


The expression that I coded is

\begin{equation}
\begin{aligned}
C_l&=\frac{1}{8\pi^2}T_{rad}^2 x^2 \left(\frac{\sigma_T \rho_{g0}}{\mu_e m_p}\right)^2  \frac{1}{c} \int_{10^{-4}}^{10} \int_{10^{-10}}^{10} \int_{-1}^1 f(z)^2 D(z)^4\\ &P_{\delta_e \delta_e}(k')P_{\delta_e \delta_e}(\sqrt{k^2+k'^2-2k k'\sqrt{1-U^2}})    \frac{k(k-2k'\sqrt{1-U^2}) U^2}{k'^2(k'^2+k^2-2kk'\sqrt{1-U^2})} (1+z)^2e^{-2\tau(z)}\frac{H(z)}{\chi(z)^2} dU dk'dz 
\end{aligned}
\end{equation}
where $k=l/\chi(z)$, we use $\dot{a}=H(z)/(1+z)$. 

%Writing this with units and orders of magnitude gives

%\begin{equation}
%\begin{aligned}
%C_l&=10^{-6}\mu K^2 \frac{100}{8\pi^2} \frac{T_{rad^2}}{10^{13} \mu K^2}\frac{x^2}{1} \frac{\sigma_T^2}{(10^{-74})^2 Mpc^2} \frac{\rho_{g0}^2}{(10^{42})^2 g^2 Mpc^{-6}}\frac{(10^{-24})^2 g^2}{\mu_e^2 mp^2}  \frac{10^{-14} Mpcs^{-1}}{c}\\ &\int_{10^{-4}}^{10} \frac{dz}{10} \frac{(1+z)^2}{10^2}\frac{e^{-2\tau(z)}}{e^{-2\tau_r}}\frac{H(z)}{H_0 s^{-1}}\frac{5000^2 Mpc^2}{\chi(z)^2} \frac{f(z)^2}{0.5^2} \frac{D(z)^4}{0.5^4}\\ 
%& \int_{10^{-4}}^{10} \frac{dk'}{10 Mpc^{-1}}\int_{-1}^1 \frac{d\zeta}{2} \frac{P_{\delta_e \delta_e}(k')}{2\times 10^4 Mpc^3} \frac{P_{\delta_e \delta_e}(|k-k'|)}{2\times 10^4 Mpc^3}\\
%&\frac{k(k-2k'\zeta)(1-\zeta^2)}{10(10-2\times10^{-2}\times 0.5)(1-0.5^2)Mpc^{-2}}\frac{10^{-4}+10^2-2\times 10\times 10^{-2}\times 0.5 Mpc^{-2}}{k'^2+k^2-2kk'\zeta}  
%\end{aligned}
%\end{equation}


%Using the specific coordinate transformation given previously
%\begin{equation}
%\begin{aligned}
%C_l&=T_{rad}^2 x^2 \left(\frac{\sigma_T \rho_{g0}}{\mu_e m_p}\right)^2  \frac{1}{c}\frac{2\pi}{2(2\pi)^{3/2}} \int_{10^{-4}}^{10} \int_{10^{-4}}^{10} \int_{-1}^1 f(z)^2 D(z)^4\\ &P(kx)P(k\sqrt{1+x^2-2\zeta x})\frac{k(1-2\zeta x)(1-\zeta^2)}{1+x^2-2\zeta x}(1+z)^2e^{-2\tau(z)}\frac{H(z)}{\chi(z)^2} d\zeta dk'dz 
%\end{aligned}
%\end{equation}
%where I use $x=k'/k$.

	
\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{"../python_scripts/kSZ_21cm_signal/Cl OV power spec"}
	\caption{Linear kSZ power spectrum plotted for the Limber case.}
	\label{fig:cl-ov-power-spec}
\end{figure}	

	
\newpage
\subsubsection{Linear kSZ angular power spectrum without assuming Limber}

Let us return to the more general equation for the angular power spectrum, before the Limber approximation was applied.

\begin{equation}
\begin{aligned}
C_l=&\frac{1}{2}\left(\frac{T_{rad}}{c}\right)^2\int d\chi_1 \widetilde {g}(\chi_1) \int d\chi_2 g(\chi_2) \int \frac{dk_{\parallel}}{2\pi}e^{ik_{\parallel} (\chi_1-\chi_2)}D(z_1)^2 D(z_2)^2\\ 
&f(z_1)\dot{a}(z_1)f(z_2)\dot{a}(z_2)\int \frac{d^3k'}{(2\pi)^3} ([\hat{\theta}.\hat{k}']^2 P_{v_e v_e}(k') P_{\delta_e \delta_e}(K) + [\hat{\theta}.\hat{K}][\hat{\theta}.\hat{k}'] P_{\delta_e v_e}(k') P_{\delta_e v_e}(K))
\end{aligned}
\end{equation}

We can also consider the non-Limber case by substituting expressions for $\hat{\theta}.\hat{k}'$ and $\hat{\theta}.\hat{K}$ from the diagram showing the vectors for $k_\parallel \neq 0$.

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{"../python_scripts/kSZ_21cm_signal/k vec non limber v2"}
	\caption{Diagram showing the different vectors in the non-Limber case.}
	\label{fig:k-vec-non-limber-v2}
\end{figure}

 This diagram was shown previously when computing the 21 cm momentum, thus we again have the equations

\begin{subequations}\label{k' in los ksz}
	\begin{equation}
	\hat{\theta}.\hat{k}'=sin(\gamma+\phi)=\mu_k\zeta+\frac{l}{\chi}\frac{1}{k}\sqrt{1-\zeta^2}
	\end{equation}
	\begin{equation}\label{K in los ksz}
	\hat{\theta}.\hat{K}=-sin(\alpha-\gamma)=-\left[\frac{k'}{k-k'}\frac{l}{\chi}\frac{1}{k}\sqrt{1-\zeta^2}-\frac{(k-k'\zeta)}{k-k'}\mu_k\right]
	\end{equation}
\end{subequations}


where $\zeta=\frac{k_\parallel}{k}U+\frac{k_\perp}{k}\sqrt{1-U^2}$.

%Substituting these expressions in equation \ref{Cl autocorr kSZ general expression} gives

%\begin{equation}\label{I non limber}
%\begin{aligned}
%I(k,k',\zeta,k_\parallel)=&\left(\frac{k_\parallel \zeta}{k}+\frac{l}{\chi k}\sqrt{1-\zeta^2}\right)\\&\left[\left(k_\parallel \zeta +\frac{l}{\chi}\sqrt{1-\zeta^2}\right)\left(\frac{k-2k'\zeta}{k'^2(k^2+k'^2-2kk'\zeta)}\right)+\frac{k_\parallel}{k'(k^2+k'^2-2kk'\zeta)}\right]
%\end{aligned}
%\end{equation}
%This above equation has units of Mpc^{2} which is correct 

We can recover the expressions for $\hat{\theta}.\hat{k}'$ and $\hat{\theta}.\hat{K}$ in the Limber case if we set $k_\parallel=0$ in equations \ref{k' in los ksz} and \ref{K in los ksz}, since $k=\frac{l}{\chi}$ in the Limber case. The expression for the angular power spectrum in the non-Limber case that I am coding is thus




The exact expression that I am coding up is

\begin{equation}\label{Cl non limber that I am coding}
\begin{aligned}
C_l&=\frac{T_{rad}^2}{16 \pi^3 c^2} x^2 \frac{\sigma_T^2 \rho_{g0}^2}{\mu_e^2 m_p^2}  \int   \int_{1e-4}^{10}  \int_{1e-4}^{10}  \int \int_{-1}^1  H(z_1)^2 H(z_2)^2 e^{ik_\parallel(\chi_1-\chi_2)} \\
&   k'^2  (1+z_1) \frac{e^{-\tau(z_1)}}{\chi(z_1)^2} D(z_1)^2 D(z_2)^2 f(z_1) f(z_2)(1+z_2)e^{-\tau(z_2)} \\
&P_{\delta_e \delta_e}(k')P_{\delta_e \delta_e}(\sqrt{k^2+k'^2-2kk'\left(\frac{k_\parallel}{k}U+\frac{k_\perp}{k}\sqrt{1-U^2}\right)}) I(k,k',U,k_\parallel){dU}{dk'}{dz_1}{dz_2}{dk_\parallel}
\end{aligned}
\end{equation}


%order of magnitude calc
%\begin{equation}\label{Cl non limber that I am coding}
%\begin{aligned}
%C_l&=10^{-7}\mu K^2 \frac{100}{16\pi^3}\frac{T_{rad}^2}{10^{13}\mu K^2}\frac{x^2}{1} \frac{\sigma_T^2}{(10^{-74})^2 Mpc^4} \frac{\rho_{g0}^2}{(10^{42})^2 g^2 Mpc^{-6}}\frac{(10^{-24})^2 g^2}{\mu_e^2 m_p^2}  \int \frac{dk_\parallel}{10 Mpc^{-1}}  \int \frac{dz_1}{10} \int \frac{dz_2}{10}   \\
%& \int \frac{d\zeta}{2} \int \frac{dk'}{10^{-2}Mpc^{-1}}\frac{k'^2}{10^{-4} Mpc^{-2}}  \frac{(1+z_1)}{10} \frac{e^{-\tau(z_1)}}{e^{-\tau_r}} \frac{D(z_1)^2}{0.5^2} \frac{D(z_2)^2}{0.5^2} \frac{f(z_1)}{0.5} \frac{f(z_2)}{0.5} 
%\frac{1+z_2}{10}  \frac{e^{-\tau(z_2)}}{e^{-\tau_r}} \frac{5000^2}{\chi(z_1)^2} \\
%&\frac{P_{\delta_e \delta_e}(k')}{2\times 10^4 Mpc^3}\frac{P_{\delta_e \delta_e}(\sqrt{k^2+k'^2-2kk'\zeta})}{2\times 10^4 Mpc^3} \left(\frac{\mu_k\zeta}{10^{-5}}+\frac{l}{10^3}\frac{5000 Mpc}{\chi}\frac{10 Mpc^{-1}}{ k}\frac{\sqrt{1-\zeta^2}}{\sqrt{1-0.5^2}}\right)\\&
%\left[\frac{k_\parallel}{10^{-4}Mpc^{-1}} \frac{\zeta}{0.5} +\frac{l}{10^3}\frac{5000 Mpc}{\chi}\frac{\sqrt{1-\zeta^2}}{\sqrt{1-0.5^2}}\frac{k-2k'\zeta}{10 Mpc^{-1}}\frac{1 Mpc^{-2}}{k'^2(k^2+k'^2-2kk'\zeta)}+\right.\\
%&\left.\frac{k_\parallel}{10^{-4}Mpc^{-1}}\frac{1 Mpc^{-1}}{k'(k^2+k'^2-2kk'\zeta)}\right]
%\end{aligned}
%\end{equation}

where we used $g(\chi)=\left(\frac{\sigma_T \rho_{g0}}{\mu_e m_p}\right) (1+z)^2 x(z) e^{-\tau(z)}$, $\dot{a}=H(z)/(1+z)$ and $d\chi=\frac{c}{H(z)}dz$

%\textbf{My explanation of why I think 5 integrals is enough}:
%Referring to the diagram, this shows $\vec{k}$ and $\vec{k}-\vec{k}'$ vectors for a certain redshift, say $z_1$. Starting with a given $l$, we compute $k_\perp=l/\chi(z_1)$ and integrate over $z_1$ to consider all possible $k_\perp$. We also integrate over $k_\parallel$. Together these two components give all possible lengths of $\vec{k}$ and all possible orientations (i.e. the angle of inclination or declination of the vector). We also integrate over all possible angular separations between vectors $\vec{k}$ and $\vec{k}'$. There is also the integral over the length of vector $\vec{k}'$. We do not need to integrate over all possible angles of inclination (for orientation) of $\vec{k}'$ given that we have already accounted for the angular inclination of $\vec{k}$ and the angle between the two vectors. I think that the geometric representation of vectors $\vec{k}$ and $\vec{k}'$ is sufficiently accounted for with four integrals, viz. $\zeta, \vec{k}', k_\parallel$ and $z_1$. There are also density and velocity fields for $z_2$ thus we integrate over a second redshift, giving a total of 5 integrals. 


%\begin{figure}[h!]
%	\centering
%	\includegraphics[width=0.7\linewidth]{"../python_scripts/kSZ_21cm_signal/Cl OV non limber everything half z1 half z2 with chi_z2"}
%	\caption{The non limber power spectrum plot $l(l+1)C_l$ using in equation \ref{Cl non limber that I am coding} with all integrals}
%	\label{fig:cl-ov-non-limber-everything-half-z1-half-z2-with-chiz2}
%\end{figure}



%\begin{figure}[h!]
%	\centering
%	\includegraphics[width=0.7\linewidth]{"../python_scripts/kSZ_21cm_signal/non limber angular power spec great shape amp off by 5"}
%	\caption{The non limber power spectrum plot $l(l+1)C_l$ using in equation \ref{Cl non limber that I am coding} with all integrals and with a better shape and amp than the plot from last week}
%	\label{fig:non-limber-angular-power-spec-great-shape-amp-off-by-5}
%\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{"../python_scripts/kSZ_21cm_signal/comparison of limber and non-limber OV"}
	\caption{Comparison of limber and non-limber OV angular power spectra integrating up to $k'=10^{-2}$ Mpc$^{-1}$. The results are in close agreement for the \textit{k} modes considered.}
	\label{fig:comparison-of-limber-and-non-limber-ov}
\end{figure}


\newpage
\subsubsection{Redshift dependence of the kSZ signal}
Below are plots showing the redshift dependance of the signal for the linear kSZ
\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{"../python_scripts/kSZ_21cm_signal/Cl OV integrand"}
	\caption{The integrand of the linear kSZ power spectrum which is integrated over k' and $\zeta$ only.}
	\label{fig:cl-ov-integrand}
\end{figure}


\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{"../python_scripts/kSZ_21cm_signal/Cl OV integral redshift bins"}
	\caption{Linear kSZ power spectrum plotted for different redshift bins, with each bin integrated until $z=6$.}
	\label{fig:cl-ov-integral-redshift-bins}
\end{figure}


I have plotted the power spectrum integrating over all $k'$, but plotting as a function of $l$ and $z$ for different redshift bins in Figure \ref{fig:cl-ov-integrand}. I have also plotted the power spectrum as a function of $l$ with integrations over different redshift bins \ref{fig:cl-ov-integral-redshift-bins}. Please refer to equation \ref{lin kSZ OV eqn}, which is plotted in Figure \ref{fig:cl-ov-integral-redshift-bins}, while varying the upper limit of integration for redshift. The integrand is plotted in Figure \ref{fig:cl-ov-integrand}

\subsection{kSZ variance}

The angular power spectrum of the kSZ signal can be expressed as

\begin{equation}
C_l^{kSZ}=\left< p^{kSZ}(\vec{l}) p^{kSZ}(\vec{l})\right>
\end{equation}

The variance of the kSZ signal is written as

\begin{equation}\label{variance of kSZ}
\begin{aligned}
\delta^2(\vec{l}-\vec{l}')(\sigma_l^{kSZ})^2&=\left<C_l C_{l'}\right>-\left<C_l\right>\left<C_{l'}\right>\\
&=\left< \hat{p}(\vec{l})\hat{p}(\vec{l})\hat{p}(\vec{l}')\hat{p}(\vec{l}')\right>-\left<\hat{p}(\vec{l})\hat{p}(\vec{l})\right> \left<\hat{p}(\vec{l}')\hat{p}(\vec{l}')\right>\\
&=2\left<\hat{p}(\vec{l})\hat{p}(\vec{l}')\right>\left<\hat{p}(\vec{l})\hat{p}(\vec{l}')\right> +\left<\hat{p}(\vec{l})\hat{p}(\vec{l})\right>\left<\hat{p}(\vec{l}')\hat{p}(\vec{l}')\right>-\left<\hat{p}(\vec{l})\hat{p}(\vec{l})\right> \left<\hat{p}(\vec{l}')\hat{p}(\vec{l}')\right>
\end{aligned}
\end{equation}
where the kSZ noise is given as

\begin{equation}
\left< \hat{p}(\vec{l})\hat{p}(\vec{l}')\right>=\delta^2(\vec{l}-\vec{l}')(C_l^{pp}+N_l^{pp})
\end{equation}

This gives the variance of

\begin{equation}
\sigma_{kSZ}^2= 2(C_l^{pp}+N_l^{pp})^2
\end{equation}

%\begin{equation}
%C_l^{pp}=\frac{1}{N_{modes}}\int_{a_l} \frac{d^2l'}{(2\pi)^2}\left<p(l')p(l')\right>
%\end{equation}

%Now, the number of modes in an annulus in Fourier space, centered at \textit{l}, is given by

%\begin{equation}
%N_{modes}=\frac{2\pi l\Delta l}{(2\pi)^2/S_{area}}
%\end{equation}
%where $(2\pi)^2/S_{area}$ is the area of one Fourier mode and $2\pi l\Delta l$ is the area of the annulus centered at \textit{l}.

%The variance is given by the expression

%\begin{equation}
%\sigma^2_{kSZ}=\left<(C_l^{kSZ})^2\right>-\left<C_l^{kSZ}\right>^2
%\end{equation}

%The first term is given by

%\begin{equation}
%\begin{aligned}
%\left<(C_l^{kSZ})^2\right>&=\frac{1}{N_{modes}^2}\int_{a_l} \frac{d^2l'}{(2\pi)^2}\int_{a_l} \frac{d^2l''}{(2\pi)^2}\left<p(l')p(l')p(l'')p(l'')\right>\\
%&=\frac{1}{N_{modes}^2}\int_{a_l} \frac{d^2l'}{(2\pi)^2}\int_{a_l} \frac{d^2l''}{(2\pi)^2}(\left< p(l')p(l')\right>\left<p(l'')p(l'')\right>+2\left<p(l')p(l'')\right>\left<p(l')p(l'')\right>)\\
%&=\frac{1}{N_{modes}^2}\int_{a_l} \frac{d^2l'}{(2\pi)^2}\int_{a_l} \frac{d^2l''}{(2\pi)^2}C_{l'}^{kSZ}C_{l''}^{kSZ}+2\int_{a_l} \frac{d^2l'}{(2\pi)^2}(C_{l'}^{kSZ})^2
%\end{aligned}
%\end{equation}

%The second term is given by

%\begin{equation}
%\left<C_l^{kSZ}\right>^2=\frac{1}{N_{modes}^2}\int_{a_l} \frac{d^2l'}{(2\pi)^2}\int_{a_l} \frac{d^2l''}{(2\pi)^2} C_{l'}^{kSZ} C_{l''}^{kSZ}
%\end{equation}

%Then the variance is given by 

%\begin{equation}
%\sigma^2_{kSZ}=\frac{1}{N_{modes}^2}2\int_{a_l} \frac{d^2l'}{(2\pi)^2}(C_{l'}^{kSZ})^2
%\end{equation}

%If we assume that the integrand is constant in the annulus and is equal to the value of the angular power spectrum centered at \textit{l}, then we have

%\begin{equation}
%\begin{aligned}
%\sigma^2_{kSZ}&=\frac{1}{N_{modes}^2}2(C_{l}^{kSZ})^2\int_{a_l} \frac{d^2l'}{(2\pi)^2}\\
%&=\frac{1}{N_{modes}}2(C_{l}^{kSZ})^2
%\end{aligned}
%\end{equation}

%since the total number of modes in the annulus is equal to $N_{modes}$.


\subsection{Noise}



\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/CMB_noise/OV_and_CMB_noise_prelim}
	\caption{The full OV signal is plotted with the CMB spectrum, $C_l^{TT}$ and the CMB noise, $N_l^{TT}$.}
	\label{fig:ovandcmbnoiseprelim}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/CMB_noise/OV_and_combined_CMB_noise_prelim}
	\caption{}
	\label{fig:ovandcombinedcmbnoiseprelim}
\end{figure}


%\begin{figure}[h!]
%	\centering
%	\includegraphics[width=0.7\linewidth]{../python_scripts/CMB_noise/ACT_AdvACT_noise}
%	\caption{Comparison of CMB noise from ACT and AdvACT experiments plotted as $l(l+1)N_l$, in order to match the scales of the signal and noise plotted in Figure \ref{fig:ovandcmbnoiseprelim}.}
%	\label{fig:actadvactnoise}
%\end{figure}
In order to determine CMB noise, we look at the detector noise of CMB experiments. The experiment that I am looking at is AdvACT. The detector noise is given as

\begin{equation}
N_l^{TT}=\sigma_p^2 e^{l^2 \theta_{beam}^2}
\end{equation}
where $\theta_{beam}=\theta_{fwhm}/8ln2$ is the beam width and $\sigma_p$ is the detector noise in a pixel of side $\theta_{beam}$. The detector noise is calculated using the 150 GHz channel of AdvACT with $\theta_{fwhm}=1.5$ \textit{arcmin} and $\sigma_p=1.5 \mu K$/\textit{arcmin}. The total CMB noise is equal to the sum of the CMB spectrum and the CMB noise. Thus, $N_l^{kSZ} \equiv N_l^{CMB}=C_l^{TT}+N_l^{TT}$. 
Using the previously calculated kSZ variance, $(\sigma_l^{kSZ})^2$, the signal-to-noise can be calculated as $S/N=\sqrt{N_{modes}} \frac{C_l^{kSZ}}{\sigma_l^{kSZ}}$ where $N_{modes}=2l\Delta l f_{sky}$.

\begin{equation}
\begin{aligned}
\left(\frac{S}{N}\right)^2=&2 f_{sky}\int \frac{d^2l}{(2\pi)^2}\left(\frac{C_l^{kSZ}}{\sigma_l^{kSZ}}\right)^2 \\
=&2 f_{sky}\int \frac{dl}{2\pi}l\left(\frac{C_l^{kSZ}}{\sqrt{2}(C_l^{kSZ}+N_l^{kSZ})}\right)^2 \\
\end{aligned}
\end{equation}

The sky fraction, $f_{sky}$, is expressed as $f_{sky}=\frac{S_{area} (radians)}{4\pi}$. We plot the differential and cumulative signal-to-noise in Figures \ref{fig:snr-integrand} and \ref{fig:snr}.

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{"../python_scripts/CMB_noise/SNR integrand"}
	\caption{Differential signal-to-noise for the OV signal.}
	\label{fig:snr-integrand}
\end{figure}



\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/CMB_noise/SNR}
	\caption{Cumulative signal-to-noise for the OV signal.}
	\label{fig:snr}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/Pdeltadelta_Pvv_Pdeltav}
	\caption{Dimensionless power spectrum}
	\label{fig:pdeltadeltapvvpdeltav}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/k_cubed_P_delta_2d_colorplot}
	\caption{$P_{\delta \delta}$}
	\label{fig:kcubedpdelta2dcolorplot}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/k_cubed_P_delta_v_2d_colorplot}
	\caption{$P_{\delta v}$}
	\label{fig:kcubedpdeltav2dcolorplot}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/k_cubed_Pv_2d_colorplot}
	\caption{$P_{v v}$}
	\label{fig:kcubedpv2dcolorplot}
\end{figure}

\clearpage
\section{21cm-linear kSZ Cross-correlation}





The 21-cm momentum field is written as

%\begin{equation}
%p(\vec{\theta})=\frac{-1}{c}\hat{\theta}.q(\vec{x}(\vec{\theta},\chi))
%\end{equation}

%\begin{equation}
%p_{21}(\vec{l},y;\chi_i)=\frac{q_\perp^{21}(\vec{k}_\perp \chi,k_\parallel r_\nu)}{\chi^2 r_\nu}
%\end{equation}




\begin{equation}
p_{21}(\vec{l},y,z_1)=\frac{-1}{c}\frac{1}{\chi_1^2 r_1} \hat{\theta}_1.\vec{q}_{21}(\vec{k},z_1)
\end{equation}

where $\vec{k}=(k_{\perp},k_{\parallel})$ with $k_{\perp}=\frac{l}{\chi_1}$ and $k_{\parallel}=\frac{y}{\chi_1}$,

\begin{equation}
\vec{q}_{21}(\vec{k},z_1)=\int \frac{d^3k'}{(2\pi)^3}\delta_{21}(\vec{k}-\vec{k}',z_1)\vec{v}_{21}(\vec{k}',z_1)
\end{equation}

and 

\begin{equation}
\delta_{21}(\vec{k},z_1)=\overline{T}(z_1)D(z_1)\delta_m(\vec{k};z=0)[b_{HI}+f\mu_k^2]
\end{equation}

Combining this with equation for the kSZ momentum, $p_{kSZ}$ 

\begin{equation}
\begin{aligned}
p_{kSZ}(\vec{l}_2)=&-\frac{1}{c}\int d\chi_2 g(\chi_2) \int \frac{dk_{2\parallel}}{2\pi}\frac{e^{ik_{2\parallel} \chi_2}}{\chi_2^2}\hat{\theta}_2.\vec{q}_{e}(\vec{k}_2,z_2)\\
\end{aligned}
\end{equation}

where $\vec{k}_2=(k_{2\perp},k_{2\parallel})$ with $k_{2\perp}=\frac{l_2}{\chi_2}$ and $k_{2\parallel}=\frac{y_2}{\chi_2}$,
\begin{equation}
\vec{q}_{e}(\vec{k}_2,z_2)=\int \frac{d^3k''}{(2\pi)^3}\delta_{e}(\vec{k}_2-\vec{k}'',z_2)\vec{v}_{e}(\vec{k}'',z_2)
\end{equation}


%\begin{equation}
%\begin{aligned}
%C_l^{p_{21}p_e}=&\frac{T_{rad}}{(2c)^2}\int \frac{d^2l_2}{(2\pi)^2} \int d\chi \widetilde {g}(\chi) \int \frac{dk_{\parallel}}{2\pi}\frac{e^{ik_{\parallel} \chi_i}}{\chi_i^2}\int \frac{dk_{2\parallel}}{2\pi}e^{-ik_{2\parallel} \chi}\int \frac{d^3k'}{(2\pi)^3}\int\frac{d^3k''}{(2\pi)^3}\\ 
%&<\hat{\theta}.(\delta_{21}(\vec{k}-\vec{k}',z_i)\vec{v}_{21}(\vec{k}',z_i)+\delta_{21}(\vec{k}',z_i)\vec{v}_{21}(\vec{k}-\vec{k}',z_i))  \hat{\theta}.(\delta_e(\vec{k}'',z)\vec{v}_e(\vec{k_2}-\vec{k}'',z)+\delta_{e}(\vec{k}',z_i)\vec{v}_{e}(\vec{k}-\vec{k}',z_i))>
%&=-\frac{T_{rad}}{c}\frac{\bar{T}(z_i)D(z_i)(b+f\mu_k^2)}{\chi^2(z_i)r_\nu(z_i)}\left(\frac{a(z_i)\dot{D}(z_i)D(z_i)}{2{D_0}^2}\right)\int \frac{d^2k_{2\perp}}{(2\pi)^2} \int d\chi \chi^2 \widetilde {g}(\chi) \left(\frac{a(\chi)\dot{D}(\chi)D(\chi)}{2{D_0}^2}\right)\\ 
%&\int \frac{dk_{\parallel}}{2\pi}e^{ik_{\parallel} \chi(z_i)}\int \frac{dk_{2\parallel}}{2\pi}e^{-ik_{2\parallel} \chi}\int \frac{d^2k'_\perp}{(2\pi)^2}\frac{dk'_\parallel}{2\pi}
%\int \frac{d^2k''_\perp}{(2\pi)^2}\frac{dk''_\parallel}{2\pi} \left<\delta_0(\vec{k}')\delta_0(\vec{k}-\vec{k}')  \delta_0^*(\vec{k}'')\delta_0^*(\vec{k_2}-\vec{k}'')\right>\\
%&\hat{\theta}.\left[\frac{\vec{k}-\vec{k'}}{|\vec{k}-\vec{k}'|^2}+\frac{\vec{k}'}{|\vec{k}'|^2}\right]\hat{\theta}.\left[\frac{\vec{k_2}-\vec{k}''}{|\vec{k_2}-\vec{k}''|^2}+\frac{\vec{k}''}{|\vec{k}''|^2}\right]
%\end{aligned}
%\end{equation}

We then compute the bispectrum as follows.

\begin{equation}
\begin{aligned}
B^{p_{21}p_{ksz}}(\textbf{l}_{21},y_{21},z_{21})&=\int \frac{d^2\textbf{l}_{ksz}}{(2\pi)^2}\left<p_{21}(\textbf{l}_{21},y_{21},z_{21})p^*_{ksz}(\textbf{l}_{ksz})\right>\\
&=\frac{T_{rad}}{c^2}\frac{D^2(z_{21})}{\chi^2(z_{21}) r(z_{21})}\int \frac{d^2\textbf{l}_{ksz}}{(2\pi)^2} \int d\chi_{ksz}  {g}(\chi_{ksz})D^2(z_{ksz}) \int \frac{dk_{ksz}^{\parallel}}{2\pi}\frac{e^{-ik_{ksz}^{\parallel}} \chi_{ksz}}{\chi^2_{ksz}} \\ 
& \int \frac{d^3\textbf{k}_{v_{21}}}{(2\pi)^3}\int\frac{d^3\textbf{k}_{v_{ksz}}}{(2\pi)^3} <\delta_{21}(\textbf{k}_{q_{21}}-\textbf{k}_{v_{21}}){v}_{21}^{\parallel}(\textbf{k}_{v_{21}}) \delta^*_{ksz}(\textbf{k}_{q_{ksz}}-\textbf{k}_{v_{ksz}}){v}^{*\parallel}_{ksz}(\textbf{k}_{v_{ksz}})> \\
%=&\frac{T_{rad}}{c^2}\frac{D^2(z_{21})}{\chi^2(z_{21}) r(z_{21})}\int \frac{d^2\textbf{l}_{ksz}}{(2\pi)^2} \int d\chi_{ksz}  {g}(\chi_{ksz})D^2(z_{ksz}) \int \frac{dk_{ksz}^{\parallel}}{2\pi}\frac{e^{-ik_{ksz}^{\parallel}} \chi_{ksz}}{\chi^2_{ksz}} \\ 
%& \int \frac{d^3\textbf{k}_{v_{21}}}{(2\pi)^3}\int\frac{d^3\textbf{k}_{v_{ksz}}}{(2\pi)^3} \\
%&=-\frac{T_{rad}}{c^2}\frac{\bar{T}(z_i)D(z_i)(b+f\mu_k^2)}{\chi^2(z_i)r_\nu(z_i)}\left(\frac{a(z_i)\dot{D}(z_i)D(z_i)}{2{D_0}^2}\right)\int \frac{d^2k_{2\perp}}{(2\pi)^2} \int d\chi \chi^2 \widetilde {g}(\chi) \left(\frac{a(\chi)\dot{D}(\chi)D(\chi)}{2{D_0}^2}\right)\\ 
%&\int \frac{dk_{\parallel}}{2\pi}\frac{e^{ik_{\parallel} \chi_i}}{\chi_i^2}\int \frac{dk_{2\parallel}}{2\pi}e^{-ik_{2\parallel} \chi}\int \frac{d^2k'_\perp}{(2\pi)^2}\frac{dk'_\parallel}{2\pi}
%\int \frac{d^2k''_\perp}{(2\pi)^2}\frac{dk''_\parallel}{2\pi} \left<\delta_0(\vec{k}')\delta_0(\vec{k}-\vec{k}')  \delta_0^*(\vec{k}'')\delta_0^*(\vec{k_2}-\vec{k}'')\right>\\
%&\hat{\theta}.\left[\frac{\vec{k}-\vec{k'}}{|\vec{k}-\vec{k}'|^2}+\frac{\vec{k}'}{|\vec{k}'|^2}\right]\hat{\theta}.\left[\frac{\vec{k_2}-\vec{k}''}{|\vec{k_2}-\vec{k}''|^2}+\frac{\vec{k}''}{|\vec{k}''|^2}\right]
\end{aligned}
\end{equation}

Now, using Wick's theorem for gaussian fields gives us

\begin{equation}
\begin{aligned}
&<\delta_{21}(\textbf{k}_{q_{21}}-\textbf{k}_{v_{21}}){v}_{21}^{\parallel}(\textbf{k}_{v_{21}}) \delta^*_{ksz}(\textbf{k}_{q_{ksz}}-\textbf{k}_{v_{ksz}}){v}^{*\parallel}_{ksz}(\textbf{k}_{v_{ksz}})>\\
&=
(2\pi)^6 (P_{\delta_{21} \delta_{ksz}}(\textbf{k}_{q_{21}}-\textbf{k}_{v_{21}}) P_{v_{21}^\parallel v_{ksz}^\parallel}(\textbf{k}_{v_{21}})\delta^3(\textbf{k}_{v_{21}}-\textbf{k}_{v_{ksz}})\delta^3(\textbf{k}_{q_{21}}-\textbf{k}_{v_{21}}-\textbf{k}_{q_{ksz}}+\textbf{k}_{v_{ksz}})\\
&+P_{\delta_{21} v_{ksz}^\parallel}(\textbf{k}_{q_{21}}-\textbf{k}_{v_{21}})P_{\delta_{ksz} v_{21}^\parallel}(\textbf{k}_{v_{21}})\delta^3(\textbf{k}_{q_{21}}-\textbf{k}_{v_{21}}-\textbf{k}_{v_{ksz}})\delta^3(\textbf{k}_{q_{ksz}}-\textbf{k}_{v_{ksz}}-\textbf{k}_{v_{21}}))
\end{aligned}
\end{equation}

We collapse the integrals. Looking at the first term, we set $\textbf{k}_{v_{21}}=\textbf{k}_{v_{ksz}}$ and $\textbf{k}_{{21}}=\textbf{k}_{q_{ksz}}$. The second term allows us to set $\textbf{k}_{v_{ksz}}=\textbf{k}_{{21}}-\textbf{k}_{v_{21}}$ and again that leaves $\textbf{k}_{{21}}=\textbf{k}_{q_{ksz}}$.

This gives the simplified expression for the bispectrum

\begin{equation}
\begin{aligned}
B^{p_{21}p_e}(\textbf{l}_{21},y_{21},z_{21})=&\frac{T_{rad}}{8\pi^3c^2}\frac{D^2(z_{21})}{\chi^2(z_{21}) r(z_{21})} F(\textbf{k}_{q_{21}})
\int d\chi_{ksz} g(\chi_{ksz}) D^2(z_{ksz}) e^{-ik_{21}^\parallel \chi_{ksz}}\\
\end{aligned}
\end{equation}

where we define 

\begin{equation}
F(\textbf{k}_{q_{21}})=\int d^3\textbf{k}_{v_{21}} P_{\delta_{21} \delta_{ksz}}(k_{\delta_{21}}) P_{v_{21} v_{ksz}}(k_{v_{21}})+P_{\delta_{21} v_{ksz}}(k_{\delta_{21}}) P_{v_{21} \delta_{ksz}}(k_{v_{21}})
\end{equation}

with the vector $\textbf{k}_{q_{21}}=(k_{21}^{\parallel},k_{21}^{\perp})=\left(\frac{y}{r(z_{21})},\frac{l}{\chi(z_{21})}\right)$.\\

The full expression is then

\begin{equation}
\begin{aligned}
B^{p_{21}p_e}(\vec{l},y_{21},z_{21})&=\frac{T_{rad}x}{4\pi^2 c}\frac{\sigma_T \rho_{g0}}{\mu_e m_p}\int d z_{21}\frac{\bar{T}^2(z_{21})rsd^2f(z_{21})D(z_{21})^2 H(z_{21}) }{\chi^2(z_{21})r(z_{21})(1+z_{21})} G(k_{21}^\parallel,k_{21}^\perp)F(k_{21}^\parallel)\\
&=\frac{T_{rad}x}{4\pi^2 c^2}\frac{\sigma_T \rho_{g0}}{\mu_e m_p}\int d \chi_{21}\frac{\bar{T}^2(z_{21})rsd^2f(z_{21})D^2(z_{21}) H^2(z_{21}) }{\chi^2(z_{21})r(z_{21})(1+z_{21})} G(k_{21}^\parallel,k_{21}^\perp)F(k_{21}^\parallel)
\end{aligned}
\end{equation}

where we define

\begin{subequations}
\begin{equation}
F(k_{21}^\parallel)=\int d\chi_{kSZ} F(\chi_{kSZ}) e^{-ik_{21}^\parallel \chi_{kSZ}}
\end{equation}
\begin{equation}
F(\chi_{kSZ})=\frac{1}{c}f (z_{kSZ}) D^2(z_{kSZ})(1+z_{kSZ})H(z_{kSZ})e^{-\tau(z_{kSZ})}
\end{equation}
\end{subequations}

and 

\begin{equation}
G(k_{21}^\parallel,k_{21}^\perp)=\int d k_{v_{21}}^{\perp} \int dk_{v_{21}}^{\parallel} k_{v_{21}}^{\perp} P_{\delta_{m} \delta_m}(k_{v_{21}}) P_{\delta_{m} \delta_m}(k_{\delta_{21}})\left( \frac{\mu^2_{k_{v_{21}}}}{k^2_{v_{21}}}+\frac{\mu_{k_{v_{21}}} \mu_{k_{\delta_{21}}}}{k_{v_{21}} k_{\delta_{21}}} \right)
\end{equation}


which uses the dimensionless quantity $\mu_{k}=\frac{k^\parallel}{k}$.

The order of magnitude calculation is 

\begin{equation}
\begin{aligned}
B^{p_{21}p_e}(\vec{l},y_{21},z_{21})=& 10^{-8}  \mu K^3 \frac{T_{rad}}{10^6 \mu K}\frac{40}{4\pi^2}\frac{10^{-14}Mpc s^{-1}}{c}\frac{\bar{T}^2}{300^2 \mu K^2}\frac{f(z_{21})}{0.5}\frac{H(z_{21})}{H_0 s^{-1}}\frac{D(z_{21})^2}{0.5^2}\frac{2}{(1+z_{21})}\frac{10^4 Mpc}{r(z_{21})}  \\
&\frac{5000^2 Mpc^2}{\chi^2(z_{21})}\left(\frac{(b_{HI}+f(z_{21})\mu_k^2)}{1+0.5\times 0.5^2}\right)^2 \frac{x}{1}\frac{\sigma_T}{(10^{-74}) Mpc^2} \frac{\rho_{g0}}{(10^{42}) g Mpc^{-3}}\frac{10^{-24} g}{\mu_e m_p}  \frac{F(k^\parallel_{k_{21}})}{2}\\
&\int \frac{dk^\perp_{v_{21}}}{1 Mpc^{-1}} \frac{k^\perp_{v_{21}}}{1 Mpc^{-1}} \int \frac{dk^\parallel_{v_{21}}}{0.15 Mpc^{-1}} \frac{P^2_{\delta_{e} \delta_e}}{ 10^6 Mpc^6}\left(\frac{\mu^2_{k_{v_{21}}}}{1} \frac{1 Mpc^{-2}}{k^2_{v_{21}}} +  \frac{\mu_{k_{v_{21}}} \mu_{k_{\delta_{21}}}}{1}\frac{1 Mpc^{-2}}{k_{v_{21}} k_{\delta_{21}}} \right)
\end{aligned}
\end{equation}



\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/F_chi_ksz_full}
	\caption{$F(\chi_{ksz})$ plotted against $\chi_{ksz}$}
	\label{fig:fchikszfull}
\end{figure}


\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/F_kpar_full_relevant_kpar_scales}
	\caption{$F(k_{21}^\parallel)$ plotted against $k_{21}^\parallel$}
	\label{fig:fkparfullrelevantkparscales}
\end{figure}

\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/2D_bispec_fourier_z_1_deltaz_pt2_with_z21_int_full_zksz_int}
	\caption{Bispectrum using the fourier transform, with the full ksz redshift integral from now to reionization, and with integration over 21 cm redshift bins of 0.4, at $z=1.26$. We integrate $k^\perp_{v_{21}}$ from $10^{-4}$ to $1$ and integrate $k^\parallel_{v_{21}}$ from $10^{-6}$ to $0.15$.}
	\label{fig:2dbispecfourierz1deltazpt2withz21intfullzkszint}
\end{figure}

The equation for the $C_l^{p_{21},tot}$ is 


\begin{equation}
\begin{aligned}
C_l^{p_{21}}(y,z_1=z_2)+N_l^{p_{21}}(y,z_1=z_2)&=\frac{1}{c^2}\int d^3\vec{k}'\frac{1}{\chi_1^2 r_1} D_1^2 D_2^2\hat{\theta}.\hat{k'}\\
&[\hat{\theta}.\hat{k}'(P^{\delta_{21}\delta_{21}}(k_1-k')+N^{\delta_{21}\delta_{21}}(k_1-k'))(P^{v_{21}v_{21}}(k')+N^{v_{21}v_{21}}(k'))\\
&+\hat{\theta}.\hat{K}(P^{\delta_{21}v_{21}}(k_1-k')+N^{\delta_{21}v_{21}}(k_1-k'))(P^{\delta_{21}v_{21}}(k')+N^{\delta_{21}v_{21}}(k'))]\\
\end{aligned}
\end{equation}

 The full integral contributions from the $P^{\delta \delta}P^{vv}$ and $P^{\delta v}P^{\delta v}$ terms are written as
 
 \begin{equation}
 \begin{aligned}
 I_{l}^{PP} (y,z_1) % &=\frac{1}{16 \pi^3 c^2} \frac{\bar{T}_1^2 f_1 (rsd(z_1))^2 H_1 D_1^2 }{\chi_1^2 (1+z_1)} \frac{\bar{T}_2^2 f_2 (rsd(z_2))^2 H_2 D_2^2 }{ 1+z_2} \int dk_{\parallel}
 %\int dk' k'^2 \\
 %&  \int_{-1}^{1} dU [\hat{\theta}.\hat{k}']^2 P_{\delta_e \delta_e} (K)\frac{\chi_1^2 r_1 N_{\delta_e \delta_e}(k_{\perp}')}{k'^2}\\
 % 
 &=\frac{1}{4 \pi^2 c^2} \frac{\bar{T}_1^2 f_1 (rsd(z_1))^2 H_1 D_1^2  }{(1+z_1)\chi(z_1)^2 r(z_1)} \int dz'_{21}\frac{\bar{T}_2^2 f_2 (rsd(z_2))^2 H_2 D_2^2 }{ 1+z_2} 
 \int_{10^{-6}}^{.15} dk^\parallel_{v_{21}} \\
 &  \int_{10^{-4}}^1 dk^\perp_{v_{21}} k^\perp_{v_{21}}   P_{\delta_{m} \delta_m}(k_{v_{21}}) P_{\delta_{m} \delta_m}(k_{\delta_{21}})\left( \frac{\mu^2_{k_{v_{21}}}}{k^2_{v_{21}}}+\frac{\mu_{k_{v_{21}}} \mu_{k_{\delta_{21}}}}{k_{v_{21}} k_{\delta_{21}}} \right)\\
 \end{aligned}
 \end{equation}
 
 
 
 The order of magnitude calculation is 
 
 \begin{equation}
 \begin{aligned}
Z^{PP}(z_{21}) &= 4.53 \times 10^{-26} \frac{\mu K^2 s^{-1}}{Mpc^3} \frac{\bar{T}^2(z_{21})}{250^2 \mu K^2}\frac{f(z)}{1}\frac{H(z)}{H_0 s^{-1}}\frac{D(z)^2}{0.5^2}\frac{2}{(1+z)} \\
& \left(\frac{(b_{HI}+f(z)\mu_k^2)}{1+1\times 0.1^2}\right)^2 \left(\frac{5 \times 10^3 Mpc^2}{\chi(z)}\right)^2\frac{10^4 Mpc}{r(z)} 
\end{aligned}
 \end{equation}
 
 \begin{equation}
 \begin{aligned}
Z'^{PP}(z'_{21}) & =Z^{PP}(z'_{21})  \\
&= 9\times10^{-11} \mu K^2 s^{-1} \frac{Z^{PP}(z'_{21})}{4.53 \times 10^{-26}} \frac{\chi(z'_{21}) r(z'_{21})}{2 \times 10^{15}} 
\end{aligned}
 \end{equation}
 
 
 \begin{equation}
 \begin{aligned}
 I_{l}^{PP} (y,z_1)=& 10^{-5}  \mu K^4 \frac{50}{4\pi^2}\frac{10^{-28}Mpc^2 s^{-2}}{c^2} \frac{Z^{PP}(z_{21})}{4.53 \times 10^{-26} \frac{\mu K^2 s^{-1}}{Mpc^3}} \int \frac{d z'_{21}}{0.4} \frac{Z'^{PP}(z'_{21})}{9\times10^{-11} \mu K^2 s^{-1}}\int \frac{dk^\perp_{v_{21}}}{1 Mpc^{-1}}\\
 & \frac{k^\perp_{v_{21}}}{1 Mpc^{-1}} \int \frac{dk^\parallel_{v_{21}}}{0.15 Mpc^{-1}} \frac{P_{\delta_{m} \delta_m}(k_{v_{21}}) P_{\delta_{m} \delta_m}(k_{\delta_{21}})}{ 10^6 Mpc^6}\left(\frac{\mu^2_{k_{v_{21}}}}{1} \frac{1 Mpc^{-2}}{k^2_{v_{21}}} +  \frac{\mu_{k_{v_{21}}} \mu_{k_{\delta_{21}}}}{1}\frac{1 Mpc^{-2}}{k_{v_{21}} k_{\delta_{21}}} \right)
 \end{aligned}
 \end{equation}
 
 The full integral contributions from the $P^{\delta \delta}N^{vv}$, $P^{vv}N^{\delta \delta}$ and two $P^{\delta v}N^{\delta v}$ terms are written as
 
 \begin{equation}
 \begin{aligned}
 I_{l}^{PN} (z_1,z_2) % &=\frac{1}{16 \pi^3 c^2} \frac{\bar{T}_1^2 f_1 (rsd(z_1))^2 H_1 D_1^2 }{\chi_1^2 (1+z_1)} \frac{\bar{T}_2^2 f_2 (rsd(z_2))^2 H_2 D_2^2 }{ 1+z_2} \int dk_{\parallel}
 %\int dk' k'^2 \\
 %&  \int_{-1}^{1} dU [\hat{\theta}.\hat{k}']^2 P_{\delta_e \delta_e} (K)\frac{\chi_1^2 r_1 N_{\delta_e \delta_e}(k_{\perp}')}{k'^2}\\
 % 
 &=\frac{1}{16 \pi^3 c^2} \frac{\bar{T}_1 f_1 (rsd(z_1)) H_1 D_1 r_1 }{1+z_1} \frac{\bar{T}_2 f_2 (rsd(z_2)) H_2 D_2 }{ 1+z_2} \int dk_{\parallel}
 \int_{10^{-6}}^{1} dk'k'^2\\
 &  \int_{-1}^{1} dU [\hat{\theta}.\hat{k}'] \left( \frac{[\hat{\theta}.\hat{k}']}{k'^2}P_{\delta_e \delta_e} (K)  N_{\delta_e \delta_e}(k_{\perp}')+\frac{[\hat{\theta}.\hat{k}']}{k'^2}P_{\delta_e \delta_e} (k')  N_{\delta_e \delta_e}(K_{\perp})\right.\\
 &\left.+\frac{[\hat{\theta}.\hat{K}]}{K k'}P_{\delta_e \delta_e} (k')  N_{\delta_e \delta_e}(K_{\perp})+\frac{[\hat{\theta}.\hat{K}]}{K k'}P_{\delta_e \delta_e} (K)  N_{\delta_e \delta_e}(k'_{\perp}) \right)\\
 \end{aligned}
 \end{equation}
 
 The order of magnitude calculation is 
 
 \begin{equation}
 \begin{aligned}
 I_{l}^{PN} (z_1=z_2=z)=& 10^{-3}  \mu K^4 \frac{500}{16\pi^3}\frac{10^{-28}Mpc^2 s^{-2}}{c^2}\frac{\bar{T}^2}{300^2 \mu K^2}\frac{f(z)^2}{0.5^2}\frac{H(z)^2}{H_0 s^{-2}}\frac{D(z)^2}{0.5^2}\frac{4}{(1+z)^2}  \left(\frac{(b_{HI}+f(z)\mu_k^2)}{1+0.5\times 0.5^2}\right)^2 \\
 &\frac{r(z)}{10^4 Mpc} \int \frac{dk_{\parallel}}{10^{-1}Mpc^{-1}}
 \int_{10^{-10}}^{10} \frac{dk'}{10 Mpc^{-1}} \frac{k'^2}{100 Mpc^{-2}} \int_{-1}^1 \frac{dU}{1} \frac{[\hat{\theta}.\hat{k}']}{1}\\
 &
 \left(\left(\frac{[\hat{\theta}.\hat{k}']}{1} \frac{100 Mpc^{-2}}{k'^2}\frac{P_{\delta_{e} \delta_e}}{10^3 Mpc^3} \frac{N_{\delta_{e} \delta_e}}{ 0.1 \mu K^2}\right)^2 +  \left(\frac{[\hat{\theta}.\hat{K}]}{1}\frac{100 Mpc^{-2}}{k'K} \frac{P_{\delta_{e} \delta_e}}{10^3 Mpc^3} \frac{N_{\delta_{e} \delta_e}}{ 0.1 \mu K^2}\right)^2 \right)
 \end{aligned}
 \end{equation}
 

 
 The full integral contributions from the $N^{\delta \delta}N^{vv}$ and $N^{\delta v}N^{\delta v}$ terms are written as
 
 \begin{equation}
 \begin{aligned}
 I_{l}^{NN} (z_1,z_2) % &= \frac{1}{16 \pi^3 c^2}  \frac{f_1  H_1 }{\chi_1^2(1+z_1)}  \frac{f_2  H_2 }{1+z_2} \int dk_{\parallel} \int dk' k'^2 \\
 %&  \int_{-1}^{1} dU [\hat{\theta}.\hat{k}']^2 \chi_1^2 r_1 N_{\delta_e \delta_e} (K)\frac{\chi_1^2 r_1 N_{\delta_e \delta_e}(k_{\perp}')}{k'^2}\\
 &= \frac{1}{16 \pi^3 c^2}  \frac{f_1  H_1 \chi_1^2 r_1^2}{(1+z_1)}  \frac{f_2  H_2 }{1+z_2} \int dk_{\parallel}\int_{10^{-6}}^{1} dk' k'^2 \\
 &  \int_{-1}^{1} dU [\hat{\theta}.\hat{k}']  [\hat{\theta}.\hat{k}']N_{\delta_e \delta_e} (k_{\perp}')  N_{\delta_e \delta_e}(K_{\perp})\left(\frac{[\hat{\theta}.\hat{k}']}{k'^2}+\frac{[\hat{\theta}.\hat{K}]}{K k'}\right)\\
 \end{aligned}
 \end{equation}
 
 
 The order of magnitude calculation is 
 
 \begin{equation}
 \begin{aligned}
 I_{l}^{NN} (z_1=z_2=z)=& 10^{-3} \mu K^4 \frac{500}{16\pi^3}\frac{10^{-28}Mpc^2 s^{-2}}{c^2}\frac{f(z)^2}{0.5^2}\frac{H(z)^2}{H_0 s^{-2}}\frac{4}{(1+z)^2} \\
 &\frac{\chi^2(z)r(z)}{10^7 Mpc} \int \frac{dk_{\parallel}}{10^{-1}Mpc^{-1}}
 \int_{10^{-10}}^{10} \frac{dk'}{10 Mpc^{-1}} \frac{k'^2}{100 Mpc^{-2}} \int_{-1}^1 \frac{dU}{1} \frac{[\hat{\theta}.\hat{k}']}{1}\\
 &
 \left(\frac{[\hat{\theta}.\hat{k}']}{1} \frac{100 Mpc^{-2}}{k'^2}\frac{N_{\delta_e \delta_e}}{0.1 \mu K^2} \frac{N_{\delta_{e} \delta_e}}{ 0.1 \mu K^2} +  \frac{[\hat{\theta}.\hat{K}]}{1}\frac{100 Mpc^{-2}}{k'K} \frac{N_{\delta_{e} \delta_e}}{0.1 \mu K^2} \frac{N_{\delta_{e} \delta_e}}{ 0.1 \mu K^2} \right)
 \end{aligned}
 \end{equation}
 


\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/2D_sigma_sqrt_z_1pt26_deltaz_pt2_zksz_full_integral_over_z21}
	\caption{Sigma for $z=1.26$ with the full ksz redshift integral from now to reionization, and with integration over 21 cm redshift bins of 0.4.}
	\label{fig:2dsigmasqrtz1pt26deltazpt2zkszfullintegraloverz21}
\end{figure}


\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/optimal_SN_2D_bispec_z_2pt26_deltaz_pt2_integrated_over_redshift_kp_perp_1_kp_par_pt15_zksz_full}
	\caption{Signal-to-noise with the full ksz redshift integral from now to reionization, and with integration over 21 cm redshift bins of 0.4, at $z=1.26$.}
	\label{fig:optimalsn2dbispecz2pt26deltazpt2integratedoverredshiftkpperp1kpparpt15zkszfull}
\end{figure}

\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/optimal_cumSN_2D_bispec_z_2pt26_deltaz_pt2_integrated_over_redshift_kp_perp_1_kp_par_pt15_zksz_full}
	\caption{Cumulative signal-to-noise with the full ksz redshift integral from now to reionization, and with integration over 21 cm redshift bins of 0.4, at $z=1.26$.}
	\label{fig:optimalcumsn2dbispecz2pt26deltazpt2integratedoverredshiftkpperp1kpparpt15zkszfull}
\end{figure}


%\begin{equation}
%\begin{aligned}
%C_l=&\frac{T_{rad}}{c}\frac{\bar{T}(z_i)D(z_i)(b+f\mu_k^2)}{\chi^2(z_i)r_\nu(z_i)}\left(\frac{a(z_i)\dot{D}(z_i)D(z_i)}{2{D_0}^2}\right)\int d\chi_2 {g}(\chi_2) \left(\frac{a(\chi_2)\dot{D}(\chi_2)D(\chi_2)}{2{D_0}^2}\right)\\
%&\int \frac{dk_{\parallel}}{2\pi}e^{ik_{\parallel} (\chi(z_i)-\chi_2)}\int \frac{d^2k'_\perp}{(2\pi)^2}\frac{dk'_\parallel}{2\pi}
%P(k')P(|\vec{k}-\vec{k}'|)\left(\hat{\theta}.\left[\frac{\vec{k}-\vec{k'}}{|\vec{k}-\vec{k}'|^2}+\frac{\vec{k}'}{|\vec{k}'|^2}\right]\hat{\theta}.\left[\frac{\vec{k}-\vec{k'}}{|\vec{k}-\vec{k}'|^2}+\frac{\vec{k}'}{|\vec{k}'|^2}\right]\right)\\
%&=\frac{T_{rad}}{c}\frac{\bar{T}(z_i)D(z_i)(b+f\mu_k^2)}{\chi^2(z_i)r_\nu(z_i)}\left(\frac{a(z_i)\dot{D}(z_i)D(z_i)}{2{D_0}^2}\right)\int d\chi_2 {g}(\chi_2) \left(\frac{a(\chi_2)\dot{D}(\chi_2)D(\chi_2)}{2{D_0}^2}\right)\\
%&\int \frac{dy}{2\pi r_\nu}e^{iy (\chi(z_i)-\chi_2)/r_\nu}\int \frac{d^2k'_\perp}{(2\pi)^2}\frac{dk'_\parallel}{2\pi}
%P(k')P(|\vec{k}-\vec{k}'|)\left(\hat{\theta}.\left[\frac{\vec{k}-\vec{k'}}{|\vec{k}-\vec{k}'|^2}+\frac{\vec{k}'}{|\vec{k}'|^2}\right]\hat{\theta}.\left[\frac{\vec{k}-\vec{k'}}{|\vec{k}-\vec{k}'|^2}+\frac{\vec{k}'}{|\vec{k}'|^2}\right]\right)
%\end{aligned}
%\end{equation}

\clearpage
Let us consider a diagram showing the vectors for the momentum, density and velocity fields. 

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{"../python_scripts/kSZ_21cm_signal/k vec non limber v2"}
	\caption{Diagram showing the different vectors.}
	\label{fig:k-vec-non-limber-v2_2}
\end{figure}


where $\mu_k=\frac{k_\parallel}{k}$. In the diagram, $\gamma$ is the angle of elevation of $\vec{k}$ from the xy plane. The vector $\vec{k}'$ is an angle $\phi$ from $\vec{k}$ in the line-of-sight direction. We assume zero polar angle between the two vectors. For each $k$, we integrate over $d^3\vec{k}'$, which we write in spherical coordinates, with polar angle, $\Phi$ and azimuthal angle, $\Theta$. We have $\int d^3\vec{k}'=\int_0^{2\pi} \int_0^\pi \int k'^2 sin\Theta dk' d\Theta d\Phi$. Substituting $cos\Theta=U$ gives $\int d^3\vec{k}'=-2\pi\int_1^{-1} \int k'^2 dk' dU$ so that $\int d^3\vec{k}'=2\pi\int_{-1}^{1} \int k'^2 dk' dU$. We also define $\zeta=cos\phi$. 
Using this diagram we obtain the expressions for $\hat{\theta}.\hat{k}'$, $\hat{\theta}.\hat{K}$ and $K$.



\begin{subequations}\label{k' in los}
	\begin{equation}
	\hat{\theta}.\hat{k}'=cos\Theta=U=\frac{k'_\parallel}{k'}
	\end{equation}
	\begin{equation}\label{K in los}
	\hat{\theta}.\hat{K}=-sin(\alpha-\gamma)=-\left[\frac{k'}{K}\frac{k_{\perp}}{k}\sqrt{1-\zeta^2}-\frac{(k^2-\vec{k}.\vec{k}')}{Kk}\mu_k\right]
	\end{equation}
	\begin{equation}
	K^2=k^2+k'^2-2\vec{k}.{k}'=k^2+k'^2-2(k_{\perp} k'_{\perp}+k_{\parallel}k'_{\parallel}\zeta)=k^2+k'^2-2(k_{\perp}k'\sqrt{1-U^2}+k_{\parallel}k'U\zeta)
	\end{equation}
\end{subequations}




 We define $\zeta$ in terms of $U$, $\zeta=cos\phi=cos(90-(\gamma+\Theta))=sin(\gamma+\Theta)=sin\gamma cos\Theta cos\gamma sin\Theta=\frac{k_\parallel}{k}U+\frac{k_\perp}{k}\sqrt{1-U^2}$.



We can write this using $d\chi=c dz/H(z)$ 

\begin{equation}
\begin{aligned}
B^{p_{21}p_e}(\vec{l},y,z_{21})&=\frac{T_{rad}x}{4\pi^2 c}\frac{\sigma_T \rho_{g0}}{\mu_e m_p}\frac{\bar{T}^2(z_{21})rsd^2f(z_{21})D(z_{21})^2 H(z_{21}) }{\chi^2(z_{21})r(z_{21})(1+z_{21})} [\int d z_{kSZ} f (z_{kSZ}) D^2(z_{kSZ})(1+z_{kSZ}) \\
&e^{-\tau(z_{kSZ})}e^{-ik_\parallel \chi(z_{kSZ})}]\int d k'_{\perp} \int dk'_{\parallel} k'_{\perp} P_{\delta_{m} \delta_m}(k') P_{\delta_{m} \delta_m}(K)[\hat{\theta}.\hat{k}']\left( \frac{[\hat{\theta}.\hat{k}']}{k'^2}+\frac{[\hat{\theta}.\hat{K}]}{k' K} \right)
\end{aligned}
\end{equation}

where $k=\sqrt{l^2/\chi^2(z_{21})+y^2/r^2(z_{21})}$.\\

We want to set $e^{-ik_\parallel \chi(z_{kSZ})}=cos(k_\parallel \chi(z_{kSZ})=1$ which would require integrating over small kSZ redshifts. Using redshifts of $\Delta_z=0.01$ centred at $z=1.26$ give $z_{min}=z$ and $z_{max}=z+ \Delta_z$ do not cause high oscillations of the $k_\parallel=0.15 Mpc^{-1}$ mode which is the highest that we consider for linear scales, allowing us to set the cos function equal to 1 in the kSZ redshift integrand. \\%Using zmin=z-delta_z/2 and zmax=z+delta_z/2 doesn't make the cos()=1 approximation very accurate 
\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/2D_bispec_z_1pt26_deltaz_pt005}
	\caption{2D bispectrum for $\Delta_z=0.01$.}
	\label{fig:2dbispecz1pt26deltazpt005}
\end{figure}

Returning again to the form of the bispectrum equation expressed as an integral over $\chi_{kSZ}$, we notice that the form of this equation is a fourier transform. Thus, we can take the fourier transform of the kSZ integral giving


\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/F_chi_ksz_delta_pt005}
	\caption{$F(\chi_{kSZ})$ plotted against $\chi_{kSZ}$}
	\label{fig:fchikszdeltapt005}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/F_kpar_delta_pt005}
	\caption{$F(k_\parallel)$ plotted against $k_\parallel$}
	\label{fig:fkpardeltapt005}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/F_kpar_delta_pt005_relevant_kpar_scales}
	\caption{$F(k_\parallel)$ plotted against $k_\parallel$ for the scales that we consider.}
	\label{fig:fkpardeltapt005relevantkparscales}
\end{figure}

\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/2D_bispec_fourier_z_1pt26_deltaz_pt005_and_below}
	\caption{2D bispectrum for a redshift bin $\Delta_z=0.01$ after taking the Fourier transform}
	\label{fig:2dbispecfourierz1pt26deltazpt005andbelow}
\end{figure}


\clearpage
\begin{equation}
\begin{aligned}
B^{p_{21}p_e}(\vec{l},y,z_1)=%&\frac{T_{rad}}{8\pi^3 c^2} D(z_1)^2\int d\chi_2 g(\chi_2)  D(z_2)^2\int dk_{\parallel}\frac{e^{ik_{\parallel} (\chi_1-\chi_2)}}{\chi_1^2}\int_{10^{-6}}^{1} dk' k'^2 \\
%& \int  dU [\hat{\theta}.\hat{k}']^2 P_{v_{21} v_e}(k') P_{\delta_{21} \delta_e}(K)+[\hat{\theta}.\hat{k}'][\hat{\theta}.\hat{K}] P_{\delta_{21} v_e}(k') P_{v_{21} \delta_e}(K)]\\
&=\frac{T_{rad}}{4\pi^2 c} x \left(\frac{\sigma_T \rho_{c0}}{\mu_e m_p}\right) \frac{\bar{T}^2 D_1^2 rsd^2 f_1 H_1 }{\chi_1^2 (1+z_1)} \int d z_2 e^{-\tau_2} f_2 (1+z_2)  \int_{10^{-6}}^{1} dk' k'^2 \\
&\int_{-1}^{1} dU  P_{\delta_{m} \delta_m}(k') P_{\delta_{m} \delta_m}(K)[\hat{\theta}.\hat{k}']\left( \frac{[\hat{\theta}.\hat{k}']}{k'^2}+\frac{[\hat{\theta}.\hat{K}]}{k' K} \right)\\
\end{aligned}
\end{equation}

\begin{equation}
\begin{aligned}
B_{l}^{p_{21}p_e}(z_1)=&\frac{T_{rad}}{8\pi^3 c^2} D(z_1)^2\int d\chi_2 g(\chi_2)  D(z_2)^2\int dk_{\parallel}\frac{e^{ik_{\parallel} (\chi_1-\chi_2)}}{\chi_1^2}\int_{10^{-6}}^{1} dk' k'^2 \\
& \int  dU [\hat{\theta}.\hat{k}']^2 P_{v_{21} v_e}(k') P_{\delta_{21} \delta_e}(K)+[\hat{\theta}.\hat{k}'][\hat{\theta}.\hat{K}] P_{\delta_{21} v_e}(k') P_{v_{21} \delta_e}(K)]\\
%&=\frac{T_{rad}}{8\pi^3 c} x \left(\frac{\sigma_T \rho_{c0}}{\mu_e m_p}\right) \frac{\bar{T}^2 D_1^2 rsd^2 f_1 H_1 }{\chi_1^2 (1+z_1)} \int d z_2 e^{-\tau_2} f_2 (1+z_2) \int dk_{\parallel} \int dk'_{\parallel} \\
%&\int dk'_{\perp}  P_{\delta_{e} \delta_e}(k') P_{\delta_{e} \delta_e}(K)[\hat{\theta}.\hat{k}']\left( \frac{[\hat{\theta}.\hat{k}']}{k'^2}+\frac{[\hat{\theta}.\hat{K}]}{k' K} \right)\\
=&\frac{T_{rad}}{8\pi^3 c^2} D(z_1)^2\int_{\chi(z_{min})}^{\chi(z_{max})} d\chi_2 g(\chi_2) \frac{D(z_2)^2}{\chi_1^2} \int_{10^{-6}}^{0.15} dk_{\parallel}\int_{10^{-6}}^{0.1} dk' k'^2 \\
& \int  dU [\hat{\theta}.\hat{k}']^2 P_{v_{21} v_e}(k') P_{\delta_{21} \delta_e}(K)+[\hat{\theta}.\hat{k}'][\hat{\theta}.\hat{K}] P_{\delta_{21} v_e}(k') P_{v_{21} \delta_e}(K)]\\
\end{aligned}
\end{equation}

Note that we can set $e^{ik_{\parallel} (\chi_1-\chi_2)}=1$ if $k_{\parallel} \frac{c}{H} \Delta_z \approx 0$ which, for $k_{\parallel} \le 0.15 Mpc^{-1}$, gives $\Delta_z \approx 0.003$. Then $z_{min}=z_c-0.0015$ and $z_{max}=z_c+0.0015$.

Without integrating over y, we have

\begin{equation}
\begin{aligned}
B_{l}^{p_{21}p_e}(y, z_1)=&\frac{T_{rad}}{4\pi^2 c^2} D(z_1)^2\int_{\chi(z_{min})}^{\chi(z_{max})} d\chi_2 g(\chi_2) \frac{D(z_2)^2}{\chi_1^2 r_1} \int_{10^{-6}}^{0.1} dk' k'^2 \\
& \int  dU [\hat{\theta}.\hat{k}']^2 P_{v_{21} v_e}(k') P_{\delta_{21} \delta_e}(K)+[\hat{\theta}.\hat{k}'][\hat{\theta}.\hat{K}] P_{\delta_{21} v_e}(k') P_{v_{21} \delta_e}(K)]\\
\end{aligned}
\end{equation}

Integrating over a single redshift bin width gives

\begin{equation}
\begin{aligned}
B_{l}^{p_{21}p_e}(y)=&\frac{T_{rad}}{4\pi^2 c^2} \int d z_1  D(z_1)^2\int_{\chi(z_{min})}^{\chi(z_{max})} d\chi_2 g(\chi_2) \frac{D(z_2)^2}{\chi_1^2 r_1} \int_{10^{-6}}^{0.1} dk' k'^2 \\
& \int  dU [\hat{\theta}.\hat{k}']^2 P_{v_{21} v_e}(k') P_{\delta_{21} \delta_e}(K)+[\hat{\theta}.\hat{k}'][\hat{\theta}.\hat{K}] P_{\delta_{21} v_e}(k') P_{v_{21} \delta_e}(K)]\\
\end{aligned}
\end{equation}

%back when I tried to consider integrating over two line of sight angles
 %with the substitution $\zeta_1(U)=\frac{k_\parallel}{k}U+\frac{k_\perp}{k}\sqrt{1-U^2}, U=cos\Theta$ and 
 %$\zeta_2(A)=\frac{k_\parallel}{k}A+\frac{k_\perp}{k}\sqrt{1-A^2}, A=cos(\Theta+a)$. We label $d \omega =cosa$

%Writing this with units and orders of magnitude

%\begin{equation}\label{Cl cross corr that I am coding}
%\begin{aligned}
%B_l^{p_{21}p_e}(z_i)&=\frac{100}{16 \pi^3} \frac{T_{rad}}{10^6 \mu K}\frac{10^{-14}Mpc s^{-1}}{c} \frac{x}{1}\frac{\sigma_T}{(10^{-74}) Mpc^2} \frac{\rho_{g0}}{(10^{42}) g Mpc^{-3}}\frac{(10^{-24}) g}{\mu_e m_p}  \\
%& \int \frac{dz}{10}  \frac{H(z_i)}{H_0 s^{-1}} \frac{D(z_i)^2}{0.5^2} \frac{D(z)^2}{0.5^2} \frac{f(z_i)}{0.5} \frac{f(z)}{0.5}
%\frac{(1+z)}{10} \int \frac{d\zeta}{2} \int \frac{dk'}{10 Mpc^{-1}} \\
%& \int \frac{dk_\parallel}{10^{-4} Mpc^{-1}}\frac{k'^2}{10^2 Mpc^{-1}}\frac{e^{-\tau(z)}}{e^{-\tau_r}}   \frac{P_{\delta_{21} \delta_e}(k')}{2\times 10^4 Mpc^3}\frac{P_{\delta_{21} \delta_e}(\sqrt{k^2+k'^2-2kk'\zeta})}{2\times 10^4 Mpc^3}\\&
%\frac{cos(k_\parallel(\chi_i-\chi))}{1}\frac{5000 Mpc^2}{\chi_i^2}\left(\frac{\mu_k\zeta}{10^{-5}}+\frac{l}{10^3}\frac{5000 Mpc}{\chi}\frac{10 Mpc^{-1}}{ k}\frac{\sqrt{1-\zeta^2}}{\sqrt{1-0.5^2}}\right)\\
%&\left[\frac{k_\parallel}{10^{-4}Mpc^{-1}} \frac{\zeta}{0.5} +\frac{l}{10^3}\frac{5000 Mpc}{\chi}\frac{\sqrt{1-\zeta^2}}{\sqrt{1-0.5^2}}\frac{k-2k'\zeta}{10 Mpc^{-1}}\frac{1 Mpc^{-2}}{k'^2(k^2+k'^2-2kk'\zeta)}+\right.\\
%&\left.\frac{k_\parallel}{10^{-4}Mpc^{-1}}\frac{1 Mpc^{-1}}{k'(k^2+k'^2-2kk'\zeta)}\right]
%=C_l^{p_{21}p_e}&=\frac{1}{16 \pi^3} T_{rad} x \bar{T}(b_{HI}+f\mu_k^2)\left(\frac{\sigma_T \rho_{c0}}{\mu_e m_p}\right) \int dk_\parallel \int \frac{dz}{H(z)} \int d\zeta \int k'^2 dk'  \left(\frac{H(z_i)}{1+z_i}\right)\left(\frac{H(z)}{1+z}\right) D(z_i)^2\\
%& D(z)^2 f(z_i) f(z) 
%(1+z)^2  e^{-\tau(z)}   P_{\delta_{21} \delta_e}(k')P_{\delta_{21} \delta_e}(\sqrt{k^2+k'^2-2kk'\zeta})I(k,k',\zeta,k_\parallel)cos(k_\parallel(\chi(z_i)-\chi(z)) 
%\end{aligned}
%\end{equation}


%\begin{figure}[h!]
%	\centering
%	\includegraphics[width=0.7\linewidth]{"../python_scripts/kSZ_21cm_signal/cross corr up to k' of 1e-2 and kpar of 2e-4"}
%	\caption{Cross correlation of 21 cm and OV spectra integrating up to $k'=10^{-2}$ Mpc$^{-1}$.}
%	\label{fig:cross-corr-up-to-k-of-1e-2-and-kpar-of-2e-4}
%\end{figure}


%Now, let's refer to equation \ref{cross corr non limber}. The expression in the first term $P_{\delta_{21} \delta_e}(\vec{K})P_{v_{21}v_e}(\vec{k}')=\frac{P_{\delta_{21} \delta_e}(\vec{K})P_{\delta_{21} \delta_e}(\vec{k}')}{k'^2}$ while the second term gives
%$P_{\delta_e v_{21}}(\vec{k}')P_{\delta_{21} v_e}(\vec{K})=\frac{P_{\delta_{21} \delta_e}(\vec{k}')P_{\delta_{21} \delta_e}(\vec{K})}{k'(|\vec{k}-\vec{k}'|)}$. Now, $\vec{k}'$ is the low k mode of the velocity field, $v_{21}$, whereas $\vec{k}-\vec{k}'$ is the high k mode of the density field, $\delta_{21}$. Thus, the second term in equation \ref{cross corr non limber} can be omitted. 

%\begin{figure}[h!]
%	\centering
%	\includegraphics[width=0.7\linewidth]{"../python_scripts/kSZ_21cm_signal/cross corr up to k' of 1e-2 and kpar of 2e-4 partial (without second term)"}
%	\caption{Cross correlation of 21 cm and OV spectra integrating up to $k'=10^{-2}$ Mpc$^{-1}$ after omission of the second term of equation \ref{cross corr non limber}.}
%	\label{fig:cross-corr-up-to-k-of-1e-2-and-kpar-of-2e-4-partial-without-second-term}
%\end{figure}


%\begin{figure}[h!]
%	\centering
%	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/bispec_z_1pt26_15Aug}
%	\caption{Full bispectrum}
%	\label{fig:bispecz1pt2615aug}
%\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/bispec_signal_z_1pt26_deltaz_pt003_kpmax_1_n_points_50}
	\caption{Bispectrum signal integrated over $k_\parallel$ at $z=1.26$ with redshift $\Delta_z=0.003$ integrated up to $k'=1 Mpc^{-1}$.}
	\label{fig:bispecsignalz1pt26deltazpt003kpmax1npoints50}
\end{figure}

\newpage
\subsection{Squeezed limit}

In the squeezed limit, we assume that $k'\ll k, K$. The amplitude of $\vec{K}$ is simplified as

\begin{equation}
|\vec{k}-\vec{k}'|=\sqrt{k^2+k'^2-2\vec{k}.\vec{k}'}=k\sqrt{1-\frac{2\vec{k}.\vec{k}'}{k^2}+\frac{k'^2}{k^2}}\simeq k\left(1-\frac{\vec{k}.\vec{k}'}{k^2}\right)
\end{equation}
where the last equality comes from the use of the taylor expansion.
Using this amplitude, the corresponding power spectrum is

\begin{equation}
P(|\vec{k}-\vec{k}'|)\simeq P(k-\frac{\vec{k}.\vec{k}'}{k}) \simeq P(k)-\frac{\vec{k}.\vec{k}'}{k}\frac{dP(k)}{dk}=P(k)\left(1-\frac{\vec{k}.\vec{k}'}{k^2}\frac{dlnP(k)}{dlnk}\right)
\end{equation}

We can consider the bispectrum and ignore the second term of the bispectrum equation since it is negligible for small $k'$. Applying the squeezed limit then gives


\begin{equation}
\begin{aligned}
B_{l}^{p_{21}p_e}(z_1)=&\frac{T_{rad}}{4\pi^2 c^2} \int_{\chi(z_{min})}^{\chi(z_{max})} d\chi_2 g(\chi_2)D(z_2)^2 \int_{10^{-6}}^{0.15} \frac{dk_{\parallel}}{2\pi}\frac{e^{ik_{\parallel} (\chi_1-\chi_2)}}{\chi_1^2} \int_{10^{-6}}^{0.1} dk' k'^2\int_{-1}^{1}  dU  \\
&[\hat{\theta}.\hat{k}'(U)]^2 P_{v_{21} v_e}(k') P_{\delta_{21} \delta_e}(k) \left(1-\frac{\zeta(U) k'}{k}\frac{dlnP_{\delta_{21} \delta_e}(k)}{dlnk}\right)\\
&\approx \frac{T_{rad}}{8\pi^2 c^2}\frac{D(z_1)^2}{\chi_1^2}\int_{\chi(z_{min})}^{\chi(z_{max})} d\chi_2 g(\chi_2)D(z_2)^2 \int_{10^{-6}}^{0.15} \frac{dk_{\parallel}}{2\pi}   \\
&\int_{10^{-6}}^{0.1} dk' k'^2\int_{-1}^{1}  dU[\hat{\theta}.\hat{k}'(U)]^2 P_{v_{21} v_e}(k') P_{\delta_{21} \delta_e}(k) \\
\end{aligned}
\end{equation}


with $k' \le 0.1 Mpc^{-1}$. 



The squeezed bispectrum expressed as a function of y is

\begin{equation}
\begin{aligned}
B_{l}^{p_{21}p_e}(y,z_1)=&\frac{T_{rad}}{4\pi^2 c^2} \frac{D(z_1)^2}{\chi_1^2 r_1}\int_{\chi(z_{min})}^{\chi(z_{max})} d\chi_2 g(\chi_2)D(z_2)^2  \int_{10^{-6}}^{0.1} dk' k'^2\int_{-1}^{1}  dU  \\
&[\hat{\theta}.\hat{k}'(U)]^2 P_{v_{21} v_e}(k') P_{\delta_{21} \delta_e}(k) \\
\end{aligned}
\end{equation}

The squeezed bispectrum equation after applying the window function over the 21 cm redshift is 

\begin{equation}
\begin{aligned}
B_{l}^{p_{21}p_e}(y)=&\frac{T_{rad}}{4\pi^2 c^2} \int d z_1\frac{D(z_1)^2}{\chi_1^2 r_1}\int_{\chi(z_{min})}^{\chi(z_{max})} d\chi_2 g(\chi_2)D(z_2)^2  \int_{10^{-6}}^{0.1} dk' k'^2\int_{-1}^{1}  dU  \\
&[\hat{\theta}.\hat{k}'(U)]^2 P_{v_{21} v_e}(k') P_{\delta_{21} \delta_e}(k) \\
\end{aligned}
\end{equation}

The exact expression that I am coding up is

\begin{equation}
\begin{aligned}
B_l(z_i,z)=&10^{-8} \mu K^2\frac{200}{(2\pi)^3}\frac{T_{rad}}{10^{6}\mu K}\frac{10^{-14}Mpc s^{-1}}{c}\frac{\bar{T}}{200 \mu K}\frac{f(z_i)}{0.5}\frac{H(z_i)}{H_0 s^{-1}}\frac{D(z_i)^2}{0.5^2}\frac{5000^2 Mpc^2}{\chi_i^2}\frac{2}{1+z_i} \frac{x}{1}
\\&\frac{\sigma_T}{(10^{-74}) Mpc^2} \frac{\rho_{g0}}{(10^{42}) g Mpc^{-3}}\frac{(10^{-24}) g}{\mu_e m_p} \frac{\Delta z}{10} \frac{f(z)}{0.5} \frac{D(z)^2}{0.5^2} \frac{(1+z)}{10} \frac{e^{-\tau(z)}}{e^{-\tau_r}}\int \frac{dk_{\parallel}}{10^{-1}Mpc^{-1}}\\
&  \frac{(b_{HI}+f(z_i)\mu_k^2)}{1+0.5\times 0.5^2}\int \frac{d\zeta}{2}\left[ \frac{\mu_k\zeta}{0.5\times 0.5}+\frac{l}{10^3}\frac{5000 Mpc}{\chi}\frac{1 Mpc^{-1}}{k}\frac{\sqrt{1-\zeta^2}}{\sqrt{1-0.5^2}}\right]\\
&\int \frac{dk'}{10}
\left(\frac{P_{\delta_{e} \delta_e}(k')}{10^3 Mpc^3} \frac{P_{\delta_{e} \delta_e}(k)}{ 10^3 Mpc^3}-\frac{\zeta}{0.5} \frac{k'}{0.1 Mpc^{-1}}\frac{dP_{\delta_{e} \delta_e}(k)}{ 10^3 Mpc^3}\frac{0.1 Mpc^{-1}}{dk}\right)
\end{aligned}
\end{equation}
where $\mu_k=\frac{k_\parallel}{k}$.\\ 



%\begin{figure}
%	\centering
%	\includegraphics[width=0.7\linewidth]{"../python_scripts/kSZ_21cm_signal/cross corr up to k' of 1e-2 and kpar of 2e-4 squeezed limit"}
%	\caption{Cross correlation of 21 cm and OV spectra integrating up to $k'=10^{-2}$ Mpc$^{-1}$ in the squeezed limit.}
%	\label{fig:cross-corr-up-to-k-of-1e-2-and-kpar-of-2e-4-squeezed-limit}
%\end{figure}

%\begin{figure}[h!]
%	\centering
%	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/squeezed_bispec_z_1_deltaz_pt3_diff_y_microK_topower_3}
%	\caption{Cross-correlation of the 21 cm signal and OV signal in the squeezed limit for different y, plotted for $z_i=z=1, \Delta_z=0.3$.}
%	\label{fig:squeezedbispecz1deltazpt3diffymicroktopower3}
%\end{figure}



\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/bispec_full_kp_1_squeezed_kp_pt1_z_1pt26_deltaz_pt003}
	\caption{Cross-correlation of the 21 cm signal and OV signal integrated over y, plotted for both the full signal and the squeezed limit at $z_i=z=1.26, \Delta_z=0.003$. We integrate up to $k'=1 Mpc^{-1}$ and $k'=0.1 Mpc^{-1}$ for the full and squeezed, respectively.}
	\label{fig:bispecfullkp1squeezedkppt1z1pt26deltazpt003}
\end{figure}




 A small check for the amplitude of the plot is to compare the angular power spectrum of the 21 cm momentum field in equation, to the 
OV signal in the redshift range of 0.8 to 1.1. The difference between the Limber OV signals integrated from $z=0.8$ to $z=6$ and $z=1.1$ to $z=6$ is plotted in figure  \ref{fig:squeezedbispecov21cmredshiftbin8e-111e-1-semilogy}, together with the 21 cm momentum autocorrelation and the squeezed bispectrum. 



%\begin{figure}[h!]
%	\centering
%	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/squeezed_bispec_OV_21_cm_z_1_deltaz_pt3}
%	\caption{The comparison is clearer in semilogy scale. It is clear that the amplitude of the squeezed bispectrum is equal to the product of the square roots of the other two signals. Note that the OV spectrum is in units of $\mu K^2$, the 21 cm momentum has units $\mu K^4$ and the squeezed bispectrum is in $\mu K^3$. }
%	\label{fig:squeezedbispecov21cmz1deltazpt3}
%\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/OV_bispec_p21_all_squeezed_z_1pt26_deltaz_pt1}
	\caption{All signals are plotted in the squeezed limit. It is clear that the amplitude of the squeezed bispectrum is equal to the product of the square roots of the other two signals. Note that the OV spectrum is in units of $\mu K^2$, the 21 cm momentum has units $\mu K^4$ and the bispectrum is in $\mu K^3$}
	\label{fig:ovbispecp21allsqueezedz1pt26deltazpt1}
\end{figure}


\newpage

\section{Cross correlation variance}

The homogenous bispectrum is written as

\begin{equation}\label{bispec simplified eqn no integral}
\begin{aligned}
B_{l}^{21-kSZ}(z_1)&=\left< p^{21}_{l}(z_1)p^{kSZ}_{l}\right>\\
&=\frac{-T_{rad}}{c}\int \frac{dk_{\parallel}}{2\pi}\frac{e^{ik_{\parallel} \chi_1}}{\chi_1^2}D_1^2\hat{\theta}.\hat{k}'\int \frac{d^3\vec{k}'}{(2\pi)^3}\left<\delta_{21}(\vec{k}-\vec{k}')v_{21}(\vec{k}')p_{kSZ}(l)\right>
\end{aligned}
\end{equation}

The variance of the cross power spectrum is

\begin{equation}\label{variance of cross}
\delta^2(\vec{l}-\vec{l}_2)(\sigma_{l}^{21-kSZ})^2=\left< B_{l}^{21-kSZ}B_{l_2}^{21-kSZ}\right>-\left<B_{l}^{21-kSZ}\right>\left<B_{l_2}^{21-kSZ}\right>
\end{equation}

%with 
%\begin{equation}
%\begin{aligned}
%B_{l}^{21-kSZ}(z_i)&=\int \frac{d^2\vec{l}_2}{(2\pi)^2}\left<p_{kSZ}(l)p_{21}(l_2)\right>\\
%&=\frac{-T_{rad}\bar{T}(z_i)}{c}\int \frac{d^2\vec{l}_2}{(2\pi)^2} \int \frac{dk_{2\parallel}}{2\pi}\frac{e^{ik_{2\parallel} \chi(z_i)}}{\chi(z_i)^2}D(z_i)^2(b_{HI}+f\mu_k^2)\\
%&\int \frac{d^3\vec{k}''}{(2\pi)^3}\hat{\theta}.\hat{k}''\left<p_{kSZ}(l)\delta_{21}(\vec{k_2}-\vec{k}'')v(\vec{k}'')\right>
%\end{aligned}
%\end{equation}

The first term is expressed as

\begin{equation}
\begin{aligned}
\left< B_{l}^{21-kSZ}(z_1)B_{l_2}^{21-kSZ}(z_2)\right>&=\frac{T_{rad}^2}{c^2}\int \frac{dk_{\parallel}}{2\pi}\int \frac{dk_{2\parallel}}{2\pi}\int \frac{d^3\vec{k}'}{(2\pi)^3}\int\frac{d^3\vec{k}''}{(2\pi)^3}\\
&\frac{e^{i(k_{\parallel}\chi(z_1)+k_{2\parallel} \chi(z_2))}}{\chi(z_1)^2\chi(z_2)^2} D(z_1)^2D(z_2)^2\hat{\theta}.\hat{k'}\hat{\theta}.\hat{k}''\\
&\left<\hat{p}_{kSZ}(\vec{l})\hat{\delta}_{21}(\vec{k}-\vec{k}')\hat{v}_{21}(\vec{k}')\hat{p}'_{kSZ}(\vec{l}_2)\hat{\delta}'_{21}(\vec{k}_2-\vec{k}'') \hat{v}'_{21}(\vec{k}'')\right> \\
\end{aligned}
\end{equation}
This expression leads to 6 possible terms which are obtained by splitting the six point function into two point functions, three point functions as well as the product of two point and four point functions, which are then further split into two point functions. Using the notation of $\hat{p}_{kSZ}=\hat{p}_{kSZ}(\vec{l})$, $\hat{p}'_{kSZ}=\hat{p}_{kSZ}(\vec{l}_2)$, $\hat{\delta}_{21}=\hat{\delta}_{21}(\vec{k}-\vec{k}')$, $\hat{\delta}'_{21}=\hat{\delta}_{21}(\vec{k}_2-\vec{k}'')$,
$\hat{v}_{21}=\hat{v}_{21}(\vec{k}')$, $\hat{v}'_{21}=\hat{v}_{21}(\vec{k}'')$.


\begin{equation}\label{bispec squared}
\begin{aligned}
\int \frac{d^2l_2}{(2\pi)^2}\left< B_{l}^{21-kSZ}B_{l_2}^{21-kSZ}\right>&=\int \frac{d^2l_2}{(2\pi)^2}\frac{T_{rad}^2}{c^2}\int \frac{dk_{\parallel}}{2\pi}\int \frac{dk_{2\parallel}}{2\pi}\int \frac{d^3\vec{k}'}{(2\pi)^3}\int\frac{d^3\vec{k}''}{(2\pi)^3}
\frac{e^{i(k_{\parallel}\chi(z_1)+k_{2\parallel} \chi(z_2))}}{\chi(z_1)^2\chi(z_2)^2}D(z_1)^2\\
&D(z_2)^2\hat{\theta}.\hat{k'}\hat{\theta}.\hat{k}''[\left<\hat{p}_{kSZ}\hat{p}'_{kSZ}\right>\left<\hat{\delta}_{21}\hat{\delta}'_{21}\right>\left<\hat{v}_{21}\hat{v}'_{21}\right>
+\left<\hat{p}_{kSZ}\hat{p}'_{kSZ}\right>\left<\hat{\delta}_{21}\hat{v}'_{21}\right>\left<\hat{\delta}'_{21}\hat{v}_{21}\right>\\
&+\left<\hat{p}_{kSZ}\hat{\delta}'_{21}\hat{v}'_{21}\right>\left<\hat{p}'_{kSZ}\hat{\delta}_{21}\hat{v}_{21}\right>
+\left<\hat{p}_{kSZ}\hat{\delta}'_{21}\hat{v}_{21}\right>\left<\hat{p}'_{kSZ}\hat{\delta}_{21}\hat{v}'_{21}\right>\\
&+\left<\hat{p}_{kSZ}\hat{\delta}_{21}\hat{v}'_{21}\right>\left<\hat{p}'_{kSZ}\hat{\delta}'_{21}\hat{v}_{21}\right>
+\left<\hat{p}_{kSZ}\hat{\delta}_{21}\hat{v}_{21}\right>\left<\hat{p}'_{kSZ}\hat{\delta}'_{21}\hat{v}'_{21}\right>\\
&+\left<\hat{p}_{kSZ}\hat{\delta}_{21}\hat{\delta}'_{21}\right>\left<\hat{p}'_{kSZ}\hat{v}_{21}\hat{v}'_{21}\right>
+\left<\hat{p}_{kSZ}\hat{v}_{21}\hat{v}'_{21}\right>\left<\hat{p}'_{kSZ}\hat{\delta}_{21}\hat{\delta}'_{21}\right>]\\
\end{aligned}
\end{equation}

The terms $\left<\hat{p}_{kSZ}\hat{\delta}_{21}\hat{\delta}'_{21}\right>\left<\hat{p}'_{kSZ}\hat{v}_{21}\hat{v}'_{21}\right>$ and $\left<\hat{p}_{kSZ}\hat{v}_{21}\hat{v}'_{21}\right>\left<\hat{p}'_{kSZ}\hat{\delta}_{21}\hat{\delta}'_{21}\right>$ are not useful in computing the squeezed bispectrum. This is because the correlation functions in the squeezed limit consists of a low \textit{k} $v_{21}$ mode, high \textit{k} $\delta_{21}$ field and high \textit{k} $p_{kSZ}$ field. Thus, the 4 expectation values previously mentioned cannot be used to construct a squeezed triangle. We compute these expressions for the full bispectrum case

Writing the expression for the $\left< p_{kSZ}\delta_{21}\delta_{21}\right>$, we have


\begin{equation}
\begin{aligned}
B_{l}^{\delta_{21} \delta_{21} p_e}(z_1)
=& \int \frac{d^2l_2}{(2\pi)^2}\int \frac{dk_{\parallel}}{2\pi}\frac{1}{\chi_1^2} \int \frac{d^3k'}{(2\pi)^3} <\delta_{21}(\vec{k},z_1)\delta_{21}(\vec{k}',z_1) p_{kSZ}(\vec{l}_2)>\\
=&\frac{T_{rad}}{c}D(z_1)^2\int \frac{d^2l_2}{(2\pi)^2} \int d\chi_2  {g}(\chi_2)D(z_2)^2 \int \frac{dk_{\parallel}}{2\pi}\frac{1}{\chi_1^2}\int \frac{dk_{2\parallel}}{2\pi}\frac{e^{-ik_{2\parallel} \chi_2}}{\chi_2^2} \\ 
& \int \frac{d^3k'}{(2\pi)^3}\int\frac{d^3k''}{(2\pi)^3}  <\delta_{21}(\vec{k})\delta_{21}(\vec{k}')  \delta^*_e(\vec{k_2}-\vec{k}'')[\hat{\theta}.\vec{v}^*_e(\vec{k}'')]>\\
=&\frac{T_{rad}}{c}D(z_1)^2 \int \frac{d^2l_2}{(2\pi)^2} \int d\chi_2  {g}(\chi_2) D(z_2)^2\int \frac{dk_{\parallel}}{2\pi}\frac{1}{\chi_1^2}\int \frac{dk_{2\parallel}}{2\pi}\frac{e^{-ik_{2\parallel} \chi_2}}{\chi_2^2} \int \frac{d^3k'}{(2\pi)^3}\\ 
&\int\frac{d^3k''}{(2\pi)^3}
[\hat{\theta}.\hat{k}''] (2\pi)^6 [P_{\delta_{21} \delta_e}(k) P_{\delta_{21} v_{e}}(k'')\delta^3(\vec{k}+\vec{k}_2-\vec{k}'')\delta^3(\vec{k}'+\vec{k}'')+\\
&P_{\delta_{21} \delta_e}(k') P_{\delta_{21} v_{e}}(k'')\delta^3(\vec{k}'+\vec{k}_2-\vec{k}'')\delta^3(\vec{k}+\vec{k}'')]\\
=&\frac{T_{rad}}{16 \pi^4 c}D(z_1)^2 \int d\chi_2  {g}(\chi_2) D(z_2)^2\int dk_{\parallel}\int d^3k'\frac{e^{-i(k_{\parallel}-k'_\parallel) \chi_2}}{\chi_1^2}
\\& [[\hat{\theta}.\hat{k}']P_{\delta_{21} \delta_e}(k) P_{\delta_{21} v_{e}}(k')+[\hat{\theta}.\hat{k}]
P_{\delta_{21} \delta_e}(k') P_{\delta_{21} v_{e}}(k)] \\
\end{aligned}
\end{equation}

Writing the expression for the $\left< p_{kSZ}v_{21}v_{21}\right>$, we have


\begin{equation}
\begin{aligned}
B_{l}^{v_{21} v_{21} p_e}(z_1)
=& \int \frac{d^2l_2}{(2\pi)^2}\int \frac{dk_{\parallel}}{2\pi}\frac{e^{ik_{\parallel} \chi_1}}{\chi_1^2} \int \frac{d^3k'}{(2\pi)^3} <\vec{v}_{21}(\vec{k},z_1)\vec{v}_{21}(\vec{k}',z_1) p_{kSZ}(\vec{l}_2)>\\
=&\frac{T_{rad}}{c^3}D(z_1)^2\int \frac{d^2l_2}{(2\pi)^2}\int \frac{dk_{\parallel}}{2\pi}  \frac{e^{ik_{\parallel} \chi_1}}{\chi_1^2}\int d\chi_2  {g}(\chi_2)D(z_2)^2\int \frac{dk_{2\parallel}}{2\pi}\frac{e^{-ik_{2\parallel} \chi_2}}{\chi_2^2} \\ 
& \int \frac{d^3k'}{(2\pi)^3}\int\frac{d^3k''}{(2\pi)^3}  <[\hat{\theta}.\vec{v}_{21}(\vec{k})][\hat{\theta}.\vec{v}_{21}(\vec{k}')]  \delta^*_e(\vec{k_2}-\vec{k}'')[\hat{\theta}.\vec{v}^*_e(\vec{k}'')]>\\
=&\frac{T_{rad}}{c^3}D(z_1)^2 \int \frac{d^2l_2}{(2\pi)^2} \int \frac{dk_{\parallel}}{2\pi}\frac{e^{ik_{\parallel} \chi_1}}{\chi_1^2}\int d\chi_2  {g}(\chi_2) D(z_2)^2 \int \frac{dk_{2\parallel}}{2\pi}\frac{e^{-ik_{2\parallel} \chi_2}}{\chi_2^2} \int \frac{d^3k'}{(2\pi)^3}\\ 
&\int\frac{d^3k''}{(2\pi)^3}[\hat{\theta}.\hat{k}][\hat{\theta}.\hat{k}']
[\hat{\theta}.\hat{k}''] (2\pi)^6 [P_{v_{21} \delta_e}(k) P_{v_{21} v_{e}}(k'')\delta^3(\vec{k}+\vec{k}_2-\vec{k}'')\delta^3(\vec{k}'+\vec{k}'')\\
&+P_{v_{21} v_e}(k') P_{v_{21} \delta_{e}}(\vec{k}_2-\vec{k}'')\delta^3(\vec{k}'+\vec{k}_2-\vec{k}'')\delta^3(\vec{k}+\vec{k}'')]\\
=&\frac{T_{rad}}{16 \pi^4 c^3}D(z_1)^2 \int d\chi_2  {g}(\chi_2) D(z_2)^2\int \frac{d^3k'}{(2\pi)^3}\frac{e^{-2ik'_\parallel \chi_2}}{\chi_1^2} [\hat{\theta}.\hat{k}][\hat{\theta}.\hat{k}']\\
&
[[\hat{\theta}.\hat{k}']P_{v_{21} \delta_e}(k) P_{v_{21} v_{e}}(k')+[\hat{\theta}.\hat{k}]P_{v_{21} v_e}(k) P_{v_{21} \delta_e}(k')] \\
\end{aligned}
\end{equation}


Now, we rewrite

\begin{subequations}
\begin{equation}
\left<\hat{p}_{kSZ}(\vec{l})\hat{p}_{kSZ}(\vec{l}_2)\right>=(2\pi)^2 \delta^2(\vec{l}+\vec{l}_2)(C^{p_{kSZ}p_{kSZ}}_{l}+N^{p_{kSZ}p_{kSZ}}_{l})
\end{equation}

\begin{equation}
\left<\hat{\delta}_{21}(\vec{k}-\vec{k'})\hat{\delta}_{21}(\vec{k}_2-\vec{k''})\right>=(2\pi)^3 \delta^3(\vec{k}-\vec{k'}+\vec{k}_2-\vec{k''})(P^{\delta_{21}\delta_{21}} (\vec{k}-\vec{k'})+N^{\delta_{21}\delta_{21}} (\vec{k}-\vec{k'}))
\end{equation}

\begin{equation}
\left<\hat{v}_{21}(\vec{k'})\hat{v}_{21}(\vec{k''})\right>=(2\pi)^3 \delta^3(\vec{k'}+\vec{k''})(P^{v_{21}v_{21}} (\vec{k}')+N^{v_{21}v_{21}} (\vec{k}'))
\end{equation}

\begin{equation}
\left<\hat{\delta}_{21}(\vec{k}-\vec{k'})\hat{v}_{21}(\vec{k''})\right>=(2\pi)^3 \delta^3(\vec{k}-\vec{k'}+\vec{k''})(P^{\delta_{21}v_{21}} (\vec{k}-\vec{k}')+N^{\delta_{21}v_{21}} (\vec{k}-\vec{k}'))
\end{equation}

\begin{equation}
\left<\hat{\delta}_{21}(\vec{k}_2-\vec{k''})\hat{v}_{21}(\vec{k'})\right>=(2\pi)^3 \delta^3(\vec{k'}+\vec{k}_2-\vec{k''})(P^{\delta_{21}v_{21}} (\vec{k}_2-\vec{k}'')+N^{\delta_{21}v_{21}} (\vec{k}_2-\vec{k}''))
\end{equation}

\end{subequations}

%The 6 point correlations that were decomposed into 4 and 2 point correlations are further decomposed into 2 point correlations. Note that the term\\ $\left<\hat{p}_{kSZ}\hat{p}'_{kSZ}\right>\left<\hat{\delta}_{21}\hat{v}'_{21}\hat{\delta}'_{21}\hat{v}_{21}\right>$ will be decomposed into 3 terms, viz $\left<\hat{p}_{kSZ}\hat{p}'_{kSZ}\right>\left<\hat{\delta}_{21}\hat{v}'_{21}\right>\left<\hat{\delta}'_{21}\hat{v}_{21}\right>$, $\left<\hat{p}_{kSZ}\hat{p}'_{kSZ}\right>\left<\hat{\delta}_{21}\hat{\delta}'_{21}\right>\left<\hat{v}_{21}\hat{v}'_{21}\right>$ and $\left<\hat{p}_{kSZ}\hat{p}'_{kSZ}\right>\left<\hat{p}_{21}\hat{p}'_{21}\right>$

%Thus, we can further simplify the expression to give us 

%\begin{equation}
%\begin{aligned}
%\left< B_{l}^{21-kSZ}B_{l_2}^{21-kSZ}\right>&= \left<\hat{p}_{kSZ}\hat{p}'_{kSZ}\right>\left<\hat{p}_{21}\hat{p}'_{21}\right>+\frac{1}{c^2}\int\frac{dk_{\parallel}}{2\pi}\int\frac{dk_{2\parallel}}{2\pi}\int \frac{d^3\vec{k}'}{(2\pi)^3}\\
%&\int\frac{d^3\vec{k}''}{(2\pi)^3}
%(b_{HI}+f_1\mu_k^2)^2
%(b_{HI}+f_2\mu_k^2)^2
%\frac{e^{i(k_{\parallel}\chi(z_1)+k_{2\parallel} \chi(z_2))}}{\chi(z_1)^2\chi(z_2)^2}D(z_1)^2D(z_2)^2\hat{\theta}.\hat{k'}\\
%&\hat{\theta}.\hat{k}''
%\left<\hat{p}_{kSZ}\hat{p}'_{kSZ}\right>\left<\hat{\delta}_{21}\hat{\delta}'_{21}\right>\left<\hat{v}_{21}\hat{v}'_{21}\right>
%+\left<\hat{p}_{kSZ}\hat{p}'_{kSZ}\right>\left<\hat{\delta}_{21}\hat{v}'_{21}\right>\left<\hat{\delta}'_{21}\hat{v}_{21}\right>\\
%&+\left<\hat{p}_{kSZ}\hat{p}'_{kSZ}\right>\left<\hat{\delta}_{21}\hat{v}'_{21}\right>\left<\hat{\delta}'_{21}\hat{v}_{21}\right>+\left<\hat{p}_{kSZ}\hat{p}'_{kSZ}\right>\left<\hat{\delta}_{21}\hat{\delta}'_{21}\right>\left<\hat{v}_{21}\hat{v}'_{21}\right>\\
%&+\left<\hat{p}_{kSZ}\hat{p}'_{kSZ}\right>\left<\hat{\delta}_{21}\hat{\delta}'_{21}\right>\left<\hat{v}'_{21} \hat{v}_{21}\right>
%+\left<\hat{p}_{kSZ}\hat{p}'_{kSZ}\right>\left<\hat{\delta}_{21}\hat{v}'_{21}\right>\left<\hat{\delta}'_{21} \hat{v}_{21}\right>\\
%&+\left<\hat{p}_{kSZ}\hat{p}'_{kSZ}\right>\left<\hat{\delta}'_{21}\hat{v}_{21}\right>\left<\hat{\delta}_{21} \hat{v}'_{21}\right>
%+\left<\hat{p}_{kSZ}\hat{p}'_{kSZ}\right>\left<\hat{v}_{21}\hat{v}'_{21}\right>\left<\hat{\delta}'_{21} \hat{\delta}_{21}\right>\\
%&+\left<\hat{p}_{kSZ}\hat{\delta}'_{21}\hat{v}'_{21}\right>\left<\hat{p}'_{kSZ}\hat{\delta}_{21}\hat{v}_{21}\right>
%+\left<\hat{p}_{kSZ}\hat{\delta}'_{21}\hat{v}_{21}\right>\left<\hat{p}'_{kSZ}\hat{\delta}_{21}\hat{v}'_{21}\right>\\
%&+\left<\hat{p}_{kSZ}\hat{\delta}_{21}\hat{v}'_{21}\right>\left<\hat{p}'_{kSZ}\hat{\delta}'_{21}\hat{v}_{21}\right>
%+\left<\hat{p}_{kSZ}\hat{\delta}_{21}\hat{v}_{21}\right>\left<\hat{p}'_{kSZ}\hat{\delta}'_{21}\hat{v}'_{21}\right>\\
%&=\left<\hat{p}_{kSZ}\hat{p}'_{kSZ}\right>\left<\hat{p}_{21}\hat{p}'_{21}\right>+\frac{1}{c^2}\int\frac{dk_{\parallel}}{2\pi}\int\frac{dk_{2\parallel}}{2\pi}\int \frac{d^3\vec{k}'}{(2\pi)^3}\int\frac{d^3\vec{k}''}{(2\pi)^3}\\
%&(b_{HI}+f_1\mu_k^2)^2
%(b_{HI}+f_2\mu_k^2)^2\frac{e^{i(k_{\parallel}\chi(z_1)+k_{2\parallel} \chi(z_2))}}{\chi(z_1)^2\chi(z_2)^2}D(z_1)^2D(z_2)^2\hat{\theta}.\hat{k'}\hat{\theta}.\hat{k}''\\
%&[4\left<\hat{p}_{kSZ}\hat{p}'_{kSZ}\right>\left<\hat{\delta}_{21}\hat{\delta}'_{21}\right>\left<\hat{v}_{21}\hat{v}'_{21}\right>+4\left<\hat{p}_{kSZ}\hat{p}'_{kSZ}\right>\left<\hat{\delta}_{21}\hat{v}'_{21}\right>\left<\hat{\delta}'_{21}\hat{v}_{21}\right>\\
%&+\left<\hat{p}_{kSZ}\hat{\delta}'_{21}\hat{v}'_{21}\right>\left<\hat{p}'_{kSZ}\hat{\delta}_{21}\hat{v}_{21}\right>
%+\left<\hat{p}_{kSZ}\hat{\delta}'_{21}\hat{v}_{21}\right>\left<\hat{p}'_{kSZ}\hat{\delta}_{21}\hat{v}'_{21}\right>\\
%&+\left<\hat{p}_{kSZ}\hat{\delta}_{21}\hat{v}'_{21}\right>\left<\hat{p}'_{kSZ}\hat{\delta}'_{21}\hat{v}_{21}\right>
%+\left<\hat{p}_{kSZ}\hat{\delta}_{21}\hat{v}_{21}\right>\left<\hat{p}'_{kSZ}\hat{\delta}'_{21}\hat{v}'_{21}\right>]\\
%\end{aligned}
%\end{equation}

Also, the second term of equation \ref{variance of cross} is 

\begin{equation}
\int \frac{d^2l_2}{(2\pi)^2}\left<B_{l}^{21-kSZ}\right>\left<B_{l_2}^{21-kSZ}\right>
=\int \frac{d^2l_2}{(2\pi)^2}(B_{l}^{21-kSZ})(B_{l_2}^{21-kSZ})
\end{equation}

The variance is then


\begin{equation}
\begin{aligned}
(\sigma_{l}^{21-kSZ}(z_1,z_2))^2&= \frac{T_{rad}^2}{c^2}\int \frac{d^2\vec{l}_2}{(2\pi)^2}\int \frac{dk_{\parallel}}{2\pi}\int \frac{dk_{2\parallel}}{2\pi}\int \frac{d^3\vec{k}'}{(2\pi)^3} \int\frac{d^3\vec{k}''}{(2\pi)^3}\frac{e^{i(k_{\parallel}\chi(z_1)+k_{2\parallel} \chi(z_2))}}{\chi(z_1)^2}\\
&D(z_1)^2D(z_2)^2\hat{\theta}.\hat{k'}\hat{\theta}.\hat{k}''[\left<\hat{p}'_{kSZ}\hat{p}_{kSZ}\right> (P^{tot}_{\delta_m \delta_m}(k_1-k')P^{tot}_{v_m v_m}(k')(\delta^3(\vec{k}-\vec{k}'+\vec{k}_2-\vec{k}'')\\
&+\delta^3(\vec{k}'+\vec{k}''))+P^{tot}_{\delta v_m}(k'')P^{tot}_{\delta_m v_m}(k')(\delta^3(\vec{k}-\vec{k}'+\vec{k}'')+\delta^3(\vec{k}_2-\vec{k}''+\vec{k}')))
\\
&+\left<\hat{p}_{kSZ}\hat{\delta}'_{m}\hat{v}_m\right>\left<\hat{p}'_{kSZ}\hat{\delta}_{m}\hat{v}'_{m}\right>
+\left<\hat{p}_{kSZ}\hat{\delta}_m\hat{v}'_m\right>\left<\hat{p}'_{kSZ}\hat{\delta}'_m\hat{v}_m\right>+\left<\hat{p}_{kSZ}\hat{\delta}_m\hat{v}_m\right>\left<\hat{p}'_{kSZ}\hat{\delta}'_m\hat{v}'_m\right>\\
&+\left<\hat{p}_{kSZ}\hat{\delta}'_m\hat{v}'_m\right>\left<\hat{p}'_{kSZ}\hat{\delta}_m\hat{v}_m\right>]-\int \frac{d^2\vec{l}_2}{(2\pi)^2}(B_{l}^{21-kSZ})(B_{l_2}^{21-kSZ})
\end{aligned}
\end{equation}
%\bar{T}(z_1)^2\bar{T}(z_2)^2(b_{HI}+f_1\mu_k^2)^2(b_{HI}+f_2\mu_k^2)^2


Now, putting this together and writing the variance without integrating over y,



\begin{equation}
(\sigma_{l}^{21-kSZ}(y,z_1=z_2))^2=(C_{l}^{p_{kSZ}}+N_{l}^{p_{kSZ}})(C_l^{p_{21}}(y)+N_l^{p_{21}}(y)))+3 (B_{l}^{21-kSZ}(y))^2
\end{equation}

with $C_l^{p_{21}}(y)+N_l^{p_{21}}(y)$ given by

\begin{equation}
\begin{aligned}
C_l^{p_{21}}(y,z_1=z_2)+N_l^{p_{21}}(y,z_1=z_2)&=\frac{1}{c^2}\int d^3\vec{k}'\frac{e^{i(k_{\parallel}(\chi_1 -\chi_2)}}{\chi_1^2 r_1} D_1^2 D_2^2\hat{\theta}.\hat{k'}\\
&[\hat{\theta}.\hat{k}'(P^{\delta_{21}\delta_{21}}(k_1-k')+N^{\delta_{21}\delta_{21}}(k_1-k'))(P^{v_{21}v_{21}}(k')+N^{v_{21}v_{21}}(k'))\\
&+\hat{\theta}.\hat{K}(P^{\delta_{21}v_{21}}(k_1-k')+N^{\delta_{21}v_{21}}(k_1-k'))(P^{\delta_{21}v_{21}}(k')+N^{\delta_{21}v_{21}}(k'))]\\
&=\frac{1}{c^2}\frac{1}{\chi_1^2 r_1} D_1^2 D_2^2\int d^3\vec{k}'\hat{\theta}.\hat{k'}[\hat{\theta}.\hat{k'}P^{\delta \delta}P^{vv}+\hat{\theta}.\hat{k'}N^{\delta \delta}N^{vv}+\hat{\theta}.\hat{K}P^{\delta v}P^{\delta v}\\
&+\hat{\theta}.\hat{K}N^{\delta v}N^{\delta v}
+\hat{\theta}.\hat{k}'P^{\delta \delta}N^{vv}+\hat{\theta}.\hat{k}'P^{vv}N^{\delta \delta}+\hat{\theta}.\hat{K}P^{\delta v}N^{\delta v}+\hat{\theta}.\hat{K}P^{\delta v}N^{\delta v}]
\end{aligned}
\end{equation}

Thus, $N_l^{p_{21}}(y,z_1=z_2)$ is simply

\begin{equation}
\begin{aligned}
N_l^{p_{21}}(y,z_1=z_2)=&\frac{1}{c^2}\frac{1}{\chi_1^2 r_1} D_1^2 D_2^2\int d^3\vec{k}'\hat{\theta}.\hat{k'}[\hat{\theta}.\hat{k'}N^{\delta \delta}(K)N^{vv}(k')+\hat{\theta}.\hat{K}N^{\delta v}(K)N^{\delta v}(k')\\
&+\hat{\theta}.\hat{k}'P^{\delta \delta}(K)N^{vv}(k')+\hat{\theta}.\hat{k}'P^{vv}(k')N^{\delta \delta}(K)+\hat{\theta}.\hat{K}P^{\delta v}(K)N^{\delta v}(k')+\hat{\theta}.\hat{K}P^{\delta v}(K)N^{\delta v}(k')]
\end{aligned}
\end{equation}

Applying the window function to integrate over the redshift bin for the 21 cm, we have the squeezed bispectrum variance expressed as 

\begin{equation}
\begin{aligned}
N_l^{p_{21}}(y)=& \frac{1}{c^2}\int d z_1 \frac{1}{\chi_1^2 r_1} D_1^2 \int d z_2 D_2^2 \int d^3\vec{k}'\hat{\theta}.\hat{k'}[\hat{\theta}.\hat{k'}N^{\delta \delta}(K)N^{vv}(k')+\hat{\theta}.\hat{K}N^{\delta v}(K)N^{\delta v}(k')\\
&+\hat{\theta}.\hat{k}'P^{\delta \delta}(K)N^{vv}(k')+\hat{\theta}.\hat{k}'P^{vv}(k')N^{\delta \delta}(K)+\hat{\theta}.\hat{K}P^{\delta v}(K)N^{\delta v}(k')+\hat{\theta}.\hat{K}P^{\delta v}(K)N^{\delta v}(k')]
\end{aligned}
\end{equation}

and the associated variance

\begin{equation}
(\sigma_{l}^{21-kSZ}(y))^2=(C_{l}^{p_{kSZ}}+N_{l}^{p_{kSZ}})(C_l^{p_{21}}(y)+N_l^{p_{21}}(y)))+3 (B_{l}^{21-kSZ}(y))^2
\end{equation}



The full integral contributions from the $P^{\delta \delta}P^{vv}$ and $P^{\delta v}P^{\delta v}$ terms are written as

\begin{equation}
\begin{aligned}
I_{l}^{PP} (z_1,z_2) % &=\frac{1}{16 \pi^3 c^2} \frac{\bar{T}_1^2 f_1 (rsd(z_1))^2 H_1 D_1^2 }{\chi_1^2 (1+z_1)} \frac{\bar{T}_2^2 f_2 (rsd(z_2))^2 H_2 D_2^2 }{ 1+z_2} \int dk_{\parallel}
%\int dk' k'^2 \\
%&  \int_{-1}^{1} dU [\hat{\theta}.\hat{k}']^2 P_{\delta_e \delta_e} (K)\frac{\chi_1^2 r_1 N_{\delta_e \delta_e}(k_{\perp}')}{k'^2}\\
% 
&=\frac{1}{16 \pi^3 c^2} \frac{\bar{T}_1^2 f_1 (rsd(z_1))^2 H_1 D_1^2 r_1 }{(1+z_1)\chi(z_1)^2 r(z_1)} \frac{\bar{T}_2^2 f_2 (rsd(z_2))^2 H_2 D_2^2 }{ 1+z_2} \int dk_{\parallel}
\int_{10^{-6}}^{1} dk'k'^2\\
&  \int_{-1}^{1} dU [\hat{\theta}.\hat{k}'] \left( \frac{[\hat{\theta}.\hat{k}']}{k'^2}P_{\delta_e \delta_e} (K)  P_{\delta_e \delta_e}(k')+\frac{[\hat{\theta}.\hat{K}]}{K k'}P_{\delta_e \delta_e} (k')  P_{\delta_e \delta_e}(K)\right)\\
\end{aligned}
\end{equation}



The order of magnitude calculation is 

\begin{equation}\label{order_of_mag_Cl_21_PP}
\begin{aligned}
I_{l}^{PP} (z_1=z_2=z)=& 10^{-3}  \mu K^4 \frac{500}{16\pi^3}\frac{10^{-28}Mpc^2 s^{-2}}{c^2}\frac{\bar{T}^4}{300^4 \mu K^4}\frac{f(z)^2}{0.5^2}\frac{H(z)^2}{H_0 s^{-2}}\frac{D(z)^4}{0.5^4}\frac{4}{(1+z)^2}  \left(\frac{(b_{HI}+f(z)\mu_k^2)}{1+0.5\times 0.5^2}\right)^4 \\
&\frac{r(z)}{10^4 Mpc} \int \frac{dk_{\parallel}}{10^{-1}Mpc^{-1}}
\int_{10^{-10}}^{10} \frac{dk'}{10 Mpc^{-1}} \frac{k'^2}{100 Mpc^{-2}} \int_{-1}^1 \frac{dU}{1} \frac{[\hat{\theta}.\hat{k}']}{1}\\
&
\left(\frac{[\hat{\theta}.\hat{k}']}{1} \frac{100 Mpc^{-2}}{k'^2}\frac{P_{\delta_{e} \delta_e}}{10^3 Mpc^3} \frac{P_{\delta_{e} \delta_e}}{ 10^3 Mpc^3} +  \frac{[\hat{\theta}.\hat{K}]}{1}\frac{100 Mpc^{-2}}{k'K} \frac{P_{\delta_{e} \delta_e}}{10^3 Mpc^3} \frac{P_{\delta_{e} \delta_e}}{ 10^3 Mpc^3} \right)
\end{aligned}
\end{equation}

The full integral contributions from the $P^{\delta \delta}N^{vv}$, $P^{vv}N^{\delta \delta}$ and two $P^{\delta v}N^{\delta v}$ terms are written as

\begin{equation}
\begin{aligned}
I_{l}^{PN} (z_1,z_2) % &=\frac{1}{16 \pi^3 c^2} \frac{\bar{T}_1^2 f_1 (rsd(z_1))^2 H_1 D_1^2 }{\chi_1^2 (1+z_1)} \frac{\bar{T}_2^2 f_2 (rsd(z_2))^2 H_2 D_2^2 }{ 1+z_2} \int dk_{\parallel}
%\int dk' k'^2 \\
%&  \int_{-1}^{1} dU [\hat{\theta}.\hat{k}']^2 P_{\delta_e \delta_e} (K)\frac{\chi_1^2 r_1 N_{\delta_e \delta_e}(k_{\perp}')}{k'^2}\\
% 
&=\frac{1}{16 \pi^3 c^2} \frac{\bar{T}_1 f_1 (rsd(z_1)) H_1 D_1 r_1 }{1+z_1} \frac{\bar{T}_2 f_2 (rsd(z_2)) H_2 D_2 }{ 1+z_2} \int dk_{\parallel}
\int_{10^{-6}}^{1} dk'k'^2\\
&  \int_{-1}^{1} dU [\hat{\theta}.\hat{k}'] \left( \frac{[\hat{\theta}.\hat{k}']}{k'^2}P_{\delta_e \delta_e} (K)  N_{\delta_e \delta_e}(k_{\perp}')+\frac{[\hat{\theta}.\hat{k}']}{k'^2}P_{\delta_e \delta_e} (k')  N_{\delta_e \delta_e}(K_{\perp})\right.\\
&\left.+\frac{[\hat{\theta}.\hat{K}]}{K k'}P_{\delta_e \delta_e} (k')  N_{\delta_e \delta_e}(K_{\perp})+\frac{[\hat{\theta}.\hat{K}]}{K k'}P_{\delta_e \delta_e} (K)  N_{\delta_e \delta_e}(k'_{\perp}) \right)\\
\end{aligned}
\end{equation}

The order of magnitude calculation is 

\begin{equation}\label{order_of_mag_Cl_21_PN}
\begin{aligned}
I_{l}^{PN} (z_1=z_2=z)=& 10^{-3}  \mu K^4 \frac{500}{16\pi^3}\frac{10^{-28}Mpc^2 s^{-2}}{c^2}\frac{\bar{T}^2}{300^2 \mu K^2}\frac{f(z)^2}{0.5^2}\frac{H(z)^2}{H_0 s^{-2}}\frac{D(z)^2}{0.5^2}\frac{4}{(1+z)^2}  \left(\frac{(b_{HI}+f(z)\mu_k^2)}{1+0.5\times 0.5^2}\right)^2 \\
&\frac{r(z)}{10^4 Mpc} \int \frac{dk_{\parallel}}{10^{-1}Mpc^{-1}}
\int_{10^{-10}}^{10} \frac{dk'}{10 Mpc^{-1}} \frac{k'^2}{100 Mpc^{-2}} \int_{-1}^1 \frac{dU}{1} \frac{[\hat{\theta}.\hat{k}']}{1}\\
&
\left(\left(\frac{[\hat{\theta}.\hat{k}']}{1} \frac{100 Mpc^{-2}}{k'^2}\frac{P_{\delta_{e} \delta_e}}{10^3 Mpc^3} \frac{N_{\delta_{e} \delta_e}}{ 0.1 \mu K^2}\right)^2 +  \left(\frac{[\hat{\theta}.\hat{K}]}{1}\frac{100 Mpc^{-2}}{k'K} \frac{P_{\delta_{e} \delta_e}}{10^3 Mpc^3} \frac{N_{\delta_{e} \delta_e}}{ 0.1 \mu K^2}\right)^2 \right)
\end{aligned}
\end{equation}

%\begin{figure}[h!]
%	\centering
%	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/noise_plot_30pts}
%	\caption{Noise spectrum for 30 points}
%	\label{fig:noiseplot30pts}
%\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/Pdeldel_Nvv_colorplot_rect_coords}
	\caption{$P(K)N(k')$ integrand, with $l'=0.58$ to $l'=58000$ with the darker region ranging from $l \approx 80$ to $l' \approx 6000$. This plot looks the same for all y values.}
	\label{fig:pdeldelnvvcolorplotrectcoords}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/Pvv_Ndeldel_colorplot}
	\caption{$P(k')N(K)$ integrand, with $l'=0.58$ to $l'=58000$. This plot looks the same for all y values.}
	\label{fig:pvvndeldelcolorplotrectcoords}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/NN_colorplot_rect_coords}
	\caption{$N(K)N(k')$ integrand, with $l'=0.58$ to $l'=58000$. This plot is a combination of the previous two plots and looks the same for all y values.}
	\label{fig:nncolorplotrectcoords}
\end{figure}


%\begin{figure}[h!]
%	\centering
%	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/variance_all_terms_summed_integral_over_y_and_one_redshift_noisemax_pt1_npoints_30}
%	\caption{Variance plot with integral over $y$ and $z_2$}
%	\label{fig:variancealltermssummedintegraloveryandoneredshiftnoisemaxpt1npoints30}
%\end{figure}


The full integral contributions from the $N^{\delta \delta}N^{vv}$ and $N^{\delta v}N^{\delta v}$ terms are written as

\begin{equation}
\begin{aligned}
I_{l}^{NN} (z_1,z_2) % &= \frac{1}{16 \pi^3 c^2}  \frac{f_1  H_1 }{\chi_1^2(1+z_1)}  \frac{f_2  H_2 }{1+z_2} \int dk_{\parallel} \int dk' k'^2 \\
%&  \int_{-1}^{1} dU [\hat{\theta}.\hat{k}']^2 \chi_1^2 r_1 N_{\delta_e \delta_e} (K)\frac{\chi_1^2 r_1 N_{\delta_e \delta_e}(k_{\perp}')}{k'^2}\\
&= \frac{1}{16 \pi^3 c^2}  \frac{f_1  H_1 \chi_1^2 r_1^2}{(1+z_1)}  \frac{f_2  H_2 }{1+z_2} \int dk_{\parallel}\int_{10^{-6}}^{1} dk' k'^2 \\
&  \int_{-1}^{1} dU [\hat{\theta}.\hat{k}']  [\hat{\theta}.\hat{k}']N_{\delta_e \delta_e} (k_{\perp}')  N_{\delta_e \delta_e}(K_{\perp})\left(\frac{[\hat{\theta}.\hat{k}']}{k'^2}+\frac{[\hat{\theta}.\hat{K}]}{K k'}\right)\\
\end{aligned}
\end{equation}


The order of magnitude calculation is 

\begin{equation}\label{order_of_mag_Cl_21_NN}
\begin{aligned}
I_{l}^{NN} (z_1=z_2=z)=& 10^{-3} \mu K^4 \frac{500}{16\pi^3}\frac{10^{-28}Mpc^2 s^{-2}}{c^2}\frac{f(z)^2}{0.5^2}\frac{H(z)^2}{H_0 s^{-2}}\frac{4}{(1+z)^2} \\
&\frac{\chi^2(z)r(z)}{10^7 Mpc} \int \frac{dk_{\parallel}}{10^{-1}Mpc^{-1}}
\int_{10^{-10}}^{10} \frac{dk'}{10 Mpc^{-1}} \frac{k'^2}{100 Mpc^{-2}} \int_{-1}^1 \frac{dU}{1} \frac{[\hat{\theta}.\hat{k}']}{1}\\
&
\left(\frac{[\hat{\theta}.\hat{k}']}{1} \frac{100 Mpc^{-2}}{k'^2}\frac{N_{\delta_e \delta_e}}{0.1 \mu K^2} \frac{N_{\delta_{e} \delta_e}}{ 0.1 \mu K^2} +  \frac{[\hat{\theta}.\hat{K}]}{1}\frac{100 Mpc^{-2}}{k'K} \frac{N_{\delta_{e} \delta_e}}{0.1 \mu K^2} \frac{N_{\delta_{e} \delta_e}}{ 0.1 \mu K^2} \right)
\end{aligned}
\end{equation}

For the full bispectrum case, we have the expression, without integrating over the window function or y modes

\begin{equation}
(\sigma_{l}^{21-kSZ}(y,z_1,z_2))^2=(C_{l}^{p_{kSZ}}+N_{l}^{p_{kSZ}})(C_l^{p_{21}}(y)+N_l^{p_{21}}(y))+2 B_l^{p_{kSZ}\delta_{21} \delta_{21}}(y) B_l^{p_{kSZ}v_{21} v_{21}}(y)+ 3 (B_{l}^{p_{kSZ}\delta_{21} v_{21}})^2(y)
\end{equation}


\section*{Inhomogenous bispectrum}

The bispectrum, if we don't assume homogeneity, is written as

\begin{equation}\label{bispec signal 1}
\begin{aligned}
B_{l}^{21-kSZ}(z_1)&=\int \frac{d^2 l_2}{(2\pi)^2}\left< p^{21}_{l}(z_1)p^{kSZ}_{l_2}(z_1)\right>\\
&=\frac{-T_{rad}}{c}\int \frac{d^2 l_2}{(2\pi)^2}\int \frac{dk_{\parallel}}{2\pi}\frac{e^{ik_{\parallel} \chi_1}}{\chi_1^2}D_1^4\hat{\theta}.\hat{k}'\int \frac{d^3\vec{k}'}{(2\pi)^3}\left<\delta_{21}(\vec{k}-\vec{k}')v_{21}(\vec{k}')p_{kSZ}(l_2)\right>
\end{aligned}
\end{equation}

\begin{equation}\label{bispec signal 2}
\begin{aligned}
B_{l_3}^{21-kSZ}(z_1)&=\int \frac{d^2 l_4}{(2\pi)^2}\left< p^{21}_{l_3}(z_1)p^{kSZ}_{l_4}(z_1)\right>\\
&=\frac{-T_{rad}}{c}\int \frac{d^2 l_4}{(2\pi)^2}\int \frac{dk_{3\parallel}}{2\pi}\frac{e^{ik_{3\parallel} \chi_3}}{\chi_3^2}D_1^4\hat{\theta}_3.\hat{k}'''\int \frac{d^3\vec{k}'''}{(2\pi)^3}\left<\delta_{21}(\vec{k}_3-\vec{k}''')v_{21}(\vec{k}''')p_{kSZ}(l_4)\right>
\end{aligned}
\end{equation}

\begin{equation}
\begin{aligned}
\left< B_{l}B_{l_3}\right>&=\frac{T_{rad}^2}{c^2}\int \frac{d^2l_2}{(2\pi)^2}\int \frac{d^2l_4}{(2\pi)^2}\int \frac{dk_{1||}}{2\pi} \frac{e^{ik_{1||}\chi_1}}{\chi_1^2} \int \frac{dk_{3||}}{2\pi} \frac{e^{ik_{3||}\chi_3}}{\chi_3^2}\hat{\theta}.\hat{k}' \hat{\theta}_3.\hat{k}'''\\
& \int \frac{d^3k'}{(2\pi)^3}\int \frac{d^3k'''}{(2\pi)^3} \left< \delta_{21}(\vec{k}-\vec{k}') v_{21}(\vec{k}')p_{kSZ}(l_2)\delta_{21}(\vec{k}_3-\vec{k}''')v_{21}(\vec{k}''')p_{kSZ}(l_4) \right>\\
&=\frac{T_{rad}^2}{c^2}\int \frac{d^2l_2}{(2\pi)^2}\int \frac{d^2l_4}{(2\pi)^2}\int \frac{dk_{1||}}{2\pi} \frac{e^{ik_{1||}\chi_1}}{\chi_1^2} \int \frac{dk_{3||}}{2\pi} \frac{e^{ik_{3||}\chi_3}}{\chi_3^2}\hat{\theta}.\hat{k}' \hat{\theta}_3.\hat{k}'''\\
&\int \frac{d^3k'}{(2\pi)^3}\int \frac{d^3k'''}{(2\pi)^3} [\left<p_{kSZ}(l_2) p_{kSZ}(l_4)\right>\left<\delta_{21}(k_1-k')\delta_{21}(k_3-k''')\right>\left<v_{21}(k')v_{21}(k''')\right>\\
&+\left<p_{kSZ}(l_2) p_{kSZ}(l_4)\right>\left<\delta_{21}(k_1-k')v_{21}(k''')\right>\left<v_{21}(k')\delta_{21}(k_3-k''')\right>\\
&+\left<p_{kSZ}(l_2)\delta_{21}(k_3-k''')v_{21}(k''')\right> \left<p_{kSZ}(l_4)\delta_{21}(k_1-k')v_{21}(k')\right>\\
&+\left<p_{kSZ}(l_2)\delta_{21}(k_1-k')v_{21}(k''')\right> \left<p_{kSZ}(l_4)\delta_{21}(k_3-k''')v_{21}(k')\right>\\
&+\left<p_{kSZ}(l_2)\delta_{21}(k_3-k''')v_{21}(k')\right> \left<p_{kSZ}(l_4)\delta_{21}(k_1-k')v_{21}(k''')\right>]\\
&+\left<p_{kSZ}(l_2)\delta_{21}(k_1-k')v_{21}(k')\right> \left<p_{kSZ}(l_4)\delta_{21}(k_3-k''')v_{21}(k''')\right>]\\
&=\frac{T_{rad}^2}{c^2}\int \frac{d^2l_2}{(2\pi)^2}\int \frac{dk_{1||}}{2\pi} \frac{e^{ik_{1||}(\chi_1-\chi_3)}}{\chi_1^2 \chi_3^2} \hat{\theta}.\hat{k}' (C^{p_{kSZ}}_{l_2}+N^{p_{kSZ}}_{l_2})\\
&[\hat{\theta}.\hat{k}'(P_{\delta_{21}\delta_{21}}(k_1-k')+N_{\delta_{21}\delta_{21}}(k_1-k'))(P_{v_{21}v_{21}}(k')+N_{v_{21}v_{21}}(k'))\\
&+\hat{\theta}.\hat{K}(P_{\delta_{21}v_{21}}(k_1-k')+N_{\delta_{21}v_{21}}(k_1-k'))(P_{\delta_{21}v_{21}}(k')+N_{\delta_{21}v_{21}}(k'))]+4B^{21-kSZ}_{l}B^{21-kSZ}_{l_3}
\end{aligned}
\end{equation}

\subsection{Optimal bispectrum estimator}

We previously had the true integrated bispectrum signal written as 

\begin{equation}
\begin{aligned}
B_{l}^{p_{21}p_e}(y)&=\int \frac{d^2l_2}{(2\pi)^2}\left<p_{21}(\vec{l},z_1)p^*_{kSZ}(\vec{l}_2)\right>\\
&=\frac{-T_{rad}}{c}\int \frac{d^2l_2}{(2\pi)^2}\int d\chi_1 \frac{e^{iy}}{\chi_1^2} D_1^4 [\hat{\theta}.\hat{k}']\int \frac{d^3k'}{(2\pi)^3}\left< \delta_{21} (\vec{k}-\vec{k}') v_{21} (\vec{k}') p_{kSZ}(\vec{l}_2)\right>\\
&=\int \frac{d^2l_2}{(2\pi)^2} \int d\chi_1 \int \frac{d^3k'}{(2\pi)^3} C(y,\chi_1,k'_\parallel) \left< \delta_{21} (\vec{k}-\vec{k}') v_{21} (\vec{k}') p_{kSZ}(\vec{l}_2)\right>
\end{aligned}
\end{equation}

where we have defined $C(y,\chi_1,k'_\parallel)=\frac{-T_{rad}}{c}\frac{e^{iy}}{\chi_1^2} D_1^4 k'_\parallel$.

We can also write the full bispectrum as 

\begin{equation}
B(l,y,\chi_1,k',k'_\parallel,\vec{l}_2)=C(y,\chi_1,k'_\parallel) \left< \delta_{21} (\vec{k}-\vec{k}') v_{21} (\vec{k}') p_{kSZ}(\vec{l}_2)\right>
\end{equation}

We now define an optimal bispectrum estimator, 

\begin{equation}
\hat{B}_l(y)=B_l(y) \hat{\epsilon}(l,y)
\end{equation}

with

\begin{equation}
\hat{\epsilon}(l,y)=\frac{1}{N(l,y)}\int \frac{d^2l_2}{(2\pi)^2}\int d\chi_1 \int \frac{d^3k'}{(2\pi)^3} C(y,\chi_1,k'_\parallel) \hat{f}(\vec{k},\vec{k}',\vec{l}_2) W(\vec{k},\vec{k}',\vec{l}_2)
\end{equation}

where $\hat{f}(\vec{k},\vec{k}',\vec{l}_2)=\hat{\delta}(\vec{k}-\vec{k}')\hat{v}_{21} (\vec{k}') \hat{p}_{kSZ}(\vec{l}_2)$.

The normalisation for the estimator is written such that $\left< \hat{\epsilon}(l,y)\right>=1$. This gives us the expression

\begin{equation}
N(l,y)=\int \frac{d^2 l_2}{(2\pi)^2}  \int d\chi_1 \int \frac{d^3k'}{(2\pi)^3} C(y,\chi_1,k'_\parallel) B(l,y,\chi_1,k',k'_\parallel,\vec{l}_2) W(\vec{k},\vec{k}',\vec{l}_2)
\end{equation}

The variance of the estimator is written with the assumption that the kSZ momentum field is gaussian, so as to simplify the expression. 

\begin{equation}
\begin{aligned}
\sigma^2(\hat{\epsilon}(l,y)&=\left< \hat{\epsilon}(l,y)\hat{\epsilon}^*(l_3,y_3) \right>\\
&=\frac{1}{N(l,y)N(l_3,y_3)}\int \frac{d^2l_2}{(2\pi)^2}\int d\chi_1 \int \frac{d^3k'}{(2\pi)^3} \int \frac{d^2l_4}{(2\pi)^2}\int d\chi_3 \int \frac{d^3k''}{(2\pi)^3} C(y,\chi_1,k'_\parallel) \\
&C(y_3,\chi_3,k''_\parallel) \left<\hat{\delta}(\vec{k}-\vec{k}')\hat{v}_{21} (\vec{k}') \hat{p}_{kSZ}(\vec{l}_2)  \hat{\delta}(\vec{k}_3-\vec{k}'')\hat{v}_{21} (\vec{k}'') \hat{p}_{kSZ}(\vec{l}_4) \right>W(\vec{k},\vec{k}',\vec{l}_2)W(\vec{k}_3,\vec{k}'',\vec{l}_4)\\
&=\frac{1}{N(l,y)N(l_3,y_3)}\int \frac{d^2l_2}{(2\pi)^2}\int d\chi_1 \int \frac{d^3k'}{(2\pi)^3} \int \frac{d^2l_4}{(2\pi)^2}\int d\chi_3 \int \frac{d^3k''}{(2\pi)^3} C(y,\chi_1,k'_\parallel)C(y_3,\chi_3,k''_\parallel) \\
& \delta^3(\vec{k}-\vec{k}_3) \delta^3(\vec{k}'-\vec{k}'') \delta^2(\vec{l}_2-\vec{l}_4) [P^{tot}_{\delta_{21}\delta_{21}}(|\vec{k}-\vec{k}'|)P^{tot}_{v_{21}v_{21}}(k')+P^{tot}_{\delta_{21}v_{21}}(|\vec{k}-\vec{k}'|)P^{tot}_{\delta_{21} v_{21}}(k')] C^{p_{kSZ}}_{l_2}\\
&W(\vec{k},\vec{k}',\vec{l}_2)W(\vec{k}_3,\vec{k}'',\vec{l}_4)\\
&=\delta^3(\vec{k}-\vec{k}_3)\frac{1}{N^2(l,y)}\int \frac{d^2l_2}{(2\pi)^2}\int d\chi_1 \int \frac{d^3k'}{(2\pi)^3} W^2(\vec{k},\vec{k}',\vec{l}_2) C^2(y,\chi_1,k'_\parallel)  C^{p_{21},tot}(k,k')C^{p_{kSZ}}_{l_2}\\
\end{aligned}
\end{equation}

where 
$C^{p_{21},tot}(k,k')=P^{tot}_{\delta_{21}\delta_{21}}(|\vec{k}-\vec{k}'|)P^{tot}_{v_{21}v_{21}}(k')+P^{tot}_{\delta_{21}v_{21}}(|\vec{k}-\vec{k}'|)P^{tot}_{\delta_{21} v_{21}}(k')$.

Minimizing the variance gives the optimal weighting of 

\begin{equation}
W(\vec{k},\vec{k}',\vec{l}_2)=\frac{ B(l,y,\chi_1,k',k'_\parallel,\vec{l}_2)}{C^{p_{21},tot}(k,k')C^{p_{kSZ}}_{l_2}}
\end{equation}

Substituting this to get the expression for the normalization gives

\begin{equation}
N(l,y)=\int \frac{d^2 l_2}{(2\pi)^2}  \int d\chi_1 \int \frac{d^3k'}{(2\pi)^3}  \frac{|B(l,y,\chi_1,k',k'_\parallel,\vec{l}_2)|^2}{C^{p_{21},tot}(l,y,k')C^{p_{kSZ}}_{l_2}}=Var[\hat{\epsilon}(l,y)]
\end{equation}

after which we can write

\begin{equation}
Var[\hat{B}(l,y)]=B_l(y) Var[\hat{\epsilon}(l,y)]
\end{equation}

The signal to noise ratio is then 




\begin{equation}
\left(\frac{S}{N}(l,y)\right)^2=\frac{V}{2}\int \frac{d^2 l_2}{(2\pi)^2} \int d \chi_1 \int \frac{d^3k'}{(2\pi)^3}\frac{|B(l,y,\chi_1,k',k'_\parallel,\vec{l}_2)|^2}{C^{p_{21},tot}(l,y,k')C^{p_{kSZ},tot}(\vec{l}_2)}
\end{equation}



We use the triangle condition for the bispectrum, $\delta^3(\vec{k}'+\vec{k}-\vec{k}'+\vec{l}_2/\chi)=0$ to set $\vec{l}=\vec{l}_2$ which simplifies our expression to

\begin{equation}
\left(\frac{S}{N}(l,y)\right)^2= \frac{V}{2C_l^{p_{kSZ},tot}}\int d \chi_1 \int \frac{d^3k'}{(2\pi)^3}\frac{|B(l,y,\chi_1,k',k'_\parallel,\vec{l}_2)|^2}{C^{p_{21},tot}(l,y,k')}
\end{equation}

where we substitute

\begin{equation}
\begin{aligned}
B_{l}^{p_{21}p_e}(y,z_1,\vec{k}')=&\frac{T_{rad}}{8\pi^3c^2}\frac{D(z_1)^2}{\chi_1^2 r_1}  \int d\chi_2 g(\chi_2) D(z_2)^2 e^{-iy \chi_2/r_2} \\ 
&[\hat{\theta}_1.\hat{k}']\left[[\hat{\theta}_2.\hat{k}'] P_{\delta_{21} \delta_e}(|\vec{k}-\vec{k}'|) P_{v_{21} v_e}(k')+[\hat{\theta}_2.\hat{K}]P_{\delta_{21} v_e}(k') P_{v_{21} \delta_e}(|\vec{k}-\vec{k}'|)\right]\\
\end{aligned}
\end{equation}

We integrate the $\frac{S}{N}(l,y)$ over $l$ and $y$ as follows

\begin{equation}
\left(\frac{S}{N}\right)^2=\frac{V}{2}\int \frac{dl}{2\pi} \int \frac{dy}{2\pi} l \left(\frac{S}{N}(l,y)\right)^2
\end{equation}


We plot the signal to noise without integrating over the 21 cm redshift bin in Figure \ref{fig:optimalsn2dbispecz1pt26deltazpt003kpmax1}. We also plot the signal, $B(l,y)$ in figure \ref{fig:2dbispecz1pt26deltazpt003kpmax1} and standard deviation, $\sigma (\hat{B}(l,y))$ in figure \ref{fig:2dinvvarz1pt26deltazpt003kpmax1}, in order to check the results obtained for the signal to noise, with the $\sigma (\hat{B}(l,y))$ is expressed as 

\begin{equation}
\sigma (\hat{B}(l,y))=Var(\hat{B}(l,y))^{1/2}=\left[\int \frac{d^3k'}{(2\pi)^3} \frac{1}{C^{p_{21},tot}(l,y,k')C_l^{p_{kSZ},tot}}\right]^{-1/2}
\end{equation}

A quick order of magnitude check can be computed as follows. 

\begin{equation}
\left(\frac{S}{N}\right)^2(z)=10^{-8}\frac{const}{10^{-3}}\int \frac{dl}{100}\frac{l}{10^3}\int \frac{dy}{100}\frac{B(l,y,z)^2}{(10^{-7})^2}\frac{10^{-2}}{Var(l,y,z)}
\end{equation}

where $const=\frac{N_{patches} f_{sky} Volume}{(4\pi)^2}$. I use the following equations

\begin{subequations}
\begin{equation}
N_{patches}=\frac{S_{area}}{FOV}
\end{equation}
\begin{equation}
Volume=S_{area} \Delta \tilde{\nu}
\end{equation}
\begin{equation}
f_{sky}=\frac{S_{area}}{4\pi}
\end{equation}
\end{subequations}

with $S_{area}=15000$ square degrees. We can quote the order of magnitude for the variance, $Var(l,y,z)=C_l^{p_{21},tot} C_l^{p_{kSZ},tot}$ as $ C_l^{p_{21},tot}=10^{-3} \mu K^4$, which we get from the order of magnitude calculations in equations \ref{order_of_mag_Cl_21_PP}, \ref{order_of_mag_Cl_21_PN} and \ref{order_of_mag_Cl_21_NN}, and $C_l^{p_{kSZ},tot}=10 \mu K^2$ which is found by averaging figure \ref{fig:clttnlttclovdeltazpt0015summed}. Thus, we expect $\frac{S}{N}(z) \approx 10^{-4}$, as shown in Figure \ref{fig:optimalsn2dbispecz1pt26deltazpt003kpmax1}.\\
 I then computed the signal to noise with the integral over the $\Delta_z=0.003$ redshift bin in figure \ref{fig:optimalsn2dbispecz1pt26deltazpt003integratedoverredshiftkpmax1}. We see that the pixelated signal to noise decreases after integrating over the redshift bin. I plot the cumulative S/N as well in figure \ref{fig:optimalcumsn2dbispecz1pt26deltazpt003integratedoverredshiftkpmax1}, which we find to be $ \approx 10^{-3}$. Summing over 1000 of these redshift bins, over the full HIRAX range would give a cumulative S/N of $ \approx 1$.


\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/optimal_SN_2D_bispec_z_1pt26_deltaz_pt003_kpmax_1}
	\caption{Optimal signal to noise for the bispectrum plotted for $z=1.26$ and $\Delta_z=0.003$, without integrating over the 21 cm redshift, integrating up to $k'=1 Mpc^{-1}$.}
	\label{fig:optimalsn2dbispecz1pt26deltazpt003kpmax1}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/2D_bispec_z_1pt26_deltaz_pt003_kpmax_1}
	\caption{2D signal for bispectrum plotted for $z=1.26$, integrated up to $k'=1 Mpc^{-1}$. We integrate the kSZ signal over the bin width $\Delta_z=0.003$ but have not integrated over the 21 cm redshift in this plot.}
	\label{fig:2dbispecz1pt26deltazpt003kpmax1}
\end{figure}


\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/2D_sigma_sqrt_z_1pt26_deltaz_pt0015_zksz_small}
	\caption{Sigma plotted for $z=1.26$, integrated up to $k'=1 Mpc^{-1}$. We integrate the kSZ signal over the bin width $\Delta_z=0.003$ but have not integrated over the 21 cm redshift in this plot.}
	\label{fig:2dsigmasqrtz1pt26deltazpt0015zkszsmall}
\end{figure}



\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/optimal_SN_2D_bispec_z_1pt26_deltaz_pt003_integrated_over_redshift_kp_perp_1_kp_par_pt15_kparmax_pt15}
	\caption{Optimal signal to noise for the bispectrum plotted for $z=1.26$ and $\Delta_z=0.003$, after integrating over the 21 cm redshift, integrating up to $k'=1 Mpc^{-1}$.}
	\label{fig:optimalsn2dbispecz1pt26deltazpt003integratedoverredshiftkpmax1}
\end{figure}


\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/optimal_cum_SN_2D_bispec_z_1pt26_deltaz_pt003_integrated_over_redshift_kp_perp_1_kp_par_pt15_kparmax_pt15}
	\caption{Cumulative signal to noise for the bispectrum plotted for $z=1.26$ and $\Delta_z=0.003$, after integrating over the 21 cm redshift, integrating up to $k'=1 Mpc^{-1}$.}
	\label{fig:optimalcumsn2dbispecz1pt26deltazpt003integratedoverredshiftkpmax1}
\end{figure}



Now, we also look at foreground cuts. Foregrounds dominate at low $k_\parallel$, therefore we restrict the range of $k_\parallel$ and $k'_\parallel$ to $0.01-0.15$. There is no visible change to the signal-to-noise when we integrate over the restricted $k'_\parallel$ range. This can be understood by plotting the S/N as a function of $k'_\parallel$, shown in figure \ref{fig:snfuncofkpparintegratedoverkpperp}. 

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/SN_func_of_kppar_integrated_over_kpperp}
	\caption{S/N for a specific $l,y$ and redshift plotted against $k'_\parallel$, which shows that the contribution to the S/N is small for $k'_\parallel<0.01$. Thus, the foreground cut does not affect the S/N. The demarcated region shows the range in which foreground contamination is low for linear scales.}
	\label{fig:snfuncofkpparintegratedoverkpperp}
\end{figure}


\clearpage
\subsection{Signal-to-noise}

The signal-to-noise for the bispectrum is 
\begin{equation}
\left(\frac{S}{N}\right)^2=0.5V\int \frac{dl}{2\pi} \int \frac{dy}{2\pi} \frac{l(B_{l}^{21-kSZ}(y))^2}{(\sigma_l^{21-kSZ}(y))^2}
\end{equation}

Referring to equation \ref{Bispec eqn squeezed limit}, and rewriting this as a function of $l$ and $y$, gives

\begin{equation}
\begin{aligned}
B_l(y,z_i=z=1.)=&\frac{1}{(2\pi)^2}\frac{T_{rad}\bar{T}}{c}\frac{f(z_i)H(z_i)D(z_i)^2}{\chi_i^2 r_i (1+z_i)}x\left(\frac{\sigma_T \rho_{c0}}{\mu_e m_p}\right) (b_{HI}+f(z_i)f(z_i)\mu_k^2)^2\Delta z f(z) D(z)^2\\&
 (1+z) e^{-\tau(z)}P_{\delta_{e} \delta_e}(k)\int d\zeta [\hat{\theta}.\hat{k}']^2\int_{10^{-6}}^{0.1} dk'
P_{\delta_{e} \delta_e}(k') 
\end{aligned}
\end{equation}

\begin{equation}
\begin{aligned}
B_l(y,z_i=z=1)=&10^{-11} \mu K^2\frac{200}{(2\pi)^3}\frac{T_{rad}}{10^{6}\mu K}\frac{10^{-14}Mpc s^{-1}}{c}\frac{\bar{T}}{200 \mu K}\frac{f(z_i)}{0.5}\frac{H(z_i)}{H_0 s^{-1}}\frac{D(z_i)^2}{0.5^2}\frac{5000^2 Mpc^2}{\chi_i^2}
\\&\frac{10^4 Mpc}{r_i}\frac{2}{1+z_i} \frac{x}{1}\frac{\sigma_T}{(10^{-74}) Mpc^2} \frac{\rho_{g0}}{(10^{42}) g Mpc^{-3}}\frac{(10^{-24}) g}{\mu_e m_p} \frac{\Delta z}{10} \frac{f(z)}{0.5} \frac{D(z)^2}{0.5^2} \frac{(1+z)}{10} \frac{e^{-\tau(z)}}{e^{-\tau_r}}\\
&  \frac{(b_{HI}+f(z_i)\mu_k^2)}{1+0.5\times 0.5^2}\int \frac{d\zeta}{2}\left[ \frac{\mu_k\zeta}{0.5\times 0.5}+\frac{l}{10^3}\frac{5000 Mpc}{\chi}\frac{1 Mpc^{-1}}{k}\frac{\sqrt{1-\zeta^2}}{\sqrt{1-0.5^2}}\right]\\
&\int \frac{dk'}{10}
\left(\frac{P_{\delta_{e} \delta_e}(k')}{10^3 Mpc^3} \frac{P_{\delta_{e} \delta_e}(k)}{ 10^3 Mpc^3}\right)
\end{aligned}
\end{equation}
We have omitted the derivative term as it is not applicable when calculating the bispectrum for individual $l$ and $y$ values, since a singular point has no derivative.

%The equation for $\sigma_l^{21-kSZ}(y,z_i=1)$ is

%\begin{equation}
%\begin{aligned}
%(\sigma_l^{21-kSZ})^2=&(C_{l}^{p_{kSZ}}+N_{l}^{p_{kSZ}})(C_{l}^{v_{21}}(y,z=1)+N_{l}^{v_{21}}(y,z=1)+\\&
%+C_{l}^{\delta_{21}}(y,z=1)+N_{l}^{\delta_{21}}(y,z=1))+3 (B_{l}^{21-kSZ}(y,z=1))^2\\
%&=10^{-8}\mu K^2\frac{C_{l}^{p_{kSZ}}+N_{l}^{p_{kSZ}}}{(10^{-5} +10^{-2}+10^{-7})\mu K^2}\frac{(C_{l}^{v_{21}}+N_{l}^{v_{21}}+C_{l}^{\delta_{21}}+N_{l}^{\delta_{21}})}{(10^{-11}+{10^{-11}}+10^{-4}+10^{-4})\mu K^2}+\\
%&+\frac{3 (B_{l}^{21-kSZ})^2}{10^{-20}\mu K^2}\\
%\end{aligned}
%\end{equation}

The orders of magnitude can be estimated by referring to Figures \ref{fig:ovandcmbnoiseprelim} and \ref{fig:hiraxnoise21cmdiffyz1}.
The noise for the 21 cm velocity signal is obtained by converting the density power spectrum to a velocity power spectrum.  Multiplying the 21cm density noise by the factors expressed in equation \ref{v(k)} gives. Note that the signal to noise for the 21cm velocity is equivalent to that of the 21cm density, as the factors which multiply the signal and noise, cancel out. 


\begin{subequations}
\begin{equation}
N_l^{v_{21}}(y,z_i=1)= \left(\frac{1}{c}\frac{f(z_i)H(z_i)}{1+z_i}\frac{y}{r(z_i)k}\right)^2 N_l^{\delta_{21}}(y,z_i=1)
\end{equation}
\begin{equation}
C_l^{v_{21}}(y,z_i=1)=\left(\frac{1}{c}\frac{f(z_i)H(z_i)}{1+z_i}\frac{y}{r(z_i)k}\right)^2 C_l^{\delta_{21}}(y,z_i=1)
\end{equation}
\end{subequations}

%An order of magnitude calculation can be used to roughly estimate the accuracy of the results.

%\begin{equation}
%\begin{aligned}
%\left(\frac{S}{N}\right)^2(l=600,y=600)=&10^{-8}\frac{const}{10}\frac{f_{sky}}{0.36}\frac{\Delta \tilde{\nu}}{0.3} \frac{S_{area}}{5} \frac{dl}{0.01\chi}\frac{dy}{0.01 r_{\nu}}\frac{l}{600} \left(\frac{B_l^{21-kSZ}}{5\times 10^{-10}} \mu K^2\right)^2\\ &\frac{10^{-8}\mu K^4}{(C_{l}^{p_{kSZ}}+N_{l}^{p_{kSZ}})(C_{l}^{v_{21}}+N_{l}^{v_{21}}
%	+C_{l}^{\delta_{21}}+N_{l}^{\delta_{21}})+3 (B_{l}^{21-kSZ})^2}\\
%\end{aligned}
%\end{equation}

%This is in accordance with the plot as we see a low $S/N\sim 10^{-4}$.



I plot 2D signal to noise plots for the bispectrum using HIRAX noise. These are plotted for two different size redshift bins, viz. 0.4 and 0.1. Figures \ref{fig:squeezedbispecov21cmy100redshiftbin1pt061pt46comparept4binspt1bins} and \ref{fig:hiraxnoise21cmy100redshiftbin1pt061pt46comparept4binspt1bins} compare the signal or noise in the large 0.4 redshift bin to the sum of the individual contributions from each of the 4 0.1 redshift bins.
Thereafter, I compute the signal to noise using SKA noise, after showing in Figure \ref{fig:noisehiraxskadishinterferomtotalredshiftbinpt1z1pt26} a comparison of SKA and HIRAX noise. This plot is in accordance with that of Alonso.


\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/squeezedbispec_OV_21cm_y_100_redshiftbin_1pt06_1pt46_compare_pt4bins_pt1bins}
	\caption{Comparison of the signal in a 0.4 redshift bin, centred at $z=1.26$, to the sum of signals in four 0.1 redshift bins, ranging from 1.06 to 1.46, with central redshift, $z=1.11, z=1.21,z=1.31,z=1.41$.}
	\label{fig:squeezedbispecov21cmy100redshiftbin1pt061pt46comparept4binspt1bins}
\end{figure}

\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/hiraxnoise_21cm_y_100_redshiftbin_1pt06_1pt46_compare_pt4bins_pt1bins}
	\caption{Comparison of the noise in a 0.4 redshift bin, centred at $z=1.26$, to the sum of noise in four 0.1 redshift bins, ranging from 1.06 to 1.46, with central redshift, $z=1.11, z=1.21,z=1.31,z=1.41$.}
	\label{fig:hiraxnoise21cmy100redshiftbin1pt061pt46comparept4binspt1bins}
\end{figure}






\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/noise_hirax_ska_dish_interferom_total_redshiftbin_pt1_z_1pt26}
	\caption{Comparison of the HIRAX noise, SKA dish and interferometer noise, as well as the total SKA noise obtained by combining these two.}
	\label{fig:noisehiraxskadishinterferomtotalredshiftbinpt1z1pt26}
\end{figure}







\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/bispec_logscale_not_lsqBl_z_1pt26_deltaz_pt003}
	\caption{Bispectrum signal integrated over y, plotted in log scale. This shows that the signal decreases after $k_\perp=10^{-2}$.}
	\label{fig:bispeclogscalenotlsqblz1pt26deltazpt003}
\end{figure}

\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/2D_C_l_p21_with_noise_no_dz1_integral_30_pts_z_1pt26}
	\caption{The 21 cm momentum field plotted with the corresponding noise terms, integrating up to $k'=1 Mpc^{-1}$, at $z=1.26$, without integrating over the redshift bin.}
	\label{fig:2dclp21withnoisenodz1integral30ptsz1pt26}
\end{figure}


\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/Cl_p21_signal_and_noise_8terms_summed_1dplot}
	\caption{The corresponding 1D plot obtained with integrating over y. The peak in this curve corresponds to the bright line in the 2D colour plot.}
	\label{fig:clp21signalandnoise8termssummed1dplot}
\end{figure}

\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/C_l_^TT_N_l^TT_C_l_OV_deltaz_pt0015_summed}
	\caption{OV signal integrated over the bin width $\Delta_z=0.003$ is summed with the CMB spectrum, $C_l^{TT}$ and noise, $N_l^{TT}$. }
	\label{fig:clttnlttclovdeltazpt0015summed}
\end{figure}


\clearpage
\textbf{Squeezed bispectrum signal and noise without integrating over the window function, at redshift $z=1.26$ and kSZ redshift bin $\Delta_z=.00015$}

%SQUEEZED LIMIT FOR KSZ REDSHIFT BIN .003
%\begin{figure}[h!]
%	\centering
%	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/2D_bispec_squeezed_no_dz1_integral_30_pts_z_1pt26_deltaz_pt0015}
%	\caption{2D signal for squeezed bispectrum plotted for $z=1.26$, integrated up to $k'=1 Mpc^{-1}$. Then integrate the kSZ signal over the bin width $\Delta_z=0.003$ but have not integrated over the 21 cm redshift in this plot.}
%	\label{fig:2dbispecsqueezednodz1integral30ptsz1pt26deltazpt0015}
%\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/2D_bispec_squeezed_no_dz1_integral_30_pts_z_1pt26_deltaz_pt00015}
	\caption{2D signal for squeezed bispectrum plotted for $z=1.26$, integrated up to $k'=1 Mpc^{-1}$. Integrated the kSZ signal over the bin width $\Delta_z=0.0003$ but have not integrated over the 21 cm redshift in this plot.}
	\label{fig:2dbispecsqueezednodz1integral30ptsz1pt26deltazpt00015}
\end{figure}

%SQUEEZED LIMIT FOR KSZ REDSHIFT BIN .003
%\begin{figure}[h!]
%	\centering
%	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/2D_sigma_squeezedlim_z_1pt26_deltaz_pt0015_no_dz1_integral}
%	\caption{2D sigma plot for the squeezed limit. As seen, despite the peak in the $C_l^{p_{21}}$ at $k_\perp \approx 0.8$, the product of the total 21cm momentum with the total kSZ momentum causes the overall variance to be low at large $k_\perp$.}
%	\label{fig:2dsigmasqueezedlimz1pt26deltazpt0015nodz1integral}
%\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/2D_sigma_squeezedlim_z_1pt26_deltaz_pt00015_no_dz1_integral}
	\caption{2D sigma plot for the squeezed limit. As seen, despite the peak in the $C_l^{p_{21}}$ at $k_\perp \approx 0.8$, the product of the total 21cm momentum with the total kSZ signal causes the overall variance to be low at large $k_\perp$.}
	\label{fig:2dsigmasqueezedlimz1pt26deltazpt00015nodz1integral}
\end{figure}

%SQUEEZED LIMIT FOR KSZ REDSHIFT BIN .003
%\begin{figure}
%	\centering
%	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/SN_bispec_squeezed_hirax_low_kperp}
%	\caption{S/N for the squeezed limit at low $k_\perp$}
%	\label{fig:snbispecsqueezedhiraxlowkperp}
%end{figure}



%SQUEEZED LIMIT FOR KSZ REDSHIFT BIN .003
%\begin{figure}
%	\centering
%	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/SN_bispec_squeezed_hirax_high_kperp}
%	\caption{S/N for the squeezed limit at high $k_\perp$}
%	\label{fig:snbispecsqueezedhiraxhighkperp}
%\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/SN_bispec_squeezed_hirax_high_kperp_z_1pt26_delta_z_pt0015}
	\caption{S/N for the squeezed limit at high $k_\perp$}
	\label{fig:snbispecsqueezedhiraxhighkperpz1pt26deltazpt00015}
\end{figure}


\end{document}




\begin{equation}
W(\vec{k},\vec{k}',\vec{l}_2)=\frac{1}{\sigma^2(\hat{f}(\vec{k},\vec{k}',\vec{l}_2))}\left[\int \frac{d^2 l_2}{(2\pi)^2}  \int d\chi_1 \int \frac{d^3k'}{(2\pi)^3}\frac{1}{\sigma^2(\hat{f}(\vec{k},\vec{k}',\vec{l}_2))}\right]^{-1}
\end{equation}

We calculate the variance for $\hat{f} (\vec{k},\vec{k}',\vec{L})$ as follows, assuming $\epsilon(l,y)$ is centred at zero.

\begin{equation}
\begin{aligned}
\sigma^2(\hat{f} (\vec{k},\vec{k}',\vec{l}_2))%&=\left< \hat{f} (\vec{k},\vec{k}',\vec{l}_2)\hat{f}^* (\vec{k}_3,\vec{k'}_3,\vec{l}_4)\right>-\left< \hat{f} (\vec{k},\vec{k}',\vec{l}_2)\right>\left<\hat{f}^* (\vec{k}_3,\vec{k'}_3,\vec{l}_4)\right>\\
&=\left< (\hat{f} (\vec{k},\vec{k}',\vec{l}_2)-\epsilon(l,y))(\hat{f}^* (\vec{k}_3,\vec{k'}_3,\vec{l}_4)-\epsilon(l_3.y_3))\right>\\
&=\frac{\left<\hat{\delta}_{21}(\vec{k}-\vec{k}')\hat{v}_{21}(\vec{k}')\hat{p}_{kSZ}(\vec{l}_2)\hat{\delta}_{21}(\vec{k}_3-\vec{k}_3')\hat{v}_{21}(\vec{k}_3')\hat{p}_{kSZ}(\vec{l}_4)\right> }{B(l,y,\chi_1,k',k'_\parallel,\vec{l}_2)B^*(l_3,y_3,\chi_3,k'_3,k'_{3\parallel},\vec{l}_4)}
\\
&=\left[\left<\hat{\delta}_{21}(\vec{k}-\vec{k}')\hat{\delta}_{21}(\vec{k}_3-\vec{k}'_3)\right>\left<\hat{v}_{21}(\vec{k}')\hat{v}_{21}(\vec{k}'_3)\right>+\left<\hat{\delta}_{21}(\vec{k}-\vec{k}')\hat{v}_{21}(\vec{k}'_3)\right> \right.\\
&\left. \left<\hat{v}_{21}(\vec{k}')\hat{\delta}_{21}(\vec{k}_3-\vec{k}'_3)\right>\right]\left<\hat{p}_{kSZ}(\vec{l}_2)\hat{p}_{kSZ}(\vec{l}_4)\right>\times \frac{1}{B(l,y,\chi_1,k',k'_\parallel,\vec{l}_2)B^*(l_3,y_3,\chi_3,k'_3,k'_{3\parallel},\vec{l}_4)}\\
&=\delta^3(\vec{k}-\vec{k}_3)\delta^3(\vec{k}'-\vec{k}'_3)\delta^2(\vec{l}_2-\vec{l}_4)\frac{C^{p_{21},tot}(l,y,k')C_{l_2}^{p_{kSZ},tot}}{|B(l,y,\chi_1,k',k'_\parallel,\vec{l}_2)|^2}\\
\end{aligned}
\end{equation}

WHAT I HAD ORIGINALLY WRITTEN FOR THE OPTIMAL VARIANCE WEIGHTING, ACCORDING TO THE DERIVATION IN ONE OF KAVIS LENSING PAPERS-IN THE APPENDIX A

We then have 

\begin{equation}
W(\vec{k},\vec{k}',\vec{l}_2)=\frac{|B(l,y,\chi_1,k',k'_\parallel,\vec{l}_2)|^2}{C^{p_{21},tot}(l,y,k')C_{l_2}^{p_{kSZ},tot}} N(l,y)
\end{equation}

with 

\begin{equation}
N(l,y)=\left[\int \frac{d^2 l_2}{(2\pi)^2} \int d \chi_1 \int \frac{d^3k'}{(2\pi)^3}\frac{|B(l,y,\chi_1,k',k'_\parallel,\vec{l}_2)|^2}{C^{p_{21},tot}(l,y,k')C^{p_{kSZ},tot}(\vec{l}_2)}\right]^{-1}=Var[\hat{\epsilon}(l,y)]
\end{equation}



\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/squeezed_bispec_new_results_26June}
	\caption{S/N at z=1.26 with 0.1 redshift bins using HIRAX noise. We see zero signal after $\sim k_\perp=0.7$.}
	\label{fig:squeezedbispecnewresults26june}
\end{figure}

\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/squeezed_bispec_new_results_26June_cumulative}
	\caption{Cumulative S/N at z=1.26 with 0.1 redshift bins using HIRAX noise. We see zero signal after $\sim k_\perp=0.7$.}
	\label{fig:squeezedbispecnewresults26junecumulative}
\end{figure}

\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/squeezed_bispec_z_1pt26_delta_z_pt1_ska_100pts_newresults_26June}
	\caption{S/N at z=1.26 with 0.1 redshift bins using SKA noise.}
	\label{fig:squeezedbispecz1pt26deltazpt1ska100ptsnewresults26june}
\end{figure}

\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/squeezed_bispec_cumulative_z_1pt26_delta_z_pt1_ska_100pts_newresults_26June}
	\caption{Cumulative S/N at z=1.26 with 0.1 redshift bins using SKA noise.}
	\label{fig:squeezedbispeccumulativez1pt26deltazpt1ska100ptsnewresults26june}
\end{figure}


\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/squeezed_bispec_using_21cm_momentum_signal_and_noise_hirax_z_1pt26_delta_z_pt1_100pts_1}
	\caption{S/N at z=1.26 with 0.1 redshift bins using HIRAX noise. We see zero signal after $\sim k_\perp=0.7$.}
	\label{fig:squeezedbispecusing21cmmomentumsignalandnoisehiraxz1pt26deltazpt1100pts}
\end{figure}

\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/squeezed_bispec_hirax_z_1pt26_smaller_range_4June}
	\caption{}
	\label{fig:squeezedbispechiraxz1pt26smallerrange4june}
\end{figure}


\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/squeezed_bispec_cumulative_using_21cm_momentum_signal_and_noise_hirax_z_1pt26_delta_z_pt1_100pts}
	\caption{}
	\label{fig:squeezedbispeccumulativeusing21cmmomentumsignalandnoisehiraxz1pt26deltazpt1100pts}
\end{figure}


\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/squeezed_bispec_using_21cm_momentum_signal_and_noise_ska_z_1pt26_delta_z_pt1_100pts}
	\caption{S/N at z=1.26 with 0.1 redshift bins using SKA noise. }
	\label{fig:squeezedbispecusing21cmmomentumsignalandnoiseskaz1pt26deltazpt1100pts}
\end{figure}

\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/squeezed_bispec_cumulative_using_21cm_momentum_signal_and_noise_ska_z_1pt26_delta_z_pt1_100pts}
	\caption{}
	\label{fig:squeezedbispeccumulativeusing21cmmomentumsignalandnoiseskaz1pt26deltazpt1100pts}
\end{figure}

\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/squeezed_bispec_hirax_delta_z_pt1_17July}
	\caption{}
	\label{fig:squeezedbispechiraxdeltazpt117july}
\end{figure}

\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/cumulative_snr_hirax_delta_z_pt1_17July}
	\caption{}
	\label{fig:cumulativesnrhiraxdeltazpt117july}
\end{figure}

\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/squeezed_bispec_ska_delta_z_pt1_17July}
	\caption{}
	\label{fig:squeezedbispecskadeltazpt117july}
\end{figure}

\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/cumulative_snr_ska_delta_z_17July}
	\caption{}
	\label{fig:cumulativesnrskadeltaz17july}
\end{figure}








Accounting for the discrepancy between the 21 cm momentum signal and the products of the 21 cm density and velocity signals

The previous result was
\begin{equation}
(\sigma_{l}^{21-kSZ})^2=(C_{l}^{p_{kSZ}}+N_{l}^{p_{kSZ}})(C_{l}^{p_{21}}+N_{l}^{p_{21}})+3 (B_{l}^{21-kSZ})^2
\end{equation}


\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{../python_scripts/kSZ_21cm_signal/comparison_product_of_21cm_den_velo_vs_21cm_momentum}
	\caption{21 cm density times velocity vs 21 cm momentum}
	\label{fig:comparisonproductof21cmdenvelovs21cmmomentum}
\end{figure}

The reason for this discrepancy:

The product of the 21 cm density and velocity power spectra is written as

\begin{equation}
C_l^{\delta_{21}}C_l^{v_{21}}=\frac{\bar{T}^4 (b_{HI}+f\mu_k^2)^2 D^4}{c^2 \chi^4 r^2}\frac{f^2 H^2}{(1+z)^2}\frac{\mu_k^2}{k^2}P(k)^2
\end{equation}

whereas the 21 cm momentum angular power spectrum is

\begin{equation}
\begin{aligned}
C_l^{p_{21}p_{21}}(y,z_1,z_2)&=\frac{\bar{T}^4}{8\pi^2c^2}  \frac{H^2}{\chi^2r(1+z)^2}  D^4  f^2   [b_{HI}+f\mu_k^2]^4 \\
&  \int d\zeta \int dk' [\hat{\theta}.\hat{k}']^2
P_{\delta_m \delta_m}(k')P_{\delta_m \delta_m}(|k-k'|) 
\end{aligned}
\end{equation}

The lower magnitude of the $C_l^{\delta_{21}}C_l^{v_{21}}$ comes initially from the extra volume factor that we divide by. The $C_l^{\delta_{21}}C_l^{v_{21}}$ signal decreases as $k$ increases due to the $1/k^2$ factor. We do not have this factor in the $C_l^{p_{21}}$ as we take the squeezed limit which assumes $v=v(k')$ and so we have $P_{vv}(k')=P_{\delta \delta}/k'^2$ which we integrate over.







$
&=4\int \frac{d^2\vec{l}_2}{(2\pi)^2} \left<p_{kSZ}(l)p_{kSZ}(l_2)\right>\frac{1}{2c^2}\int \frac{d^2\vec{l}_2}{(2\pi)^2}\int \frac{dk_{2\parallel}}{2\pi}\int d^3\vec{k}''\hat{\theta}.\hat{k}''\\  &(\hat{\theta}.\hat{k}'' P_{\delta_{21}\delta_{21}}(\vec{k_2}-\vec{k}'')P_{v_{21}v_{21}}(\vec{k}'')+
\hat{\theta}.(\hat{k_2}-\hat{k}'')P_{\delta_{21}v_{21}}(\vec{k_2}-\vec{k}'')P_{\delta_{21}v_{21}}(\vec{k}''))\\
&+4 B_{l}^{21-kSZ} \int \frac{d^2\vec{l}_2}{(2\pi)^2}B_{l_2}^{21-kSZ}\\
&=4(C_l^{p_{kSZ}}+N_l^{p_{kSZ}})\int \frac{d^2\vec{l}_2}{(2\pi)^2}(C_{l_2}^{p_{21}}+N_{l_2}^{p_{21}})+4 B_{l}^{21-kSZ} \int \frac{d^2\vec{l}_2}{(2\pi)^2}B_{l_2}^{21-kSZ}$









\subsubsection{Cross correlation calculation}
The cross correlation angular power spectrum between 21 cm emission and KSZ effect is computed as follows
\begin{equation}
\begin{aligned}
&\langle  \delta T_{21}(\vec{l},y;z_i)p^*(\vec{l}')\rangle  =(2\pi)^2\delta^2(\vec{l}-\vec{l}')C_l^{21-p}(y;z_i)\\&
\Rightarrow C_l^{21-p}(y;z_i)=\int \frac{d^2\vec{l'}}{(2\pi)^2} \langle  \delta T_{21}(\vec{l},y;z_i) p^*(\vec{l'})\rangle  
\end{aligned}
\end{equation}
Substituting equations \ref{delta 21 ito y and l final eqn} and \ref{final p(l) eqn in terms of f} gives
\begin{equation}
\begin{aligned}
C_l^{21-p}(y;z_i)&=-\frac{T_{rad}}{c} \int \frac{d^2\vec{l'}}{(2\pi)^2}\frac{\overline{T}(z_i)D(z_i)[b_{HI}(z_i)+f(z_i)\mu_k^2]}{\chi ^2r_\nu(z_i)}\int d\chi' f_1(\chi')  \\&\int \frac{dy'}{2\pi r_\nu(\chi')} e^{-iy'\chi'/r(\chi')} \frac{\mu_k'}{k'} \langle \delta_{e}(\vec{k})\delta_{21}^*(\vec{k}')\rangle\\&
=-\frac{T_{rad}}{c} \int \frac{d^2\vec{k}'_\bot}{(2\pi)^2}\frac{\overline{T}(z_i)D(z_i)[b_{HI}(z_i)+f(z_i)\mu_k^2]}{\chi ^2r_\nu(z_i)}\int d\chi' f_2(\chi') \\
& \int \frac{dy'}{2\pi r(\chi')} e^{-iy'\chi'/r(\chi')} \frac{1}{|y^2/r^2_\nu(\chi')+\vec{k}'^2_\perp|}(2 \pi)^3 \delta^2(\vec{k}_{\bot}-\vec{k}'_\bot)\delta(y-y')P(\vec{k}_{\bot},y/r_\nu(\chi))\\&
=-\frac{T_{rad}}{c} \frac{\overline{T}(z_i)D(z_i)[b_{HI}(z_i)+f(z_i)\mu_k^2]}{\chi ^2r_\nu(z_i)}\int d\chi f_2(\chi)  |\cos({y\chi/r(\chi)})|\\ &\frac{1}{|y^2/r^2_\nu(\chi)+\vec{l}^2/\chi^2|}P(\vec{l}/\chi,y/r(\chi))
\end{aligned}
\end{equation}
where in the last line we took only the real part of the power spectrum.  
%Note that the expression for $T_{rad}$ must be in units of $\mu K$ since the expression for $\bar{T}$ in equation \ref{mean 21 cm temp} is in units of $\mu K$.
\begin{equation}
\begin{aligned}
C_l^{21-p}(y;z_i)&=\frac{T_{rad}}{c} \frac{\overline{T}(z_i)D(z_i)[b_{HI}(z_i)+f(z_i)\mu_k^2]}{\chi^2(z_i) r_\nu(z_i)}u(z_r)|\cos({y\chi/r(\chi)})|\\
&\frac{1}{|y^2/r^2_\nu(\chi_r)+\vec{l}^2/\chi_r^2|}P(\vec{l}/\chi_r,y/r(\chi_r))\\
&
\end{aligned}
\end{equation}
%\begin{figure}[h!]
% \centering
% \includegraphics[width=0.7\linewidth]{"Desktop/Cl cross corr 21 cm lksz"}
% \caption{Angular power spectrum of the cross correlation between the 21 cm signal and the linear KSZ effect is shown for $y=2$ at $z=1$ and $z=z_r$ (redshift at EoR).}
% \label{fig:cl-cross-corr-21-cm-lksz}
%\end{figure}




%21cm-Expressing as a function of frequency
We can express the angular power spectrum as a function of frequency as well using the fourier relation
\begin{equation}\label{nu fourier of l}
\delta T_{21}(\vec{l},\tilde{\nu};z_i)=\int \frac{dy}{2\pi}e^{iy\tilde{\nu}}\delta T_{21}(\vec{l},y;z_i)
\end{equation}
where $\tilde{\nu}=\frac{\nu}{1420 MHz}$ is the dimensionless frequency. Equation \ref{Cl 21 relation to autocorrelation} is expressed in terms of $\tilde{\nu}$ as
\begin{equation}\label{Cl 21 cm ito nu}
\begin{aligned}
&\langle  \delta T_{21}(\vec{l},\tilde{\nu};z_i) \delta T_{21}^*(\vec{l'},\tilde{\nu}';z_i)\rangle  =(2 \pi)^2\delta^2(\vec{l}-\vec{l'})C_l^{21}(y;z_i)
\\&
\Rightarrow C_l^{21}(\tilde{\nu},\tilde{\nu}';z_i)=\int \frac{d^2\vec{l'}}{(2\pi)^2} \langle  \delta T_{21}(\vec{l},\tilde{\nu};z_i) \delta T_{21}^*(\vec{l'},\tilde{\nu}';z_i)\rangle  
\end{aligned}
\end{equation}
This becomes
\begin{equation}
\begin{aligned}
C_l^{21}(\tilde{\nu},\tilde{\nu}';z_i)&=\int \frac{d^2\vec{l'}}{(2\pi)^2} \int \frac{dy}{2\pi}e^{iy\tilde{\nu}}\int \frac{dy'}{2\pi}e^{iy'\tilde{\nu}'}\langle  \delta T_{21}(\vec{l},y;z_i)\delta T_{21}(\vec{l'},y';z_i)\rangle  
\\&=\int \frac{d^2\vec{l'}}{(2\pi)^2} \int \frac{dy}{2\pi}e^{iy\tilde{\nu}}\int \frac{dy'}{2\pi}e^{iy'\tilde{\nu}'}(2 \pi)^3\delta_D^2(\vec{l}-\vec{l'})\delta_D(y-y')C_l^{21}(y;z_i)
\\&=\int \frac{dy}{2\pi}e^{iy(\tilde{\nu}-\tilde{\nu}')}C_l^{21}(y;z_i)
\end{aligned}
\end{equation}




Now, applying this to the $d^3k'$ integral in equation \ref{cross corr non limber} gives

\begin{equation}
\begin{aligned}
F=&\int\frac{d^3k'}{(2\pi)^3}
([\hat{\theta}.\hat{k}'][\hat{\theta}.\hat{k}']P_{\delta_{21} \delta_e}(K)P_{v_{21}v_e}(k')+[\hat{\theta}.\hat{k}'][\hat{\theta}.\hat{K}]P_{\delta_e v_{21}}(k')P_{\delta_{21} v_e}(K))\\
&=\int\frac{d^3k'}{(2\pi)^3}P_{\delta_{21} \delta_e}(k)P_{\delta_{21} \delta_e}(k')[\hat{\theta}.\hat{k}']\left[1-\frac{\zeta k'}{k}\frac{dlnP_{\delta_{21} \delta_e}(k)}{dlnk}\right] \left[ \frac{[\hat{\theta}.\hat{k}']}{k'^2} + \frac{[\hat{\theta}.\hat{K}]}{kk'} \left(1+\frac{\zeta k'}{k}\right)\right]
\end{aligned}
\end{equation}
We substitute $\hat{\theta}.\hat{k}'$ from equation \ref{k' in los}. The expression $\hat{\theta}.\hat{K}=-sin\alpha cos\phi+cos\alpha sin\phi$ can be simplified in the squeezed limit using


\begin{subequations}
	\begin{equation}
	sin\alpha=\frac{k'}{|\vec{k}-\vec{k}'|}\sqrt{1-\zeta^2}\simeq\frac{k'\sqrt{1-\zeta^2})}{k}\left(1+\frac{\zeta k'}{k}\right)
	\end{equation}
	\begin{equation}
	cos\alpha=\frac{k-k'\zeta}{|\vec{k}-\vec{k}'|}\simeq\frac{k-k'\zeta}{k}\left(1+\frac{k'\zeta}{k}\right)= 1-\left(\frac{k'\zeta}{k}\right)^2 \simeq 1
	\end{equation}
\end{subequations}
This gives the result

\begin{equation}
\hat{\theta}.\hat{K}=-\frac{k'}{k}\sqrt{1-\zeta^2}\left(1+\frac{\zeta k'}{k}\right)\frac{l}{\chi k} +\frac{k_\parallel}{k}
\end{equation}
Putting this together gives

\begin{equation}
\begin{aligned}
F=&\int\frac{d^3k'}{(2\pi)^3}P_{\delta_{21} \delta_e}(k)P_{\delta_{21} \delta_e}(k')\left[\frac{k_\parallel \zeta}{k}+\frac{l}{\chi k}\sqrt{1-\zeta^2}\right]\left[1-\frac{\zeta k'}{k}\frac{dlnP_{\delta_{21} \delta_e}(k)}{dlnk}\right]\left(-\frac{\sqrt{1-\zeta^2}}{k^2}\right.\\ &\left.-\frac{k'\zeta\sqrt{1-\zeta^2}}{k^4}\frac{l}{\chi}+\frac{k_\parallel}{k^2 k'} -\frac{k'\zeta\sqrt{1-\zeta^2}}{k^3} -\frac{k'^2 \zeta^2 \sqrt{1-\zeta^2}}{k^5}\frac{l}{\chi} +\frac{\zeta k_\parallel}{k^3} +\frac{k_\parallel \mu}{k k'^2} + \frac{l\sqrt{1-\zeta^2}}{\chi k k'^2}\right)
\end{aligned}
\end{equation}







I am plotting this in python for the non-Limber case

\begin{equation}
\begin{aligned}
C_l&=10^{12} T_{rad}^2 x^2\left(\frac{\sigma_T \rho_{g0}}{\mu_e m_p}\right)^2(1+z_i)(1+z)e^{-\tau(z_i)}e^{-\tau(z)}f(z_i)f(z)D_1(z_i)^2D_1(z)^2/\chi_i^2\\ &cos(k_\parallel(chi(z_i)-chi(z))F(\sqrt{k_\parallel^2+l^2/\chi^2} )
\end{aligned}
\end{equation}
with 

\begin{equation}
F(k)=\int \frac{dk'}{(2\pi)^3}P_{\delta \delta}(k')P_{\delta \delta}(|\vec{k}-\vec{k}'|)I(\vec{k},\vec{k}')
\end{equation}

where 
\begin{equation}
I(\vec{k},\vec{k}')=\frac{k(k-2k'\zeta)(1-\zeta^2)}{(k'^2+k^2-2kk'\zeta)}
\end{equation}


Now, the 21-cm and kSZ signals are assumed to be in different radial directions. We can again write $\vec{a}=\vec{k}'$ and $\vec{b}=\vec{k}-\vec{k}'$. Omitting all constants and $\chi$ integrals for now, we apply the line of sight directions which gives

\begin{equation}
\begin{aligned}
F(l/\chi)&=\int \frac{dk_{\parallel}}{2\pi}e^{ik_{\parallel} (\chi_i-\chi)}\int \frac{d^2k'_\perp}{(2\pi)^2}\frac{dk'_\parallel}{2\pi}
P(k')P(|\vec{k}-\vec{k}'|)\left(\frac{a_{z_i}}{a^2}+\frac{b_{z_i}}{b^2}\right)\left(\frac{a_{z}}{a^2}+\frac{b_{z}}{b^2}\right)\\
&=\int \frac{dk_{\parallel}}{2\pi}e^{ik_{\parallel} (\chi_i-\chi)}\int \frac{d^2k'_\perp}{(2\pi)^2}\frac{dk'_\parallel}{2\pi}
P(k')P(|\vec{k}-\vec{k}'|)\left(\frac{k_{z_i}'}{a^2}+\frac{k_{z_i}-k_{z_i}'}{b^2}\right)\left(\frac{k_{z}'}{a^2}-\frac{k_{z}'}{b^2}\right)\\
&=\int \frac{dk_{\parallel}}{2\pi}e^{ik_{\parallel} (\chi_i-\chi)}\int \frac{d^2k'_\perp}{(2\pi)^2}\frac{dk'_\parallel}{2\pi}
P(k')P(|\vec{k}-\vec{k}'|)\left(\frac{k_{z_i}'}{a^2}+\frac{k_{z_i}-k_{z_i}'}{b^2}\right){k'\sqrt{1-\zeta_2^2}}\left(\frac{b^2-a^2}{a^2b^2}\right)
\end{aligned}
\end{equation}
where $a_{z}=k_z'$ and $b_z=k_z-k_z'$. Note that the large redshift range for the kSZ signal allows us to use the Limber approximation, giving $b_{z}=-k_{z}'$. However, the Limber approximation cannot be applied to the small redshift range of the 21 cm signal which HIRAX will focus on. 
%\printbibliography
